# å¿«é€Ÿå¼€å§‹

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [composer.json](file://composer.json)
- [README.md](file://README.md)
- [simple.php](file://example/simple.php)
- [calculator.php](file://example/calculator.php)
- [calculator_html.php](file://example/calculator_html.php)
- [calculator.ui.html](file://example/views/calculator.ui.html)
- [login.ui.html](file://example/views/login.ui.html)
- [htmlLogin.php](file://example/htmlLogin.php)
- [HtmlRenderer.php](file://src/HtmlRenderer.php)
- [Builder.php](file://src/Builder.php)
- [helper.php](file://src/helper.php)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
3. [å®‰è£…ä¾èµ–](#å®‰è£…ä¾èµ–)
4. [å¼€å‘æ¨¡å¼æ¦‚è§ˆ](#å¼€å‘æ¨¡å¼æ¦‚è§ˆ)
5. [Builder API å¼€å‘æ¨¡å¼](#builder-api-å¼€å‘æ¨¡å¼)
6. [HTML æ¨¡æ¿å¼€å‘æ¨¡å¼](#html-æ¨¡æ¿å¼€å‘æ¨¡å¼)
7. [å¸¸è§é—®é¢˜æ’æŸ¥](#å¸¸è§é—®é¢˜æ’æŸ¥)
8. [æœ€ä½³å®è·µå»ºè®®](#æœ€ä½³å®è·µå»ºè®®)

## ç®€ä»‹

libuiBuilder æ˜¯ä¸€ä¸ªåŸºäº PHP çš„æ¡Œé¢åº”ç”¨ç¨‹åºå¼€å‘æ¡†æ¶ï¼Œæä¾›äº†ä¸¤ç§ä¸»è¦çš„å¼€å‘æ–¹å¼ï¼š**Builder API** å’Œ **HTML æ¨¡æ¿æ¸²æŸ“**ã€‚å®ƒå»ºç«‹åœ¨ kingbes/libui åº“ä¹‹ä¸Šï¼Œä¸ºå¼€å‘è€…æä¾›äº†ç›´è§‚ã€çµæ´»çš„ GUI åº”ç”¨ç¨‹åºå¼€å‘ä½“éªŒã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸ¨ **Builder æ¨¡å¼** - æµç•…çš„é“¾å¼è°ƒç”¨ API
- ğŸŒ **HTML æ¨¡æ¿æ¸²æŸ“** - ä½¿ç”¨ç†Ÿæ‚‰çš„ HTML è¯­æ³•å®šä¹‰ç•Œé¢
- ğŸ“Š **å¼ºå¤§çš„ Grid å¸ƒå±€** - ç²¾ç¡®çš„äºŒç»´å¸ƒå±€æ§åˆ¶
- ğŸ”„ **çŠ¶æ€ç®¡ç†** - å“åº”å¼æ•°æ®ç»‘å®š
- ğŸ¯ **äº‹ä»¶ç³»ç»Ÿ** - ç®€æ´çš„äº‹ä»¶å¤„ç†
- ğŸ“¦ **ç»„ä»¶å¤ç”¨** - æ¨¡æ¿ç³»ç»Ÿæ”¯æŒ
- ğŸ§ª **å®Œæ•´æµ‹è¯•** - Pest æµ‹è¯•è¦†ç›–

## ç¯å¢ƒå‡†å¤‡

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„å¼€å‘ç¯å¢ƒæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

### PHP ç‰ˆæœ¬è¦æ±‚
- **æœ€ä½ PHP ç‰ˆæœ¬**: 8.0+
- **æ¨èç‰ˆæœ¬**: 8.1+ï¼ˆè·å¾—æ›´å¥½çš„æ€§èƒ½å’Œç‰¹æ€§æ”¯æŒï¼‰

### æ‰©å±•è¦æ±‚
- **FFI æ‰©å±•**: libuiBuilder ä¾èµ– PHP FFI æ‰©å±•æ¥ä¸åŸç”Ÿ libui åº“é€šä¿¡
- **libui åº“**: è‡ªåŠ¨é€šè¿‡ composer å®‰è£…

### æ£€æŸ¥ç¯å¢ƒ

```bash
# æ£€æŸ¥ PHP ç‰ˆæœ¬
php --version

# æ£€æŸ¥ FFI æ‰©å±•æ˜¯å¦å¯ç”¨
php -m | grep ffi

# å¦‚æœ FFI æœªå¯ç”¨ï¼Œå¯ä»¥åœ¨ php.ini ä¸­æ·»åŠ ï¼š
# extension=ffi
```

## å®‰è£…ä¾èµ–

### é€šè¿‡ Composer å®‰è£…

libuiBuilder å¯ä»¥é€šè¿‡ Composer è½»æ¾å®‰è£…åˆ°æ‚¨çš„é¡¹ç›®ä¸­ï¼š

```bash
# åœ¨é¡¹ç›®ç›®å½•ä¸­æ‰§è¡Œ
composer require yangweijie/libui-builder
```

### å®‰è£…è¿‡ç¨‹è¯´æ˜

å®‰è£…å®Œæˆåï¼Œæ‚¨å°†è·å¾—ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

```mermaid
graph TB
subgraph "é¡¹ç›®ç»“æ„"
A[composer.json] --> B[vendor/]
B --> C[kingbes/libui]
B --> D[yangweijie/libui-builder]
D --> E[src/]
D --> F[example/]
D --> G[tests/]
end
subgraph "æ ¸å¿ƒæ–‡ä»¶"
E --> H[Builder.php]
E --> I[HtmlRenderer.php]
E --> J[helper.php]
E --> K[Components/]
E --> L[State/]
end
```

**å›¾è¡¨æ¥æº**
- [composer.json](file://composer.json#L1-L37)
- [Builder.php](file://src/Builder.php#L1-L50)
- [HtmlRenderer.php](file://src/HtmlRenderer.php#L1-L100)

**ç« èŠ‚æ¥æº**
- [composer.json](file://composer.json#L1-L37)
- [README.md](file://README.md#L17-L22)

## å¼€å‘æ¨¡å¼æ¦‚è§ˆ

libuiBuilder æä¾›ä¸¤ç§ä¸»è¦çš„å¼€å‘æ¨¡å¼ï¼Œæ‚¨å¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚å’Œä¸ªäººåå¥½é€‰æ‹©é€‚åˆçš„æ–¹å¼ï¼š

### å¼€å‘æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | Builder API | HTML æ¨¡æ¿ |
|------|-------------|-----------|
| **è¯­æ³•ç†Ÿæ‚‰åº¦** | PHP è¯­æ³•ï¼Œéœ€è¦å­¦ä¹  API | HTML è¯­æ³•ï¼Œç†Ÿæ‚‰ Web å¼€å‘ |
| **å¯è§†åŒ–ç¨‹åº¦** | ä»£ç ç¼–å†™ï¼Œæ— å®æ—¶é¢„è§ˆ | HTML æ–‡ä»¶ï¼Œæ”¯æŒå¯è§†åŒ–ç¼–è¾‘å™¨ |
| **åŠ¨æ€æ€§** | æ›´é€‚åˆåŠ¨æ€æ„å»ºåœºæ™¯ | æ›´é€‚åˆé™æ€ç•Œé¢è®¾è®¡ |
| **å­¦ä¹ æ›²çº¿** | ä¸­ç­‰ï¼Œéœ€è¦ç†è§£ API è®¾è®¡ | è¾ƒä½ï¼ŒHTML è¯­æ³•ç®€å•æ˜“æ‡‚ |
| **ç»´æŠ¤æ€§** | ä»£ç é›†ä¸­ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶ | ç»“æ„åˆ†ç¦»ï¼Œæ˜“äºå›¢é˜Ÿåä½œ |

### é€‰æ‹©å»ºè®®

- **æ¨èä½¿ç”¨ HTML æ¨¡æ¿æ¨¡å¼**ï¼šå¯¹äºå¤§å¤šæ•°æ¡Œé¢åº”ç”¨å¼€å‘åœºæ™¯
- **ä½¿ç”¨ Builder API**ï¼šå½“éœ€è¦åŠ¨æ€ç”Ÿæˆç•Œé¢æˆ–å¤æ‚é€»è¾‘å¤„ç†æ—¶
- **æ··åˆä½¿ç”¨**ï¼šæ ¹æ®å…·ä½“éœ€æ±‚çµæ´»ç»„åˆä¸¤ç§æ–¹å¼

## Builder API å¼€å‘æ¨¡å¼

Builder API æä¾›äº†æµç•…çš„é“¾å¼è°ƒç”¨æ¥å£ï¼Œå…è®¸æ‚¨é€šè¿‡ PHP ä»£ç ç›´æ¥æ„å»º GUI ç•Œé¢ã€‚

### åŸºç¡€çª—å£åº”ç”¨ç¤ºä¾‹

è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ç™»å½•çª—å£å¼€å§‹ï¼š

```php
<?php
use Kingbes\Libui\App;
use Kingbes\Libui\View\Builder;
use Kingbes\Libui\View\State\StateManager;

// åˆå§‹åŒ– libui åº”ç”¨
App::init();

// åˆ›å»ºçŠ¶æ€ç®¡ç†å™¨
$state = StateManager::instance();
$state->set('username', '');

// ä½¿ç”¨ Builder API æ„å»ºç•Œé¢
$app = Builder::window()
    ->title('ç™»å½•çª—å£')
    ->size(400, 300)
    ->contains([
        Builder::grid()->padded(true)->form([
            [
                'label' => Builder::label()->text('ç”¨æˆ·å:'),
                'control' => Builder::entry()
                    ->id('usernameInput')
                    ->bind('username')
                    ->placeholder('è¯·è¾“å…¥ç”¨æˆ·å')
            ]
        ])->append([
            Builder::button()
                ->text('ç™»å½•')
                ->onClick(function($button, $state) {
                    echo "ç™»å½•: " . $state->get('username') . "\n";
                })
        ])
    ]);

$app->show();
```

### æ–¹æ³•è°ƒç”¨è¯¦è§£

#### çª—å£é…ç½®æ–¹æ³•

```mermaid
classDiagram
class WindowBuilder {
+title(string) WindowBuilder
+size(int, int) WindowBuilder
+centered(bool) WindowBuilder
+margined(bool) WindowBuilder
+contains(array) WindowBuilder
+show() void
}
class GridBuilder {
+padded(bool) GridBuilder
+form(array) GridBuilder
+append(array) GridBuilder
+place(ComponentBuilder, int, int) GridItemBuilder
}
class EntryBuilder {
+id(string) EntryBuilder
+bind(string) EntryBuilder
+placeholder(string) EntryBuilder
+onChange(callable) EntryBuilder
}
WindowBuilder --> GridBuilder : contains
GridBuilder --> EntryBuilder : place
```

**å›¾è¡¨æ¥æº**
- [Builder.php](file://src/Builder.php#L56-L80)
- [simple.php](file://example/simple.php#L11-L50)

#### å…³é”®æ–¹æ³•è¯´æ˜

1. **title()** - è®¾ç½®çª—å£æ ‡é¢˜
   ```php
   $window->title('æˆ‘çš„åº”ç”¨')
   ```

2. **size()** - è®¾ç½®çª—å£å°ºå¯¸ï¼ˆå®½åº¦, é«˜åº¦ï¼‰
   ```php
   $window->size(800, 600)
   ```

3. **contains()** - è®¾ç½®çª—å£å†…å®¹ï¼ˆå­ç»„ä»¶æ•°ç»„ï¼‰
   ```php
   $window->contains([$grid, $toolbar])
   ```

4. **bind()** - ç»‘å®šçŠ¶æ€å˜é‡
   ```php
   $entry->bind('username')
   ```

5. **onClick()** - è®¾ç½®ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
   ```php
   $button->onClick(function($button, $state) {
       // å¤„ç†ç‚¹å‡»äº‹ä»¶
   })
   ```

### å®Œæ•´çš„è®¡ç®—å™¨ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„è®¡ç®—å™¨åº”ç”¨ç¤ºä¾‹ï¼š

```php
<?php
use Kingbes\Libui\App;
use Kingbes\Libui\View\Builder;
use Kingbes\Libui\View\State\StateManager;

App::init();

// åˆå§‹åŒ–çŠ¶æ€
$stateManager = StateManager::instance();
$stateManager->set('display', '0');
$stateManager->set('previousValue', null);
$stateManager->set('operation', null);

// åˆ›å»ºæŒ‰é’®ç½‘æ ¼
$buttonGrid = Builder::grid()->padded(true);
$buttons = [
    ['C', 0, 0, 'clear'],
    ['CE', 0, 1, 'clearEntry'],
    ['âŒ«', 0, 2, 'backspace'],
    ['Ã·', 0, 3, 'divide'],
    // ... æ›´å¤šæŒ‰é’®
];

// æ·»åŠ æŒ‰é’®åˆ°ç½‘æ ¼
foreach ($buttons as $buttonInfo) {
    $text = $buttonInfo[0];
    $row = $buttonInfo[1];
    $col = $buttonInfo[2];
    $id = $buttonInfo[3];
    
    $button = Builder::button()
        ->id($id)
        ->text($text);
    
    // æ·»åŠ äº‹ä»¶å¤„ç†å™¨
    switch ($id) {
        case 'clear':
            $button->onClick(function($button) use ($stateManager) {
                $stateManager->update([
                    'display' => '0',
                    'previousValue' => null,
                    'operation' => null
                ]);
            });
            break;
        // ... å…¶ä»–äº‹ä»¶å¤„ç†
    }
    
    $buttonGrid->place($button, $row, $col);
}

// åˆ›å»ºä¸»çª—å£
$app = Builder::window()
    ->title('è®¡ç®—å™¨')
    ->size(300, 400)
    ->contains([
        Builder::vbox()->padded(true)->contains([
            // æ˜¾ç¤ºå±
            $displayGrid,
            Builder::separator(),
            // æŒ‰é’®åŒºåŸŸ
            $buttonGrid
        ])
    ]);

$app->show();
```

**ç« èŠ‚æ¥æº**
- [simple.php](file://example/simple.php#L1-L142)
- [calculator.php](file://example/calculator.php#L1-L238)

## HTML æ¨¡æ¿å¼€å‘æ¨¡å¼

HTML æ¨¡æ¿æ¨¡å¼æ˜¯ libuiBuilder æ¨èçš„ä¸»è¦å¼€å‘æ–¹å¼ï¼Œå®ƒä½¿ç”¨ç†Ÿæ‚‰çš„ HTML è¯­æ³•æ¥å®šä¹‰ç•Œé¢ï¼Œæä¾›äº†æ›´å¥½çš„å¯è§†åŒ–å’Œç»´æŠ¤æ€§ã€‚

### åŸºç¡€ HTML æ¨¡æ¿ç»“æ„

HTML æ¨¡æ¿å¿…é¡»ä½¿ç”¨ç‰¹æ®Šçš„ `ui` æ ‡ç­¾ç»“æ„ï¼š

```html
<!DOCTYPE html>
<ui version="1.0">
  <window title="æˆ‘çš„åº”ç”¨" size="800,600" centered="true">
    <grid padded="true">
      <!-- ç•Œé¢å…ƒç´  -->
    </grid>
  </window>
</ui>
```

### ç™»å½•è¡¨å•æ¨¡æ¿ç¤ºä¾‹

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ç™»å½•è¡¨å• HTML æ¨¡æ¿ï¼š

```html
<!DOCTYPE html>
<ui version="1.0">
  <window title="ç™»å½•çª—å£" size="400,300" centered="true" margined="true">
    <grid padded="true">
      
      <!-- ç”¨æˆ·åè¡Œ -->
      <label row="0" col="0" align="end,center">ç”¨æˆ·å:</label>
      <input 
        id="usernameInput"
        row="0" 
        col="1" 
        bind="username"
        placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
        expand="horizontal"
        onchange="handleUsernameChange"
      />
      
      <!-- å¯†ç è¡Œ -->
      <label row="1" col="0" align="end,center">å¯†ç :</label>
      <input 
        id="passwordInput"
        row="1" 
        col="1" 
        type="password"
        bind="password"
        placeholder="è¯·è¾“å…¥å¯†ç "
        expand="horizontal"
        onchange="handlePasswordChange"
      />
      
      <!-- æŒ‰é’®è¡Œ -->
      <hbox row="2" col="0" colspan="2" align="center">
        <button id="loginBtn" onclick="handleLogin">ç™»å½•</button>
        <button onclick="handleReset">æ¸…ç©º</button>
      </hbox>
      
      <!-- çŠ¶æ€æ ‡ç­¾ -->
      <label 
        id="statusLabel" 
        row="3" 
        col="0" 
        colspan="2" 
        align="center"
      >è¯·è¾“å…¥ç™»å½•ä¿¡æ¯</label>
      
    </grid>
  </window>
</ui>
```

### æ¨¡æ¿è¯­æ³•è¯¦è§£

#### å¸ƒå±€å±æ€§

| å±æ€§ | æè¿° | ç¤ºä¾‹ |
|------|------|------|
| `row` | è¡Œä½ç½® | `row="0"` |
| `col` | åˆ—ä½ç½® | `col="1"` |
| `rowspan` | è·¨è¶Šè¡Œæ•° | `rowspan="2"` |
| `colspan` | è·¨è¶Šåˆ—æ•° | `colspan="3"` |
| `align` | å¯¹é½æ–¹å¼ | `align="center"` |
| `expand` | æ‰©å±•å±æ€§ | `expand="horizontal"` |

#### æ•°æ®ç»‘å®š

```html
<!-- ç»‘å®šçŠ¶æ€å˜é‡ -->
<input bind="username" />

<!-- åŒå‘æ•°æ®ç»‘å®š -->
<label>{{username}}</label>
```

#### äº‹ä»¶å¤„ç†

```html
<!-- ç‚¹å‡»äº‹ä»¶ -->
<button onclick="handleClick">ç‚¹å‡»</button>

<!-- è¾“å…¥å˜åŒ–äº‹ä»¶ -->
<input onchange="handleChange" />

<!-- é€‰æ‹©å˜åŒ–äº‹ä»¶ -->
<select onselected="handleSelect">
  <option>é€‰é¡¹1</option>
  <option>é€‰é¡¹2</option>
</select>
```

### PHP äº‹ä»¶å¤„ç†å™¨

åˆ›å»ºå¯¹åº”çš„ PHP å¤„ç†å™¨æ–‡ä»¶ï¼š

```php
<?php
use Kingbes\Libui\App;
use Kingbes\Libui\View\HtmlRenderer;
use Kingbes\Libui\View\State\StateManager;

App::init();

// åˆå§‹åŒ–çŠ¶æ€
$state = StateManager::instance();
$state->set('username', '');
$state->set('password', '');

// å®šä¹‰äº‹ä»¶å¤„ç†å™¨
$handlers = [
    'handleUsernameChange' => function($value, $component) {
        echo "ç”¨æˆ·åè¾“å…¥: {$value}\n";
        
        // è®¿é—®å…¶ä»–ç»„ä»¶
        $loginBtn = StateManager::instance()->getComponent('loginBtn');
        $passwordInput = StateManager::instance()->getComponent('passwordInput');
        
        // æ ¹æ®è¾“å…¥å¯ç”¨/ç¦ç”¨ç™»å½•æŒ‰é’®
        $canLogin = !empty($value) && !empty($passwordInput?->getValue());
        echo "å¯ä»¥ç™»å½•: " . ($canLogin ? 'æ˜¯' : 'å¦') . "\n";
    },
    
    'handlePasswordChange' => function($value, $component) {
        // è®¡ç®—å¯†ç å¼ºåº¦
        $strength = strlen($value) > 8 ? 'å¼º' : 'å¼±';
        
        $statusLabel = StateManager::instance()->getComponent('statusLabel');
        if ($statusLabel) {
            $statusLabel->setValue("å¯†ç å¼ºåº¦: {$strength}");
        }
    },
    
    'handleLogin' => function($button, $stateManager) {
        $username = $stateManager->get('username');
        $password = $stateManager->get('password');
        
        if (empty($username) || empty($password)) {
            echo "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º\n";
            return;
        }
        
        // æ¨¡æ‹Ÿç™»å½•éªŒè¯
        if ($username === 'admin' && $password === 'admin') {
            echo "ç™»å½•æˆåŠŸï¼\n";
            
            $statusLabel = StateManager::instance()->getComponent('statusLabel');
            if ($statusLabel) {
                $statusLabel->setValue("ç™»å½•æˆåŠŸï¼");
            }
        } else {
            echo "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯\n";
            
            $statusLabel = StateManager::instance()->getComponent('statusLabel');
            if ($statusLabel) {
                $statusLabel->setValue("ç™»å½•å¤±è´¥ï¼šç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
            }
        }
    },
    
    'handleReset' => function($button, $stateManager) {
        // æ¸…ç©ºæ‰€æœ‰è¾“å…¥
        $stateManager->update([
            'username' => '',
            'password' => ''
        ]);
        
        echo "è¡¨å•å·²æ¸…ç©º\n";
    }
];

// ä» HTML æ¸²æŸ“
$app = HtmlRenderer::render(__DIR__ . '/views/login.ui.html', $handlers);
$app->show();
```

### HTML æ¸²æŸ“æµç¨‹

```mermaid
sequenceDiagram
participant PHP as PHP è„šæœ¬
participant Renderer as HtmlRenderer
participant DOM as DOM è§£æå™¨
participant Builder as ç»„ä»¶æ„å»ºå™¨
participant App as libui åº”ç”¨
PHP->>Renderer : render(template.html, handlers)
Renderer->>DOM : åŠ è½½å¹¶è§£æ HTML
DOM->>Renderer : è¿”å› DOM æ ‘
Renderer->>Renderer : æå–æ¨¡æ¿å®šä¹‰
Renderer->>Renderer : æŸ¥æ‰¾æ ¹å…ƒç´ 
Renderer->>Builder : é€’å½’æ¸²æŸ“ç»„ä»¶
Builder->>App : åˆ›å»º libui ç»„ä»¶
App->>PHP : æ˜¾ç¤ºåº”ç”¨ç•Œé¢
```

**å›¾è¡¨æ¥æº**
- [HtmlRenderer.php](file://src/HtmlRenderer.php#L57-L77)
- [htmlLogin.php](file://example/htmlLogin.php#L93-L96)

**ç« èŠ‚æ¥æº**
- [login.ui.html](file://example/views/login.ui.html#L1-L49)
- [htmlLogin.php](file://example/htmlLogin.php#L1-L96)
- [calculator.ui.html](file://example/views/calculator.ui.html#L1-L54)

## å¸¸è§é—®é¢˜æ’æŸ¥

åœ¨ä½¿ç”¨ libuiBuilder è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸€äº›å¸¸è§çš„åˆå§‹åŒ–å’Œè¿è¡Œæ—¶é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„æ’æŸ¥æŒ‡å—ï¼š

### åˆå§‹åŒ–é”™è¯¯

#### 1. FFI æ‰©å±•æœªå¯ç”¨

**é”™è¯¯ç—‡çŠ¶**ï¼š
```
Fatal error: Uncaught Error: Call to undefined function FFI\cdef()
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ FFI æ˜¯å¦å¯ç”¨
php -m | grep ffi

# å¯ç”¨ FFI æ‰©å±•ï¼ˆLinux/MacOSï¼‰
echo "extension=ffi" >> ~/.phprc

# Windows ç”¨æˆ·ä¿®æ”¹ php.ini
# åœ¨ php.ini ä¸­æ·»åŠ : extension=ffi
```

#### 2. libui åº“åŠ è½½å¤±è´¥

**é”™è¯¯ç—‡çŠ¶**ï¼š
```
Error: Failed to load libui library
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ç¡®ä¿ composer å·²æ­£ç¡®å®‰è£…ä¾èµ–
composer install

# æ£€æŸ¥ vendor ç›®å½•æ˜¯å¦å­˜åœ¨
ls vendor/kingbes/libui
```

### HTML æ¨¡æ¿ç›¸å…³é—®é¢˜

#### 1. æ¨¡æ¿æ–‡ä»¶æ‰¾ä¸åˆ°

**é”™è¯¯ç—‡çŠ¶**ï¼š
```
Exception: HTML template file not found: views/template.ui.html
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```php
// ç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®
$app = HtmlRenderer::render(__DIR__ . '/views/template.ui.html', $handlers);

// æˆ–ä½¿ç”¨ç»å¯¹è·¯å¾„
$app = HtmlRenderer::render('/full/path/to/views/template.ui.html', $handlers);
```

#### 2. æ ¹å…ƒç´ ç¼ºå¤±

**é”™è¯¯ç—‡çŠ¶**ï¼š
```
Exception: HTML template must contain a root element (window, vbox, hbox, grid, or tab)
```

**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿ HTML æ¨¡æ¿åŒ…å«æ ¹å…ƒç´ ï¼š
```html
<ui version="1.0">
  <window title="åº”ç”¨" size="800,600">
    <!-- å†…å®¹ -->
  </window>
</ui>
```

### çŠ¶æ€ç®¡ç†å’Œæ•°æ®ç»‘å®šé—®é¢˜

#### 1. ç»‘å®šçŠ¶æ€æœªåˆå§‹åŒ–

**é”™è¯¯ç—‡çŠ¶**ï¼š
```
Warning: Undefined index: username in StateManager
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```php
// åœ¨ä½¿ç”¨å‰åˆå§‹åŒ–çŠ¶æ€
$state = StateManager::instance();
$state->set('username', '');
$state->set('password', '');
```

#### 2. ç»„ä»¶ ID ä¸å­˜åœ¨

**é”™è¯¯ç—‡çŠ¶**ï¼š
```
Warning: Attempt to get component that does not exist: usernameInput
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```php
// ç¡®ä¿ HTML ä¸­å®šä¹‰äº†æ­£ç¡®çš„ ID
<input id="usernameInput" bind="username" />

// æˆ–åœ¨ PHP ä¸­æ£€æŸ¥ç»„ä»¶æ˜¯å¦å­˜åœ¨
$usernameInput = StateManager::instance()->getComponent('usernameInput');
if ($usernameInput) {
    // å®‰å…¨ä½¿ç”¨ç»„ä»¶
}
```

### äº‹ä»¶å¤„ç†é—®é¢˜

#### 1. äº‹ä»¶å¤„ç†å™¨æœªæ‰¾åˆ°

**é”™è¯¯ç—‡çŠ¶**ï¼š
```
Exception: Handler not found: handleClick
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```php
// ç¡®ä¿äº‹ä»¶å¤„ç†å™¨å·²æ­£ç¡®å®šä¹‰
$handlers = [
    'handleClick' => function($button, $state) {
        // å¤„ç†é€»è¾‘
    }
];

// ç¡®ä¿ HTML ä¸­ä½¿ç”¨äº†æ­£ç¡®çš„äº‹ä»¶åç§°
<button onclick="handleClick">ç‚¹å‡»</button>
```

#### 2. äº‹ä»¶å‚æ•°ç±»å‹é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```php
// æ£€æŸ¥äº‹ä»¶å¤„ç†å™¨ç­¾å
'handleClick' => function($button, $state) {
    // $button æ˜¯ç»„ä»¶å¯¹è±¡
    // $state æ˜¯çŠ¶æ€ç®¡ç†å™¨
}

'handleChange' => function($value, $component) {
    // $value æ˜¯æ–°å€¼
    // $component æ˜¯è§¦å‘äº‹ä»¶çš„ç»„ä»¶
}
```

### è°ƒè¯•æŠ€å·§

#### 1. å¯ç”¨è¯¦ç»†é”™è¯¯æŠ¥å‘Š

```php
// åœ¨å¼€å‘ç¯å¢ƒä¸­å¯ç”¨é”™è¯¯æŠ¥å‘Š
error_reporting(E_ALL);
ini_set('display_errors', 1);

// åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®°å½•é”™è¯¯
ini_set('log_errors', 1);
ini_set('error_log', __DIR__ . '/error.log');
```

#### 2. ä½¿ç”¨çŠ¶æ€ç›‘æ§

```php
// ç›‘å¬çŠ¶æ€å˜åŒ–
$state = StateManager::instance();
$state->watch('username', function($newValue, $oldValue) {
    echo "ç”¨æˆ·åä» '{$oldValue}' å˜æ›´ä¸º '{$newValue}'\n";
});

// æ‰“å°å½“å‰çŠ¶æ€
print_r($state->getAll());
```

#### 3. ç»„ä»¶è°ƒè¯•

```php
// è·å–æ‰€æœ‰ç»„ä»¶
$components = StateManager::instance()->getAllComponents();
foreach ($components as $id => $component) {
    echo "ç»„ä»¶ ID: {$id}, ç±»å‹: " . get_class($component) . "\n";
}
```

**ç« èŠ‚æ¥æº**
- [HtmlRenderer.php](file://src/HtmlRenderer.php#L80-L108)
- [htmlLogin.php](file://example/htmlLogin.php#L11-L15)

## æœ€ä½³å®è·µå»ºè®®

### é¡¹ç›®ç»“æ„ç»„ç»‡

æ¨èçš„é¡¹ç›®ç»“æ„ï¼š

```
project/
â”œâ”€â”€ views/              # HTML æ¨¡æ¿æ–‡ä»¶
â”‚   â”œâ”€â”€ login.ui.html
â”‚   â”œâ”€â”€ dashboard.ui.html
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ header.ui.html
â”‚       â””â”€â”€ footer.ui.html
â”œâ”€â”€ handlers/           # äº‹ä»¶å¤„ç†å™¨
â”‚   â”œâ”€â”€ LoginHandlers.php
â”‚   â”œâ”€â”€ DashboardHandlers.php
â”‚   â””â”€â”€ BaseHandlers.php
â”œâ”€â”€ state/              # çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ AppState.php
â”‚   â””â”€â”€ UserState.php
â”œâ”€â”€ assets/             # é™æ€èµ„æº
â”‚   â”œâ”€â”€ styles/
â”‚   â””â”€â”€ images/
â””â”€â”€ app.php             # ä¸»å…¥å£æ–‡ä»¶
```

### ä»£ç ç»„ç»‡å»ºè®®

#### 1. åˆ†ç¦»å…³æ³¨ç‚¹

```php
// app.php - ä¸»å…¥å£
<?php
require_once __DIR__ . '/vendor/autoload.php';

use Kingbes\Libui\App;
use Kingbes\Libui\View\HtmlRenderer;
use Handlers\LoginHandlers;

App::init();

$handlers = LoginHandlers::getHandlers();
$app = HtmlRenderer::render(__DIR__ . '/views/login.ui.html', $handlers);
$app->show();
```

#### 2. ä½¿ç”¨å‘½åç©ºé—´

```php
// handlers/LoginHandlers.php
<?php
namespace Handlers;

class LoginHandlers {
    public static function getHandlers(): array {
        return [
            'handleLogin' => [self::class, 'login'],
            'handleReset' => [self::class, 'reset'],
        ];
    }
    
    public static function login($button, $state) {
        // ç™»å½•é€»è¾‘
    }
    
    public static function reset($button, $state) {
        // é‡ç½®é€»è¾‘
    }
}
```

#### 3. çŠ¶æ€ç®¡ç†å°è£…

```php
// state/AppState.php
<?php
namespace State;

use Kingbes\Libui\View\State\StateManager;

class AppState {
    private static $instance;
    
    private function __construct() {}
    
    public static function getInstance(): StateManager {
        if (!self::$instance) {
            self::$instance = StateManager::instance();
            self::initializeDefaults();
        }
        return self::$instance;
    }
    
    private static function initializeDefaults() {
        $state = self::$instance;
        $state->set('theme', 'light');
        $state->set('language', 'zh-CN');
    }
}
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 1. å»¶è¿ŸåŠ è½½

```php
// å¯¹äºå¤§å‹åº”ç”¨ï¼Œè€ƒè™‘å»¶è¿ŸåŠ è½½éå…³é”®ç»„ä»¶
$largeGrid = Builder::grid()->padded(true);
// åªåœ¨éœ€è¦æ—¶æ·»åŠ å¤§é‡å­ç»„ä»¶
```

#### 2. çŠ¶æ€æ›´æ–°ä¼˜åŒ–

```php
// ä½¿ç”¨æ‰¹é‡æ›´æ–°å‡å°‘ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
$state->update([
    'field1' => 'value1',
    'field2' => 'value2',
    'field3' => 'value3',
]);
```

#### 3. äº‹ä»¶å¤„ç†ä¼˜åŒ–

```php
// é¿å…åœ¨é«˜é¢‘äº‹ä»¶ä¸­è¿›è¡Œå¤æ‚è®¡ç®—
'onchange' => function($value, $component) {
    // ç®€å•çš„çŠ¶æ€æ›´æ–°
    StateManager::instance()->set('searchQuery', $value);
},
```

### å®‰å…¨æ€§è€ƒè™‘

#### 1. è¾“å…¥éªŒè¯

```php
// åœ¨äº‹ä»¶å¤„ç†å™¨ä¸­éªŒè¯è¾“å…¥
'handleLogin' => function($button, $state) {
    $username = trim($state->get('username'));
    $password = trim($state->get('password'));
    
    if (strlen($username) < 3 || strlen($username) > 50) {
        echo "ç”¨æˆ·åé•¿åº¦åº”åœ¨3-50å­—ç¬¦ä¹‹é—´\n";
        return;
    }
    
    // è¿›ä¸€æ­¥éªŒè¯...
}
```

#### 2. æ•æ„Ÿæ•°æ®å¤„ç†

```php
// ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•æ•æ„Ÿä¿¡æ¯
'handleLogin' => function($button, $state) {
    $username = $state->get('username');
    // é¿å…è®°å½•å¯†ç 
    // echo "ç”¨æˆ·å°è¯•ç™»å½•: {$username}"; // OK
    // echo "ç”¨æˆ·ç™»å½•: {$username}, å¯†ç : {$password}"; // é”™è¯¯
}
```

### æµ‹è¯•ç­–ç•¥

#### 1. å•å…ƒæµ‹è¯•

```php
// ä½¿ç”¨ Pest è¿›è¡Œå•å…ƒæµ‹è¯•
test('login handler validates credentials', function () {
    $state = StateManager::instance();
    $state->set('username', 'admin');
    $state->set('password', 'correct-password');
    
    $result = LoginHandlers::login(null, $state);
    
    expect($result)->toBeTrue();
});
```

#### 2. é›†æˆæµ‹è¯•

```php
// æµ‹è¯•å®Œæ•´çš„ HTML æ¸²æŸ“æµç¨‹
test('html renderer creates valid ui tree', function () {
    $handlers = LoginHandlers::getHandlers();
    $app = HtmlRenderer::render(__DIR__ . '/views/login.ui.html', $handlers);
    
    expect($app)->not->toBeNull();
    expect($app->getComponent())->toBeInstanceOf(WindowBuilder::class);
});
```

é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œæ‚¨å¯ä»¥æ„å»ºå‡ºé«˜è´¨é‡ã€å¯ç»´æŠ¤çš„ libuiBuilder åº”ç”¨ç¨‹åºã€‚è®°ä½ï¼Œè‰¯å¥½çš„é¡¹ç›®ç»“æ„å’Œæ¸…æ™°çš„ä»£ç ç»„ç»‡æ˜¯é•¿æœŸæˆåŠŸçš„å…³é”®ã€‚