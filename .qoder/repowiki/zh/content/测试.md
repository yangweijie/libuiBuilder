# 测试

<cite>
**本文档中引用的文件**   
- [BasicTest.php](file://tests/BasicTest.php)
- [StateManagerBasicTest.php](file://tests/StateManagerBasicTest.php)
- [HtmlRendererBasicTest.php](file://tests/HtmlRendererBasicTest.php)
- [StateHelperTest.php](file://tests/StateHelperTest.php)
- [BuilderComponentsTest.php](file://tests/BuilderComponentsTest.php)
- [HelperFunctionsTest.php](file://tests/HelperFunctionsTest.php)
- [ComponentRefTest.php](file://tests/ComponentRefTest.php)
- [Pest.php](file://tests/Pest.php)
- [pest.php](file://pest.php)
- [run_tests.sh](file://run_tests.sh)
- [composer.json](file://composer.json)
- [coverage-report/](file://coverage-report/)
</cite>

## 目录
1. [测试框架介绍](#测试框架介绍)
2. [运行测试套件](#运行测试套件)
3. [核心测试文件分析](#核心测试文件分析)
4. [编写单元测试指南](#编写单元测试指南)
5. [代码覆盖率与测试报告](#代码覆盖率与测试报告)
6. [测试驱动开发实践](#测试驱动开发实践)

## 测试框架介绍

本项目采用Pest作为主要的PHP测试框架。Pest是一个现代化、简洁且易于使用的测试框架，专为PHP开发者设计，提供了优雅的语法和强大的功能来验证代码的正确性。

Pest框架的主要优势包括：
- **简洁的语法**：使用`test()`、`expect()`等函数提供直观的测试表达
- **内置断言**：丰富的断言方法如`toBeTrue()`、`toContain()`、`toBeInstanceOf()`等
- **描述性测试**：支持`describe()`和`it()`结构，使测试意图更加清晰
- **自动加载**：与Composer集成，自动处理类的加载
- **高性能**：轻量级设计，测试运行速度快

项目通过`composer.json`文件中的`require-dev`部分引入Pest依赖，确保测试工具仅在开发环境中安装。

**Section sources**
- [composer.json](file://composer.json#L27-L29)
- [Pest.php](file://tests/Pest.php#L1-L10)

## 运行测试套件

项目提供了多种方式来运行测试套件，既可以通过交互式脚本也可以直接调用Pest命令。

### 使用交互式测试脚本

项目根目录下的`run_tests.sh`脚本提供了一个用户友好的菜单界面，允许开发者选择不同的测试运行模式：

```bash
./run_tests.sh
```

该脚本提供的选项包括：
- 运行基础测试（Basic, StateManager, HtmlRenderer）
- 运行完整测试套件
- 只运行特定模块的测试
- 显示测试覆盖率
- 生成HTML覆盖率报告
- 列出所有测试用例

### 直接调用Pest

开发者也可以直接使用Pest命令行工具来运行测试：

```bash
# 运行所有测试
./vendor/bin/pest

# 运行特定测试文件
./vendor/bin/pest tests/BasicTest.php
./vendor/bin/pest tests/StateManagerBasicTest.php

# 生成覆盖率报告
./vendor/bin/pest --coverage

# 生成HTML格式的覆盖率报告
./vendor/bin/pest --coverage --coverage-html=coverage-report
```

`pest.php`配置文件定义了测试环境的基本设置，包括测试和源代码的路径。

**Section sources**
- [run_tests.sh](file://run_tests.sh#L1-L106)
- [pest.php](file://pest.php#L1-L8)

## 核心测试文件分析

### BasicTest.php

`BasicTest.php`是项目中最基础的测试文件，主要用于验证Pest框架的基本功能和简单的断言操作。该测试文件包含了对布尔值、数组和字符串的基本测试用例。

这些测试用例验证了：
- 基本的`toBeTrue()`断言
- 数组的`toHaveCount()`和`toContain()`断言
- 字符串的`toBe()`和`toContain()`断言

**Section sources**
- [BasicTest.php](file://tests/BasicTest.php#L1-L17)

### StateManagerBasicTest.php

`StateManagerBasicTest.php`专注于验证状态管理器（StateManager）的核心功能。该测试文件通过多个测试用例确保状态管理器的单例模式、基础操作和监听器功能正常工作。

关键测试覆盖点包括：
- **单例模式验证**：确保`StateManager::instance()`始终返回相同的实例
- **基础状态操作**：测试`set()`、`get()`方法以及默认值处理
- **批量状态更新**：验证`update()`方法能够正确处理数组参数
- **状态监听器**：测试`watch()`方法能否正确触发回调函数并传递新旧值

测试中使用了反射机制来重置单例实例，确保每个测试用例的独立性。

**Section sources**
- [StateManagerBasicTest.php](file://tests/StateManagerBasicTest.php#L1-L60)

### HtmlRendererBasicTest.php

`HtmlRendererBasicTest.php`测试HTML渲染器的功能，确保UI组件能够正确解析和渲染HTML模板。该测试文件特别关注中文支持和事件绑定等实际应用场景。

主要测试内容包括：
- **基础渲染功能**：验证HTML文件能够被正确解析并返回对象
- **中文支持**：测试包含中文字符的窗口标题和标签能否正确显示
- **事件绑定系统**：验证`onclick`等事件处理器能否正确注册
- **模板变量替换**：测试`{{variable}}`语法的变量替换功能
- **错误处理机制**：验证当模板文件不存在时能否抛出适当的异常

测试中使用了临时目录来存储测试用的HTML文件，并在测试结束后自动清理。

**Section sources**
- [HtmlRendererBasicTest.php](file://tests/HtmlRendererBasicTest.php#L1-L108)

### StateHelperTest.php

`StateHelperTest.php`全面测试状态管理相关的辅助函数，特别是`state()`和`watch()`函数。该测试文件使用`describe()`和`it()`结构组织测试，使测试意图更加清晰。

测试覆盖的主要场景包括：
- **state()函数**：测试无参数调用、单个状态设置/获取、批量设置、嵌套数组处理等
- **watch()函数**：验证监听器能否正确响应状态变化，包括多次变化和多个监听器的情况
- **集成测试**：模拟响应式计数器、表单验证和状态同步等实际应用场景

**Section sources**
- [StateHelperTest.php](file://tests/StateHelperTest.php#L1-L182)

## 编写单元测试指南

### 测试结构最佳实践

当为新组件或功能编写单元测试时，应遵循以下最佳实践：

1. **使用适当的测试组织结构**：
   - 对于简单测试使用`test()`函数
   - 对于相关测试组使用`describe()`块
   - 对于具体场景使用`it()`函数

2. **确保测试独立性**：
   - 使用`beforeEach()`和`afterEach()`钩子设置和清理测试环境
   - 避免测试之间的状态依赖

3. **编写清晰的测试描述**：
   - 使用描述性的测试名称
   - 确保测试意图一目了然

### 使用Mock对象

在需要隔离外部依赖的测试中，可以创建Mock对象。如`ComponentRefTest.php`中所示，通过继承`ComponentBuilder`创建`MockComponentBuilder`类来模拟组件行为。

```php
class MockComponentBuilder extends ComponentBuilder
{
    private $value = 'default';
    
    // 实现必要的方法
}
```

### 断言策略

使用Pest提供的丰富断言方法来验证各种条件：

- `expect($value)->toBeTrue()` - 验证布尔值
- `expect($array)->toHaveCount(3)` - 验证数组长度
- `expect($string)->toContain('text')` - 验证字符串包含
- `expect($object)->toBeInstanceOf(Class::class)` - 验证对象类型
- `expect(fn() => method())->toThrow(Exception::class)` - 验证异常抛出

**Section sources**
- [ComponentRefTest.php](file://tests/ComponentRefTest.php#L1-L156)
- [HelperFunctionsTest.php](file://tests/HelperFunctionsTest.php#L1-L198)
- [BuilderComponentsTest.php](file://tests/BuilderComponentsTest.php#L1-L189)

## 代码覆盖率与测试报告

### 覆盖率重要性

高代码覆盖率是确保代码质量的重要指标。它帮助开发者识别未被测试覆盖的代码路径，减少潜在的bug。本项目通过Pest的覆盖率功能来监控测试完整性。

### 查看覆盖率报告

项目提供了多种方式来查看测试覆盖率：

1. **控制台输出**：
```bash
./vendor/bin/pest --coverage
```

2. **HTML报告**：
```bash
./vendor/bin/pest --coverage --coverage-html=coverage-report
```
生成的报告位于`coverage-report/`目录，可通过浏览器打开`dashboard.html`查看详细信息。

3. **交互式脚本**：
使用`./run_tests.sh`脚本选择"生成HTML覆盖率报告"选项。

覆盖率报告按目录结构组织，包括：
- Builder组件的覆盖率
- State管理模块的覆盖率
- Templates模板系统的覆盖率
- Validation验证模块的覆盖率

**Section sources**
- [coverage-report/](file://coverage-report/#L1-L10)
- [run_tests.sh](file://run_tests.sh#L48-L54)

## 测试驱动开发实践

### TDD在项目中的应用

本项目鼓励采用测试驱动开发（TDD）方法，其典型工作流程如下：

1. **先写测试**：为新功能编写失败的测试用例
2. **实现功能**：编写最简单的代码使测试通过
3. **重构优化**：在保持测试通过的前提下优化代码结构

### 实际应用示例

以添加新UI组件为例的TDD流程：

1. 创建新的测试文件`NewComponentTest.php`
2. 编写测试用例验证组件的基本功能
3. 运行测试，确认其失败
4. 实现组件类和方法
5. 运行测试，确认其通过
6. 添加更多边界条件测试
7. 重构代码并确保所有测试仍然通过

### 持续集成

建议将测试作为开发流程的一部分：
- 在提交代码前运行完整测试套件
- 使用覆盖率报告识别需要补充测试的代码
- 定期审查测试用例的有效性

**Section sources**
- [tests/](file://tests/#L1-L10)
- [run_tests.sh](file://run_tests.sh#L36-L40)