<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>libuiBuilder å¯è§†åŒ–é¢„è§ˆå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 20px;
            background: #1a252f;
            border-bottom: 1px solid #34495e;
        }

        .sidebar-header h1 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #95a5a6;
        }

        .file-input-wrapper {
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }

        .file-input-wrapper label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: #ecf0f1;
        }

        .file-input-wrapper input[type="file"] {
            width: 100%;
            padding: 8px;
            background: #34495e;
            border: 1px solid #4a5f7f;
            border-radius: 4px;
            color: white;
            font-size: 12px;
        }

        .state-panel {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .state-section {
            margin-bottom: 20px;
        }

        .state-section h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #3498db;
            border-bottom: 1px solid #34495e;
            padding-bottom: 5px;
        }

        .state-item {
            background: #34495e;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .state-item code {
            color: #f39c12;
        }

        .state-item .binding {
            color: #2ecc71;
            display: block;
            margin-top: 5px;
        }

        /* ä¸»é¢„è§ˆåŒº */
        .preview-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbar {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar button {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .toolbar button:hover {
            background: #2980b9;
        }

        .toolbar button.secondary {
            background: #95a5a6;
        }

        .toolbar button.secondary:hover {
            background: #7f8c8d;
        }

        .scale-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scale-controls span {
            font-size: 13px;
            color: #7f8c8d;
        }

        .preview-wrapper {
            flex: 1;
            overflow: auto;
            background: #ecf0f1;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .preview-content {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transform-origin: top center;
            transition: transform 0.2s;
        }

        /* libuiBuilder ç»„ä»¶æ ·å¼ */
        .ui-window {
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .ui-window-titlebar {
            background: linear-gradient(to bottom, #ecf0f1, #bdc3c7);
            padding: 10px 15px;
            border-bottom: 1px solid #95a5a6;
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }

        .ui-window-content {
            padding: 10px;
        }

        /* Grid å¸ƒå±€ */
        .ui-grid {
            display: grid;
            width: 100%;
        }

        .ui-grid.padded {
            gap: 5px;
        }

        /* Box å¸ƒå±€ */
        .ui-vbox {
            display: flex;
            flex-direction: column;
        }

        .ui-hbox {
            display: flex;
            flex-direction: row;
        }

        .ui-vbox.padded > *,
        .ui-hbox.padded > * {
            margin: 5px;
        }

        /* åŸºç¡€ç»„ä»¶ */
        .ui-label {
            padding: 5px;
            font-size: 13px;
            display: flex;
            align-items: center;
        }

        .ui-input {
            padding: 6px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
            min-width: 150px;
        }

        .ui-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .ui-input[readonly] {
            background: #ecf0f1;
        }

        .ui-button {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
            min-width: 50px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ui-button:hover {
            background: #2980b9;
        }

        .ui-button:active {
            background: #21618c;
        }

        .ui-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px;
        }

        .ui-checkbox input {
            cursor: pointer;
        }

        .ui-radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 5px;
        }

        .ui-radio {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .ui-separator-horizontal {
            height: 1px;
            background: #bdc3c7;
            margin: 10px 0;
        }

        .ui-separator-vertical {
            width: 1px;
            background: #bdc3c7;
            margin: 0 10px;
        }

        .ui-combobox,
        .ui-spinbox,
        .ui-slider {
            padding: 6px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 13px;
            min-width: 150px;
        }

        .ui-progressbar {
            height: 20px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .ui-progressbar-fill {
            height: 100%;
            background: linear-gradient(to right, #3498db, #2ecc71);
            transition: width 0.3s;
        }

        .ui-textarea {
            padding: 6px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            min-width: 200px;
        }

        /* è¡¨æ ¼ç»„ä»¶ */
        .ui-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            overflow: hidden;
        }

        .ui-table thead {
            background: linear-gradient(to bottom, #ecf0f1, #d5dbdb);
        }

        .ui-table th {
            padding: 10px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #2c3e50;
            border-bottom: 2px solid #bdc3c7;
        }

        .ui-table td {
            padding: 8px 15px;
            font-size: 13px;
            border-bottom: 1px solid #ecf0f1;
        }

        .ui-table tbody tr:hover {
            background: #f8f9fa;
        }

        .ui-table tbody tr:last-child td {
            border-bottom: none;
        }

        .ui-table-empty {
            padding: 40px;
            text-align: center;
            color: #95a5a6;
            font-style: italic;
        }

        /* çŠ¶æ€ç»‘å®šæŒ‡ç¤ºå™¨ */
        .binding-indicator {
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background: #2ecc71;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: help;
        }

        .component-wrapper {
            position: relative;
        }

        /* å¯¹é½æ–¹å¼ */
        .align-fill { justify-self: stretch; align-self: stretch; }
        .align-start { justify-self: start; align-self: start; }
        .align-center { justify-self: center; align-self: center; }
        .align-end { justify-self: end; align-self: end; }
        
        .align-h-fill { justify-self: stretch; }
        .align-h-start { justify-self: start; }
        .align-h-center { justify-self: center; }
        .align-h-end { justify-self: end; }
        
        .align-v-fill { align-self: stretch; }
        .align-v-start { align-self: start; }
        .align-v-center { align-self: center; }
        .align-v-end { align-self: end; }

        /* æ‰©å±•æ§åˆ¶ */
        .expand-horizontal {
            width: 100%;
            min-width: 0;
        }

        .expand-vertical {
            height: 100%;
            min-height: 0;
        }

        .expand-both {
            width: 100%;
            height: 100%;
            min-width: 0;
            min-height: 0;
        }

        /* é”™è¯¯æç¤º */
        .error-message {
            background: #e74c3c;
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 4px;
        }

        .info-message {
            background: #3498db;
            color: white;
            padding: 40px;
            text-align: center;
            border-radius: 4px;
            margin: 20px;
        }

        .info-message h2 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>ğŸ¨ UI Preview</h1>
            <p>libuiBuilder å¯è§†åŒ–é¢„è§ˆå·¥å…·</p>
        </div>

        <div class="file-input-wrapper">
            <label for="fileInput">é€‰æ‹© .ui.html æ–‡ä»¶:</label>
            <input type="file" id="fileInput" accept=".html,.ui.html">
        </div>

        <div class="state-panel">
            <div class="state-section">
                <h3>ğŸ“Š çŠ¶æ€ç»‘å®š</h3>
                <div id="stateBindings"></div>
            </div>

            <div class="state-section">
                <h3>ğŸ¯ äº‹ä»¶å¤„ç†å™¨</h3>
                <div id="eventHandlers"></div>
            </div>

            <div class="state-section">
                <h3>ğŸ“ å¸ƒå±€ä¿¡æ¯</h3>
                <div id="layoutInfo"></div>
            </div>
        </div>
    </div>

    <!-- ä¸»é¢„è§ˆåŒº -->
    <div class="preview-container">
        <div class="toolbar">
            <div class="toolbar-left">
                <button id="reloadBtn">ğŸ”„ é‡æ–°åŠ è½½</button>
                <button id="toggleGridBtn" class="secondary">ğŸ“ æ˜¾ç¤ºç½‘æ ¼</button>
            </div>
            <div class="scale-controls">
                <span>ç¼©æ”¾:</span>
                <button onclick="setScale(0.75)">75%</button>
                <button onclick="setScale(1.0)" class="secondary">100%</button>
                <button onclick="setScale(1.25)">125%</button>
                <button onclick="setScale(1.5)">150%</button>
            </div>
        </div>

        <div class="preview-wrapper">
            <div class="preview-content" id="previewContent">
                <div class="info-message">
                    <h2>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ liuiBuilder é¢„è§ˆå·¥å…·</h2>
                    <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ª .ui.html æ–‡ä»¶å¼€å§‹é¢„è§ˆ</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== æ ¸å¿ƒçŠ¶æ€ ====================
        let currentFile = null;
        let currentScale = 1.0;
        let showGrid = false;
        let stateBindings = new Map();
        let eventHandlers = new Map();

        // ==================== DOM è§£æå™¨ ====================
        class UIParser {
            constructor(htmlContent) {
                const parser = new DOMParser();
                this.doc = parser.parseFromString(htmlContent, 'text/html');
            }

            parse() {
                const root = this.doc.querySelector('window');
                if (!root) {
                    throw new Error('æœªæ‰¾åˆ° <window> æ ¹å…ƒç´ ');
                }
                
                stateBindings.clear();
                eventHandlers.clear();
                
                return this.renderElement(root);
            }

            renderElement(element) {
                const tagName = element.tagName.toLowerCase();
                
                // æ˜ å°„æ ‡ç­¾åˆ°æ¸²æŸ“æ–¹æ³•
                const renderers = {
                    'window': () => this.renderWindow(element),
                    'grid': () => this.renderGrid(element),
                    'vbox': () => this.renderVBox(element),
                    'hbox': () => this.renderHBox(element),
                    'label': () => this.renderLabel(element),
                    'input': () => this.renderInput(element),
                    'button': () => this.renderButton(element),
                    'checkbox': () => this.renderCheckbox(element),
                    'radio': () => this.renderRadio(element),
                    'separator': () => this.renderSeparator(element),
                    'hr': () => this.renderSeparator(element),
                    'combobox': () => this.renderCombobox(element),
                    'select': () => this.renderCombobox(element),
                    'spinbox': () => this.renderSpinbox(element),
                    'slider': () => this.renderSlider(element),
                    'progressbar': () => this.renderProgressBar(element),
                    'progress': () => this.renderProgressBar(element),
                    'textarea': () => this.renderTextarea(element),
                    'table': () => this.renderTable(element),
                };

                const renderer = renderers[tagName];
                if (!renderer) {
                    console.warn(`æœªçŸ¥æ ‡ç­¾: ${tagName}`);
                    return document.createElement('div');
                }

                return renderer();
            }

            renderWindow(element) {
                const window = document.createElement('div');
                window.className = 'ui-window';

                const title = element.getAttribute('title') || 'Window';
                const size = element.getAttribute('size');
                
                if (size) {
                    const [width, height] = size.split(',').map(s => parseInt(s.trim()));
                    window.style.width = `${width}px`;
                    window.style.height = `${height}px`;
                }

                // æ ‡é¢˜æ 
                const titlebar = document.createElement('div');
                titlebar.className = 'ui-window-titlebar';
                titlebar.textContent = title;
                window.appendChild(titlebar);

                // å†…å®¹åŒº
                const content = document.createElement('div');
                content.className = 'ui-window-content';
                
                const margined = element.getAttribute('margined') === 'true';
                if (margined) {
                    content.style.padding = '15px';
                }

                // æ¸²æŸ“å­å…ƒç´ 
                for (const child of element.children) {
                    content.appendChild(this.renderElement(child));
                }

                window.appendChild(content);
                return window;
            }

            renderGrid(element) {
                const grid = document.createElement('div');
                grid.className = 'ui-grid';

                const padded = element.getAttribute('padded') === 'true';
                if (padded) {
                    grid.classList.add('padded');
                }

                // è®¡ç®—ç½‘æ ¼å¤§å° - ä¿®å¤ï¼šç¡®ä¿è‡³å°‘æœ‰ 1 è¡Œ 1 åˆ—
                let maxRow = 1;
                let maxCol = 1;

                // å…ˆæ”¶é›†æ‰€æœ‰å­å…ƒç´ çš„ä½ç½®ä¿¡æ¯
                const children = Array.from(element.children);
                for (const child of children) {
                    const row = parseInt(child.getAttribute('row') || '0');
                    const col = parseInt(child.getAttribute('col') || '0');
                    const rowspan = parseInt(child.getAttribute('rowspan') || '1');
                    const colspan = parseInt(child.getAttribute('colspan') || '1');

                    maxRow = Math.max(maxRow, row + rowspan);
                    maxCol = Math.max(maxCol, col + colspan);
                }

                // è®¾ç½® CSS Grid - ä½¿ç”¨ 1fr ä½¿åˆ—å®½å‡ç­‰
                grid.style.gridTemplateRows = `repeat(${maxRow}, auto)`;
                grid.style.gridTemplateColumns = `repeat(${maxCol}, 1fr)`;

                // æ¸²æŸ“å­å…ƒç´ 
                for (const child of children) {
                    const item = this.renderElement(child);
                    
                    // Grid å®šä½
                    const row = parseInt(child.getAttribute('row') || '0');
                    const col = parseInt(child.getAttribute('col') || '0');
                    const rowspan = parseInt(child.getAttribute('rowspan') || '1');
                    const colspan = parseInt(child.getAttribute('colspan') || '1');

                    item.style.gridRowStart = row + 1;
                    item.style.gridRowEnd = row + rowspan + 1;
                    item.style.gridColumnStart = col + 1;
                    item.style.gridColumnEnd = col + colspan + 1;

                    // å¯¹é½æ–¹å¼
                    const align = child.getAttribute('align');
                    if (align) {
                        this.applyAlignment(item, align);
                    }

                    // æ‰©å±•å±æ€§
                    const expand = child.getAttribute('expand');
                    if (expand) {
                        this.applyExpand(item, expand);
                    }

                    grid.appendChild(item);
                }

                return grid;
            }

            renderVBox(element) {
                const vbox = document.createElement('div');
                vbox.className = 'ui-vbox';

                if (element.getAttribute('padded') === 'true') {
                    vbox.classList.add('padded');
                }

                for (const child of element.children) {
                    vbox.appendChild(this.renderElement(child));
                }

                return vbox;
            }

            renderHBox(element) {
                const hbox = document.createElement('div');
                hbox.className = 'ui-hbox';

                if (element.getAttribute('padded') === 'true') {
                    hbox.classList.add('padded');
                }

                for (const child of element.children) {
                    hbox.appendChild(this.renderElement(child));
                }

                return hbox;
            }

            renderLabel(element) {
                const label = document.createElement('div');
                label.className = 'ui-label';
                label.textContent = element.textContent.trim();
                return label;
            }

            renderInput(element) {
                const wrapper = document.createElement('div');
                wrapper.className = 'component-wrapper';

                const type = element.getAttribute('type');
                
                let input;
                if (type === 'multiline') {
                    input = document.createElement('textarea');
                    input.className = 'ui-textarea';
                } else {
                    input = document.createElement('input');
                    input.className = 'ui-input';
                    input.type = type === 'password' ? 'password' : 'text';
                }

                const id = element.getAttribute('id');
                if (id) {
                    input.id = id;
                }

                const placeholder = element.getAttribute('placeholder');
                if (placeholder) {
                    input.placeholder = placeholder;
                }

                const readonly = element.getAttribute('readonly') === 'true';
                if (readonly) {
                    input.readOnly = true;
                }

                const value = element.getAttribute('text') || element.getAttribute('value');
                if (value) {
                    input.value = value;
                }

                // çŠ¶æ€ç»‘å®š
                const bind = element.getAttribute('bind');
                if (bind) {
                    stateBindings.set(id || bind, bind);
                    const indicator = document.createElement('div');
                    indicator.className = 'binding-indicator';
                    indicator.title = `ç»‘å®šåˆ°: ${bind}`;
                    wrapper.appendChild(indicator);
                }

                // äº‹ä»¶å¤„ç†
                const events = ['onclick', 'onchange', 'onfocus', 'onblur'];
                for (const eventName of events) {
                    const handler = element.getAttribute(eventName);
                    if (handler) {
                        const key = `${id || 'unknown'}.${eventName}`;
                        eventHandlers.set(key, handler);
                    }
                }

                wrapper.appendChild(input);
                return wrapper;
            }

            renderButton(element) {
                const button = document.createElement('button');
                button.className = 'ui-button';
                button.textContent = element.textContent.trim();

                const id = element.getAttribute('id');
                if (id) {
                    button.id = id;
                }

                const onclick = element.getAttribute('onclick');
                if (onclick) {
                    eventHandlers.set(id || 'button', onclick);
                }

                return button;
            }

            renderCheckbox(element) {
                const checkbox = document.createElement('label');
                checkbox.className = 'ui-checkbox';

                const input = document.createElement('input');
                input.type = 'checkbox';
                
                const checked = element.getAttribute('checked') === 'true';
                input.checked = checked;

                const span = document.createElement('span');
                span.textContent = element.textContent.trim();

                checkbox.appendChild(input);
                checkbox.appendChild(span);

                return checkbox;
            }

            renderRadio(element) {
                const radioGroup = document.createElement('div');
                radioGroup.className = 'ui-radio-group';

                const name = element.getAttribute('id') || 'radio-' + Date.now();

                for (const option of element.children) {
                    if (option.tagName.toLowerCase() === 'option') {
                        const radio = document.createElement('label');
                        radio.className = 'ui-radio';

                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = name;

                        const span = document.createElement('span');
                        span.textContent = option.textContent.trim();

                        radio.appendChild(input);
                        radio.appendChild(span);
                        radioGroup.appendChild(radio);
                    }
                }

                return radioGroup;
            }

            renderSeparator(element) {
                const orientation = element.getAttribute('orientation') || 'horizontal';
                const separator = document.createElement('div');
                separator.className = orientation === 'vertical' 
                    ? 'ui-separator-vertical' 
                    : 'ui-separator-horizontal';
                return separator;
            }

            renderCombobox(element) {
                const select = document.createElement('select');
                select.className = 'ui-combobox';

                const id = element.getAttribute('id');
                if (id) {
                    select.id = id;
                }

                for (const option of element.children) {
                    if (option.tagName.toLowerCase() === 'option') {
                        const opt = document.createElement('option');
                        opt.value = option.getAttribute('value') || option.textContent.trim();
                        opt.textContent = option.textContent.trim();
                        select.appendChild(opt);
                    }
                }

                const selected = element.getAttribute('selected');
                if (selected) {
                    select.selectedIndex = parseInt(selected);
                }

                return select;
            }

            renderSpinbox(element) {
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'ui-spinbox';

                const min = element.getAttribute('min');
                const max = element.getAttribute('max');
                const value = element.getAttribute('value');

                if (min) input.min = min;
                if (max) input.max = max;
                if (value) input.value = value;

                return input;
            }

            renderSlider(element) {
                const input = document.createElement('input');
                input.type = 'range';
                input.className = 'ui-slider';

                const min = element.getAttribute('min') || '0';
                const max = element.getAttribute('max') || '100';
                const value = element.getAttribute('value') || '50';

                input.min = min;
                input.max = max;
                input.value = value;

                return input;
            }

            renderProgressBar(element) {
                const container = document.createElement('div');
                container.className = 'ui-progressbar';

                const fill = document.createElement('div');
                fill.className = 'ui-progressbar-fill';

                const value = parseInt(element.getAttribute('value') || '0');
                const max = parseInt(element.getAttribute('max') || '100');
                const percentage = (value / max) * 100;

                fill.style.width = `${percentage}%`;
                container.appendChild(fill);

                return container;
            }

            renderTextarea(element) {
                const textarea = document.createElement('textarea');
                textarea.className = 'ui-textarea';
                textarea.textContent = element.textContent.trim();

                const placeholder = element.getAttribute('placeholder');
                if (placeholder) {
                    textarea.placeholder = placeholder;
                }

                return textarea;
            }

            renderTable(element) {
                const table = document.createElement('table');
                table.className = 'ui-table';

                const id = element.getAttribute('id');
                if (id) {
                    table.id = id;
                }

                // çŠ¶æ€ç»‘å®š
                const bind = element.getAttribute('bind');
                if (bind) {
                    stateBindings.set(id || 'table', bind);
                }

                // æ¸²æŸ“ thead
                const thead = element.querySelector('thead');
                if (thead) {
                    const newThead = document.createElement('thead');
                    const headerRow = thead.querySelector('tr');
                    
                    if (headerRow) {
                        const newHeaderRow = document.createElement('tr');
                        const headers = headerRow.querySelectorAll('th');
                        
                        headers.forEach(th => {
                            const newTh = document.createElement('th');
                            newTh.textContent = th.textContent.trim();
                            newHeaderRow.appendChild(newTh);
                        });
                        
                        newThead.appendChild(newHeaderRow);
                    }
                    
                    table.appendChild(newThead);
                }

                // æ¸²æŸ“ tbody
                const tbody = element.querySelector('tbody');
                const newTbody = document.createElement('tbody');
                
                // å¦‚æœ tbody ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤º
                if (!tbody || tbody.children.length === 0) {
                    const emptyRow = document.createElement('tr');
                    const emptyCell = document.createElement('td');
                    emptyCell.className = 'ui-table-empty';
                    
                    // è®¡ç®—åˆ—æ•°
                    const colCount = thead ? thead.querySelectorAll('th').length : 1;
                    emptyCell.colSpan = colCount;
                    emptyCell.textContent = bind 
                        ? `ç»‘å®šåˆ°: ${bind} (é¢„è§ˆæ¨¡å¼ä¸‹æ— æ•°æ®)` 
                        : 'æ— æ•°æ®';
                    
                    emptyRow.appendChild(emptyCell);
                    newTbody.appendChild(emptyRow);
                } else {
                    // æ¸²æŸ“ç°æœ‰æ•°æ®è¡Œ
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(tr => {
                        const newRow = document.createElement('tr');
                        const cells = tr.querySelectorAll('td');
                        
                        cells.forEach(td => {
                            const newCell = document.createElement('td');
                            newCell.textContent = td.textContent.trim();
                            newRow.appendChild(newCell);
                        });
                        
                        newTbody.appendChild(newRow);
                    });
                }
                
                table.appendChild(newTbody);
                return table;
            }

            applyAlignment(element, align) {
                const parts = align.split(',').map(s => s.trim());
                
                if (parts.length === 1) {
                    element.classList.add(`align-${parts[0]}`);
                } else if (parts.length === 2) {
                    element.classList.add(`align-h-${parts[0]}`);
                    element.classList.add(`align-v-${parts[1]}`);
                }
            }

            applyExpand(element, expand) {
                if (expand === 'true') {
                    element.classList.add('expand-both');
                } else if (expand === 'horizontal') {
                    element.classList.add('expand-horizontal');
                } else if (expand === 'vertical') {
                    element.classList.add('expand-vertical');
                }
            }
        }

        // ==================== æ–‡ä»¶åŠ è½½ ====================
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            currentFile = file;
            await loadFile(file);
        });

        async function loadFile(file) {
            try {
                const content = await file.text();
                const parser = new UIParser(content);
                const rendered = parser.parse();

                const preview = document.getElementById('previewContent');
                preview.innerHTML = '';
                preview.appendChild(rendered);

                updateSidebar();
            } catch (error) {
                showError(error.message);
            }
        }

        // ==================== ä¾§è¾¹æ æ›´æ–° ====================
        function updateSidebar() {
            // çŠ¶æ€ç»‘å®š
            const stateDiv = document.getElementById('stateBindings');
            stateDiv.innerHTML = '';
            
            if (stateBindings.size === 0) {
                stateDiv.innerHTML = '<div class="state-item">æ— çŠ¶æ€ç»‘å®š</div>';
            } else {
                for (const [id, state] of stateBindings) {
                    const item = document.createElement('div');
                    item.className = 'state-item';
                    item.innerHTML = `
                        <code>${id}</code>
                        <span class="binding">â†’ ${state}</span>
                    `;
                    stateDiv.appendChild(item);
                }
            }

            // äº‹ä»¶å¤„ç†å™¨
            const eventDiv = document.getElementById('eventHandlers');
            eventDiv.innerHTML = '';
            
            if (eventHandlers.size === 0) {
                eventDiv.innerHTML = '<div class="state-item">æ— äº‹ä»¶å¤„ç†å™¨</div>';
            } else {
                for (const [key, handler] of eventHandlers) {
                    const item = document.createElement('div');
                    item.className = 'state-item';
                    item.innerHTML = `<code>${key}</code> â†’ ${handler}`;
                    eventDiv.appendChild(item);
                }
            }

            // å¸ƒå±€ä¿¡æ¯
            const layoutDiv = document.getElementById('layoutInfo');
            const gridCount = document.querySelectorAll('.ui-grid').length;
            const vboxCount = document.querySelectorAll('.ui-vbox').length;
            const hboxCount = document.querySelectorAll('.ui-hbox').length;
            const tableCount = document.querySelectorAll('.ui-table').length;

            layoutDiv.innerHTML = `
                <div class="state-item">Grid å®¹å™¨: ${gridCount}</div>
                <div class="state-item">VBox å®¹å™¨: ${vboxCount}</div>
                <div class="state-item">HBox å®¹å™¨: ${hboxCount}</div>
                <div class="state-item">Table ç»„ä»¶: ${tableCount}</div>
            `;
        }

        // ==================== ç¼©æ”¾æ§åˆ¶ ====================
        function setScale(scale) {
            currentScale = scale;
            document.getElementById('previewContent').style.transform = `scale(${scale})`;
        }

        // ==================== ç½‘æ ¼æ˜¾ç¤º ====================
        document.getElementById('toggleGridBtn').addEventListener('click', () => {
            showGrid = !showGrid;
            const grids = document.querySelectorAll('.ui-grid');
            
            grids.forEach(grid => {
                if (showGrid) {
                    grid.style.border = '1px dashed #3498db';
                    grid.style.background = 'rgba(52, 152, 219, 0.05)';
                } else {
                    grid.style.border = '';
                    grid.style.background = '';
                }
            });

            document.getElementById('toggleGridBtn').textContent = 
                showGrid ? 'ğŸ“ éšè—ç½‘æ ¼' : 'ğŸ“ æ˜¾ç¤ºç½‘æ ¼';
        });

        // ==================== é‡æ–°åŠ è½½ ====================
        document.getElementById('reloadBtn').addEventListener('click', () => {
            if (currentFile) {
                loadFile(currentFile);
            }
        });

        // ==================== é”™è¯¯æ˜¾ç¤º ====================
        function showError(message) {
            const preview = document.getElementById('previewContent');
            preview.innerHTML = `
                <div class="error-message">
                    <h3>âŒ è§£æé”™è¯¯</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // ==================== æ‹–æ‹½æ”¯æŒ ====================
        const previewWrapper = document.querySelector('.preview-wrapper');
        
        previewWrapper.addEventListener('dragover', (e) => {
            e.preventDefault();
            previewWrapper.style.background = '#d5dbdb';
        });

        previewWrapper.addEventListener('dragleave', () => {
            previewWrapper.style.background = '#ecf0f1';
        });

        previewWrapper.addEventListener('drop', async (e) => {
            e.preventDefault();
            previewWrapper.style.background = '#ecf0f1';

            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.html') || file.name.endsWith('.ui.html'))) {
                currentFile = file;
                await loadFile(file);
            }
        });
    </script>
</body>
</html>
