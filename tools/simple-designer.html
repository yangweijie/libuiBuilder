<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>libuiBuilder 简化设计器</title>
    
    <!-- 复用现有样式 -->
    <link rel="stylesheet" href="libui-ng-complete.css">
    <link rel="stylesheet" href="designer.css">
    
    <style>
        /* 简化设计器样式 */
        .simple-designer {
            height: calc(100vh - 60px);
            display: flex;
        }
        
        /* 统一组件面板中所有组件卡片的宽度 */
        .components-panel .component-item {
            width: 100% !important;
            text-align: center !important;
            cursor: grab !important;
            padding: 8px !important;
            border: 1px solid #e9ecef !important;
            border-radius: 4px !important;
            background: white !important;
            transition: all 0.2s !important;
        }
        
        /* 确保输入控件的预览内容宽度一致 */
        .components-panel .component-preview input,
        .components-panel .component-preview select,
        .components-panel .component-preview textarea {
            max-width: 80px !important;
            width: 80px !important;
            box-sizing: border-box !important;
        }
        
        /* 特殊处理spinbox和slider的宽度 */
        .components-panel .ui-spinbox,
        .components-panel .ui-slider {
            max-width: 80px !important;
            width: 80px !important;
            box-sizing: border-box !important;
        }
        
        .components-panel .ui-spinbox input,
        .components-panel .ui-slider input {
            max-width: 60px !important;
            width: 60px !important;
        }
        
        .designer-canvas {
            flex: 1;
            background: #fafafa;
            position: relative;
            overflow: auto;
        }
        
        .designer-properties {
            width: 300px;
            background: white;
            border-left: 1px solid #dee2e6;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* 组件元素 */
        .component-element {
            position: absolute;
            cursor: move;
            border: 1px solid transparent;
            transition: border-color 0.2s;
        }
        
        .component-element:hover {
            border-color: #0078d4;
        }
        
        .component-element.selected {
            border-color: #0078d4;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }
        
        .component-element.drag-target {
            border-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.3);
        }
        
        
        
        .component-controls {
            position: absolute;
            top: -30px;
            right: 0;
            display: none;
            gap: 4px;
        }
        
        .component-element.selected .component-controls {
            display: flex;
        }
        
        .control-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: #0078d4;
            color: white;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            position: relative;
            z-index: 1001;
        }
        
        .control-btn:hover {
            background: #005a9e;
        }
        
        .control-btn.delete {
            background: #dc3545;
        }
        
        .control-btn.delete:hover {
            background: #c82333;
        }
        
        /* 代码预览 */
        .code-preview {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            transition: transform 0.3s ease;
            border-top: 1px solid #333;
        }
        
        .code-preview.collapsed {
            height: 40px; /* 只显示标题栏高度 */
        }
        
        .code-preview.collapsed .preview-content {
            display: none; /* 隐藏内容区域 */
        }
        
        .code-preview.collapsed .toggle-code-btn {
            display: inline-block; /* 显示展开按钮 */
        }
        
        .code-preview:not(.collapsed) .toggle-code-btn {
            display: none; /* 隐藏展开按钮 */
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            cursor: pointer;
        }
        
        .preview-header h4 {
            margin: 0;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }
        
        .preview-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #0078d4;
            background: #0078d4;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-small:hover {
            background: #005a9e;
        }
        
        .preview-content {
            padding: 16px;
            height: calc(100% - 40px);
            overflow-y: auto;
        }
        
        .preview-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #d4d4d4;
        }
        
        .preview-content code {
            font-family: 'Monaco', 'Menlo', 'Consolas', 'Courier New', monospace;
        }
        
        /* 浮动按钮 */
        .floating-btn {
            position: fixed;
            bottom: 220px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: #0078d4;
            color: white;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 999;
        }
        
        .floating-btn:hover {
            background: #005a9e;
        }
        
        .property-group {
            margin-bottom: 20px;
        }
        
        .property-group h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #495057;
        }
        
        .property-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .property-label {
            width: 100px;
            font-size: 13px;
            color: #6c757d;
        }
        
        .property-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .property-input:focus {
            outline: none;
            border-color: #0078d4;
        }
        
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body class="windows">
    <!-- 顶部工具栏 -->
    <header class="designer-header">
        <div class="header-left">
            <h1 class="app-title">libuiBuilder 简化设计器</h1>
            <div class="platform-selector">
                <button class="platform-btn active" data-platform="windows">Windows</button>
                <button class="platform-btn" data-platform="macos">macOS</button>
                <button class="platform-btn" data-platform="linux">Linux</button>
            </div>
        </div>
        <div class="header-right">
            <button class="btn btn-primary" id="saveBtn">保存</button>
            <button class="btn btn-secondary" id="exportBtn">导出 HTML</button>
            <button class="btn btn-secondary" id="previewBtn">预览</button>
            <button class="btn btn-secondary" id="clearBtn">清空</button>
        </div>
    </header>

    <!-- 主设计区域 -->
    <main class="simple-designer">
        <!-- 左侧组件面板 -->
        <aside class="components-panel">
            <div class="panel-header">
                <h3>组件库</h3>
            </div>
            <div class="panel-content">
                <!-- 容器组件 -->
                <div class="component-category">
                    <h4>容器组件</h4>
                    <div class="component-list">
                        <div class="component-item" draggable="true" data-component="window">
                            <div class="component-preview window-preview">
                                <span>窗口</span>
                            </div>
                            <span class="component-name">Window</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="grid">
                            <div class="component-preview grid-preview">
                                <span>网格</span>
                            </div>
                            <span class="component-name">Grid</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="hbox">
                            <div class="component-preview hbox-preview">
                                <span>水平盒子</span>
                            </div>
                            <span class="component-name">HBox</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="vbox">
                            <div class="component-preview vbox-preview">
                                <span>垂直盒子</span>
                            </div>
                            <span class="component-name">VBox</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="form">
                            <div class="component-preview form-preview">
                                <span>表单</span>
                            </div>
                            <span class="component-name">Form</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="tab">
                            <div class="component-preview tab-preview">
                                <span>标签页</span>
                            </div>
                            <span class="component-name">Tab</span>
                        </div>
                    </div>
                </div>

                <!-- 输入控件 -->
                <div class="component-category">
                    <h4>输入控件</h4>
                    <div class="component-list">
                        <div class="component-item" draggable="true" data-component="input">
                            <div class="component-preview input-preview">
                                <input type="text" placeholder="输入框" readonly>
                            </div>
                            <span class="component-name">Input</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="textarea">
                            <div class="component-preview textarea-preview">
                                <textarea placeholder="多行输入" readonly></textarea>
                            </div>
                            <span class="component-name">Textarea</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="password">
                            <div class="component-preview password-preview">
                                <input type="password" placeholder="密码" readonly>
                            </div>
                            <span class="component-name">Password</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="combobox">
                            <div class="component-preview combobox-preview">
                                <select>
                                    <option>下拉框</option>
                                </select>
                            </div>
                            <span class="component-name">Combobox</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="spinbox">
                            <div class="component-preview spinbox-preview">
                                <div class="ui-spinbox">
                                    <input type="number" value="0" readonly>
                                    <button disabled>-</button>
                                    <button disabled>+</button>
                                </div>
                            </div>
                            <span class="component-name">Spinbox</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="slider">
                            <div class="component-preview slider-preview">
                                <div class="ui-slider">
                                    <input type="range" value="50" readonly>
                                    <span>50</span>
                                </div>
                            </div>
                            <span class="component-name">Slider</span>
                        </div>
                    </div>
                </div>

                <!-- 按钮控件 -->
                <div class="component-category">
                    <h4>按钮控件</h4>
                    <div class="component-list">
                        <div class="component-item" draggable="true" data-component="button">
                            <div class="component-preview button-preview">
                                <button>按钮</button>
                            </div>
                            <span class="component-name">Button</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="checkbox">
                            <div class="component-preview checkbox-preview">
                                <label class="ui-checkbox">
                                    <input type="checkbox" disabled>
                                    <span>复选框</span>
                                </label>
                            </div>
                            <span class="component-name">Checkbox</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="radio">
                            <div class="component-preview radio-preview">
                                <div class="ui-radio-buttons">
                                    <label>
                                        <input type="radio" name="preview" disabled>
                                        <span>单选框</span>
                                    </label>
                                </div>
                            </div>
                            <span class="component-name">Radio</span>
                        </div>
                    </div>
                </div>

                <!-- 显示控件 -->
                <div class="component-category">
                    <h4>显示控件</h4>
                    <div class="component-list">
                        <div class="component-item" draggable="true" data-component="label">
                            <div class="component-preview label-preview">
                                <span>标签文本</span>
                            </div>
                            <span class="component-name">Label</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="progressbar">
                            <div class="component-preview progressbar-preview">
                                <div class="ui-progress-bar">
                                    <div class="fill" style="width: 60%;"></div>
                                </div>
                            </div>
                            <span class="component-name">ProgressBar</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="separator">
                            <div class="component-preview separator-preview">
                                <hr class="ui-separator horizontal">
                            </div>
                            <span class="component-name">Separator</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="table">
                            <div class="component-preview table-preview">
                                <table class="mini-table">
                                    <tr>
                                        <th>列1</th>
                                        <th>列2</th>
                                    </tr>
                                    <tr>
                                        <td>数据1</td>
                                        <td>数据2</td>
                                    </tr>
                                </table>
                            </div>
                            <span class="component-name">Table</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 设计画布 -->
        <div class="designer-canvas" id="designCanvas">
            <div class="empty-state" id="emptyState">
                拖拽组件到这里开始设计
            </div>
        </div>

        <!-- 属性面板 -->
        <div class="designer-properties" id="propertiesPanel">
            <div class="empty-state">
                选择一个组件来编辑属性
            </div>
        </div>
    </main>

    <!-- 底部代码预览 -->
    <footer class="code-preview">
        <div class="preview-header">
            <h4>HTML 代码预览</h4>
            <div class="preview-actions">
                <button class="btn btn-small" id="copyCodeBtn">复制代码</button>
                <button class="btn btn-small toggle-code-btn" id="expandCodeBtn" style="display: none;">展开</button>
                <button class="btn btn-small" id="toggleCodeBtn">收起</button>
            </div>
        </div>
        <div class="preview-content" id="codePreview">
            <pre><code id="htmlCode"><!-- 拖拽组件后将在此处生成 HTML 代码 --></code></pre>
        </div>
    </footer>

    <!-- 浮动按钮 -->
    <button class="floating-btn" onclick="toggleCodePreview()" title="显示/隐藏代码预览" id="floatingToggleBtn">
        &lt;/&gt;
    </button>

    <script>
        class SimpleLibuiDesigner {
            constructor() {
                this.components = [];
                this.selectedComponent = null;
                this.componentIdCounter = 0;
                this.draggedComponent = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupDragAndDrop();
                this.updateCodePreview();
            }

            setupEventListeners() {
                // 平台切换
                document.querySelectorAll('.platform-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.platform-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        document.body.className = e.target.dataset.platform;
                    });
                });

                // 工具栏按钮
                document.getElementById('saveBtn').addEventListener('click', () => this.save());
                document.getElementById('exportBtn').addEventListener('click', () => this.export());
                document.getElementById('previewBtn').addEventListener('click', () => this.preview());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearAll());
            }

            setupDragAndDrop() {
                // 组件拖拽开始
                document.querySelectorAll('.component-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        this.draggedComponent = e.target.dataset.component;
                        e.dataTransfer.effectAllowed = 'copy';
                        e.target.style.opacity = '0.5';
                    });

                    item.addEventListener('dragend', (e) => {
                        e.target.style.opacity = '1';
                        this.draggedComponent = null;
                    });
                });

                // 画布拖拽事件
                const canvas = document.getElementById('designCanvas');

                canvas.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    
                    // 检查是否悬停在容器组件上
                    const targetComponent = this.getComponentAtPosition(e.clientX, e.clientY);
                    if (targetComponent && this.isContainerComponent(targetComponent.type)) {
                        this.highlightContainer(targetComponent);
                    } else {
                        canvas.classList.add('drag-over');
                        this.clearContainerHighlights();
                    }
                });

                canvas.addEventListener('dragleave', (e) => {
                    if (e.target === canvas) {
                        canvas.classList.remove('drag-over');
                        this.clearContainerHighlights();
                    }
                });

                canvas.addEventListener('drop', (e) => {
                    e.preventDefault();
                    canvas.classList.remove('drag-over');
                    this.clearContainerHighlights();

                    if (this.draggedComponent) {
                        const rect = canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        // 检查是否拖拽到容器组件上
                        const targetComponent = this.getComponentAtPosition(e.clientX, e.clientY);
                        if (targetComponent && this.isContainerComponent(targetComponent.type)) {
                            this.addComponentToContainer(this.draggedComponent, targetComponent, x, y);
                        } else {
                            this.addComponent(this.draggedComponent, x, y);
                        }
                    }
                });
            }

            addComponent(type, x, y) {
                const component = {
                    id: `component_${++this.componentIdCounter}`,
                    type: type,
                    x: x,
                    y: y,
                    props: this.getDefaultProps(type),
                    children: []
                };

                // 如果是窗口组件，自动居中
                if (type === 'window') {
                    const canvas = document.getElementById('designCanvas');
                    const canvasRect = canvas.getBoundingClientRect();
                    
                    let width = 400;
                    let height = 300;
                    if (component.props.size) {
                        const [w, h] = component.props.size.split(',').map(s => parseInt(s.trim()));
                        if (!isNaN(w)) width = w;
                        if (!isNaN(h)) height = h;
                    }
                    
                    component.x = Math.max(50, (canvasRect.width - width) / 2);
                    component.y = Math.max(50, (canvasRect.height - height) / 2);
                }

                this.components.push(component);
                this.renderComponent(component);
                this.updateCodePreview();
                this.hideEmptyState();
            }

            getDefaultProps(type) {
                const defaults = {
                    window: {
                        title: '窗口',
                        size: '800,600',
                        centered: 'true',
                        margined: 'true'
                    },
                    hbox: {
                        padded: 'false'
                    },
                    vbox: {
                        padded: 'false'
                    },
                    form: {
                        padded: 'true'
                    },
                    grid: {
                        padded: 'true'
                    },
                    tab: {
                        padded: 'true'
                    },
                    input: {
                        placeholder: '请输入文本',
                        stretchy: 'horizontal'
                    },
                    textarea: {
                        placeholder: '请输入多行文本',
                        rows: '3',
                        stretchy: 'horizontal'
                    },
                    password: {
                        placeholder: '请输入密码',
                        stretchy: 'horizontal'
                    },
                    combobox: {
                        selected: '0',
                        stretchy: 'horizontal'
                    },
                    spinbox: {
                        min: '0',
                        max: '100',
                        value: '0',
                        stretchy: 'horizontal'
                    },
                    slider: {
                        min: '0',
                        max: '100',
                        value: '50',
                        stretchy: 'horizontal'
                    },
                    button: {
                        text: '按钮',
                        stretchy: 'horizontal'
                    },
                    checkbox: {
                        text: '复选框',
                        checked: 'false',
                        stretchy: 'horizontal'
                    },
                    radio: {
                        text: '单选框',
                        stretchy: 'horizontal'
                    },
                    label: {
                        text: '标签文本',
                        stretchy: 'horizontal'
                    },
                    progressbar: {
                        value: '60',
                        stretchy: 'horizontal'
                    },
                    separator: {
                        orientation: 'horizontal',
                        stretchy: 'horizontal'
                    },
                    table: {
                        columns: '列1,列2',
                        data: '数据1,数据2',
                        stretchy: 'horizontal'
                    }
                };

                return defaults[type] || {};
            }

            renderComponent(component, parentComponent = null) {
                let targetElement;
                
                if (parentComponent) {
                    // 渲染到父容器中
                    const parentEl = document.querySelector(`[data-component-id="${parentComponent.id}"]`);
                    if (parentEl) {
                        // 找到容器的内容区域
                        targetElement = parentEl.querySelector('.window-content') || 
                                      parentEl.querySelector('.ui-box') || 
                                      parentEl.querySelector('.ui-form') || 
                                      parentEl.querySelector('.ui-grid') || 
                                      parentEl.querySelector('.ui-tab') ||
                                      parentEl.querySelector('.component-content');
                    }
                } else {
                    // 渲染到画布中
                    targetElement = document.getElementById('designCanvas');
                }
                
                if (!targetElement) {
                    console.warn('无法找到目标元素', component, parentComponent);
                    return;
                }
                
                // 检查组件是否已经存在于DOM中，如果是则先移除
                const existingElement = document.querySelector(`[data-component-id="${component.id}"]`);
                if (existingElement) {
                    existingElement.remove();
                }
                
                const element = this.createComponentElement(component);
                
                // 设置子组件的样式
                if (parentComponent) {
                    // 子组件使用相对定位，不使用绝对定位
                    element.style.position = 'relative';
                    element.style.margin = '2px';
                    element.style.display = 'block';
                    element.style.border = '1px solid #ddd';
                    element.style.borderRadius = '4px';
                    element.style.padding = '4px';
                    element.style.background = 'white';
                    element.style.zIndex = '20';
                    element.style.minWidth = '0';
                    element.style.maxWidth = '100%';
                    element.style.boxSizing = 'border-box';
                    
                    // 根据父容器类型设置flex属性
                    if (parentComponent.type === 'hbox') {
                        element.style.display = 'inline-block';
                        element.style.verticalAlign = 'top';
                    } else if (parentComponent.type === 'vbox') {
                        element.style.display = 'block';
                    } else if (parentComponent.type === 'box') {
                        element.style.display = 'inline-block';
                        element.style.verticalAlign = 'top';
                    } else if (parentComponent.type === 'form') {
                        element.style.display = 'block';
                        element.style.marginBottom = '8px';
                    }
                    
                    // 确保控制按钮在最上层
                    const controls = element.querySelector('.component-controls');
                    if (controls) {
                        controls.style.zIndex = '1001';
                    }
                }
                
                targetElement.appendChild(element);
                
                // 更新容器占位符
                if (parentComponent) {
                    this.updateContainerPlaceholder(parentComponent);
                }
            }

            createComponentElement(component) {
                const div = document.createElement('div');
                div.className = 'component-element';
                div.dataset.componentId = component.id;
                div.dataset.componentType = component.type;
                
                // 只有根级别组件才使用绝对定位
                if (!component.parent) {
                    div.style.position = 'absolute';
                    div.style.left = component.x + 'px';
                    div.style.top = component.y + 'px';
                } else {
                    // 子组件使用相对定位
                    div.style.position = 'relative';
                    div.style.margin = '2px';
                    div.style.display = 'block';
                    div.style.border = '1px solid #ddd';
                    div.style.borderRadius = '4px';
                    div.style.padding = '4px';
                    div.style.background = 'white';
                    div.style.zIndex = '20';
                    div.style.minWidth = '0';
                    div.style.maxWidth = '100%';
                    div.style.boxSizing = 'border-box';
                }

                // 创建组件内容
                const content = this.createComponentContent(component);
                div.appendChild(content);

                // 创建控制按钮
                const controls = this.createComponentControls(component);
                div.appendChild(controls);

                // 添加事件监听
                div.addEventListener('click', (e) => {
                    // 如果点击的不是控制按钮，则选中组件
                    if (!e.target.closest('.component-controls')) {
                        e.stopPropagation();
                        this.selectComponent(component);
                    }
                });

                return div;
            }

            createComponentContent(component) {
                const content = document.createElement('div');
                content.className = 'component-content';

                switch (component.type) {
                    case 'window':
                        let width = 400;
                        let height = 300;
                        if (component.props.size) {
                            const [w, h] = component.props.size.split(',').map(s => parseInt(s.trim()));
                            if (!isNaN(w)) width = w;
                            if (!isNaN(h)) height = h;
                        }

                        const padding = component.props.margined === 'true' ? '16px' : '8px';

                        content.innerHTML = `
                            <div class="ui-window" style="width: ${width}px; height: ${height}px; border: 1px solid #ccc; background: white; max-width: 100%; overflow: hidden; position: relative;">
                                <div style="padding: 8px; border-bottom: 1px solid #ccc; background: #f8f9fa;">
                                    ${component.props.title || '窗口'}
                                </div>
                                <div style="padding: ${padding}; min-height: ${height - 60}px; width: 100%; box-sizing: border-box;" class="window-content">
                                    窗口内容区域
                                </div>
                            </div>
                        `;
                        break;

                    case 'hbox':
                            let hboxPadding = component.props.padded === 'true' ? '8px' : '0px';
                            content.innerHTML = `
                                <div class="ui-box horizontal" style="min-width: 200px; min-height: 60px; border: 2px dashed #0078d4; background: rgba(0, 120, 212, 0.05); display: flex; gap: 8px; padding: ${hboxPadding}; align-items: center; width: 100%; position: relative; box-sizing: border-box;">
                                    HBox 容器
                                </div>
                            `;
                        break;

                    case 'vbox':
                        const vboxPadding = component.props.padded === 'true' ? '8px' : '0px';
                        content.innerHTML = `
                            <div class="ui-box vertical" style="min-width: 200px; min-height: 120px; border: 2px dashed #0078d4; background: rgba(0, 120, 212, 0.05); display: flex; flex-direction: column; gap: 8px; padding: ${vboxPadding}; width: 100%; position: relative; box-sizing: border-box;">
                                    VBox 容器
                                </div>
                            `;
                        break;

                    case 'form':
                        const formPadding = component.props.padded === 'true' ? '16px' : '8px';
                        content.innerHTML = `
                            <div class="ui-form" style="min-width: 300px; min-height: 200px; border: 2px dashed #0078d4; background: rgba(0, 120, 212, 0.05); padding: ${formPadding}; width: 100%; position: relative; box-sizing: border-box;">
                                Form 容器
                            </div>
                        `;
                        break;

                    case 'grid':
                        content.innerHTML = `
                            <div class="ui-grid" style="min-width: 200px; min-height: 150px; border: 2px dashed #0078d4; background: rgba(0, 120, 212, 0.05); display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 8px; position: relative;">
                                Grid 容器
                            </div>
                        `;
                        break;

                    case 'tab':
                        const tabPadding = component.props.padded === 'true' ? '8px' : '0px';
                        content.innerHTML = `
                            <div class="ui-tab" style="min-width: 300px; min-height: 200px; border: 2px dashed #0078d4; background: rgba(0, 120, 212, 0.05); padding: ${tabPadding}; width: 100%; position: relative; box-sizing: border-box;">
                                <div style="border-bottom: 1px solid #ccc; margin-bottom: 8px;">
                                    <button style="padding: 4px 8px; border: none; background: #f8f9fa; border-bottom: 2px solid #0078d4;">标签页1</button>
                                    <button style="padding: 4px 8px; border: none; background: #f8f9fa;">标签页2</button>
                                </div>
                                Tab 容器
                            </div>
                        `;
                        break;

                    case 'input':
                        let inputStyle = 'width: 200px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;';
                        if (component.props.stretchy === 'true' || component.props.stretchy === 'horizontal') {
                            inputStyle = 'flex: 1; min-width: 80px; max-width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;';
                        } else if (component.props.stretchy === 'vertical') {
                            inputStyle = 'width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;';
                        }
                        content.innerHTML = `
                            <input type="text" class="ui-entry" placeholder="${component.props.placeholder || '请输入文本'}" style="${inputStyle}">
                        `;
                        break;

                    case 'textarea':
                        let textareaStyle = 'width: 200px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;';
                        if (component.props.stretchy === 'true' || component.props.stretchy === 'horizontal') {
                            textareaStyle = 'flex: 1; min-width: 80px; max-width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;';
                        } else if (component.props.stretchy === 'vertical') {
                            textareaStyle = 'width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;';
                        }
                        content.innerHTML = `
                            <textarea class="ui-multiline-entry" placeholder="${component.props.placeholder || '请输入多行文本'}" rows="${component.props.rows || '3'}" style="${textareaStyle}"></textarea>
                        `;
                        break;

                    case 'password':
                        let passwordStyle = 'width: 200px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;';
                        if (component.props.stretchy === 'true' || component.props.stretchy === 'horizontal') {
                            passwordStyle = 'flex: 1; min-width: 80px; max-width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;';
                        } else if (component.props.stretchy === 'vertical') {
                            passwordStyle = 'width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;';
                        }
                        content.innerHTML = `
                            <input type="password" class="ui-entry" placeholder="${component.props.placeholder || '请输入密码'}" style="${passwordStyle}">
                        `;
                        break;

                    case 'combobox':
                        let comboboxStyle = 'width: 150px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;';
                        if (component.props.stretchy === 'true' || component.props.stretchy === 'horizontal') {
                            comboboxStyle = 'flex: 1; min-width: 80px; max-width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;';
                        } else if (component.props.stretchy === 'vertical') {
                            comboboxStyle = 'width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;';
                        }
                        content.innerHTML = `
                            <select class="ui-combobox" style="${comboboxStyle}">
                                <option>选项 1</option>
                                <option>选项 2</option>
                                <option>选项 3</option>
                            </select>
                        `;
                        break;

                    case 'spinbox':
                        let spinboxStyle = 'width: 120px;';
                        if (component.props.stretchy === 'true' || component.props.stretchy === 'horizontal') {
                            spinboxStyle = 'flex: 1; min-width: 80px; max-width: 100%;';
                        } else if (component.props.stretchy === 'vertical') {
                            spinboxStyle = 'width: 100%;';
                        }
                        content.innerHTML = `
                            <div class="ui-spinbox" style="${spinboxStyle}">
                                <input type="number" value="${component.props.value || '0'}" min="${component.props.min || '0'}" max="${component.props.max || '100'}" readonly style="width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                <button disabled>-</button>
                                <button disabled>+</button>
                            </div>
                        `;
                        break;

                    case 'slider':
                        let sliderStyle = 'width: 200px;';
                        if (component.props.stretchy === 'true' || component.props.stretchy === 'horizontal') {
                            sliderStyle = 'flex: 1; min-width: 80px; max-width: 100%;';
                        } else if (component.props.stretchy === 'vertical') {
                            sliderStyle = 'width: 100%;';
                        }
                        content.innerHTML = `
                            <div class="ui-slider" style="${sliderStyle}">
                                <input type="range" value="${component.props.value || '50'}" min="${component.props.min || '0'}" max="${component.props.max || '100'}" readonly style="width: 100%;">
                                <span>${component.props.value || '50'}</span>
                            </div>
                        `;
                        break;

                    case 'button':
                        let buttonStyle = 'padding: 6px 16px; border: 1px solid #0078d4; background: #0078d4; color: white; border-radius: 4px; cursor: pointer;';
                        if (component.props.stretchy === 'true' || component.props.stretchy === 'horizontal') {
                            buttonStyle = 'flex: 1; min-width: 80px; max-width: 100%; padding: 6px 16px; border: 1px solid #0078d4; background: #0078d4; color: white; border-radius: 4px; cursor: pointer; box-sizing: border-box;';
                        } else if (component.props.stretchy === 'vertical') {
                            buttonStyle = 'width: 100%; padding: 6px 16px; border: 1px solid #0078d4; background: #0078d4; color: white; border-radius: 4px; cursor: pointer; box-sizing: border-box;';
                        }
                        content.innerHTML = `
                            <button class="ui-button" style="${buttonStyle}">
                                ${component.props.text || '按钮'}
                            </button>
                        `;
                        break;

                    case 'checkbox':
                        let checkboxStyle = '';
                        if (component.props.stretchy === 'true' || component.props.stretchy === 'horizontal') {
                            checkboxStyle = 'flex: 1;';
                        } else if (component.props.stretchy === 'vertical') {
                            checkboxStyle = 'width: 100%;';
                        }
                        content.innerHTML = `
                            <label class="ui-checkbox" style="${checkboxStyle}">
                                <input type="checkbox" ${component.props.checked === 'true' ? 'checked' : ''}>
                                <span>${component.props.text || '复选框'}</span>
                            </label>
                        `;
                        break;

                    case 'radio':
                        let radioStyle = '';
                        if (component.props.stretchy === 'true' || component.props.stretchy === 'horizontal') {
                            radioStyle = 'flex: 1;';
                        } else if (component.props.stretchy === 'vertical') {
                            radioStyle = 'width: 100%;';
                        }
                        content.innerHTML = `
                            <div class="ui-radio-buttons" style="${radioStyle}">
                                <label>
                                    <input type="radio" name="preview" disabled>
                                    <span>${component.props.text || '单选框'}</span>
                                </label>
                            </div>
                        `;
                        break;

                    case 'label':
                        let labelStyle = 'font-size: 14px; color: #333;';
                        if (component.props.stretchy === 'true' || component.props.stretchy === 'horizontal') {
                            labelStyle = 'flex: 1; font-size: 14px; color: #333;';
                        } else if (component.props.stretchy === 'vertical') {
                            labelStyle = 'width: 100%; font-size: 14px; color: #333;';
                        }
                        content.innerHTML = `
                            <span class="ui-label" style="${labelStyle}">
                                ${component.props.text || '标签文本'}
                            </span>
                        `;
                        break;

                    case 'progressbar':
                        let progressbarStyle = 'width: 200px;';
                        if (component.props.stretchy === 'true' || component.props.stretchy === 'horizontal') {
                            progressbarStyle = 'flex: 1; min-width: 80px; max-width: 100%;';
                        } else if (component.props.stretchy === 'vertical') {
                            progressbarStyle = 'width: 100%;';
                        }
                        content.innerHTML = `
                            <div class="ui-progress-bar" style="${progressbarStyle}">
                                <div class="fill" style="width: ${component.props.value || '60'}%; height: 20px; background: #0078d4; border-radius: 4px;"></div>
                            </div>
                        `;
                        break;

                    case 'separator':
                        if (component.props.orientation === 'vertical') {
                            content.innerHTML = `<hr class="ui-separator vertical" style="height: 50px; width: 2px;">`;
                        } else {
                            content.innerHTML = `<hr class="ui-separator horizontal" style="width: 200px; height: 1px;">`;
                        }
                        break;

                    case 'table':
                        let tableStyle = 'width: 200px;';
                        if (component.props.stretchy === 'true') {
                            tableStyle = 'width: 100%;';
                        }
                        content.innerHTML = `
                            <table class="mini-table" style="${tableStyle}">
                                <tr>
                                    <th>列1</th>
                                    <th>列2</th>
                                </tr>
                                <tr>
                                    <td>数据1</td>
                                    <td>数据2</td>
                                </tr>
                            </table>
                        `;
                        break;

                    default:
                        content.innerHTML = `<div style="padding: 8px; border: 1px solid #ccc;">${component.type}</div>`;
                }

                return content;
            }

            createComponentControls(component) {
                const controls = document.createElement('div');
                controls.className = 'component-controls';

                // 删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'control-btn delete';
                deleteBtn.innerHTML = '×';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    this.deleteComponent(component);
                }, true); // 使用捕获阶段确保优先处理

                controls.appendChild(deleteBtn);
                return controls;
            }

            selectComponent(component) {
                // 清除之前的选择
                document.querySelectorAll('.component-element').forEach(el => {
                    el.classList.remove('selected');
                });

                // 选中当前组件
                const element = document.querySelector(`[data-component-id="${component.id}"]`);
                if (element) {
                    element.classList.add('selected');
                }

                this.selectedComponent = component;
                this.showProperties(component);
            }

            showProperties(component) {
                const propertiesPanel = document.getElementById('propertiesPanel');
                
                let html = `
                    <div class="property-group">
                        <h4>基本属性</h4>
                        <div class="property-row">
                            <label class="property-label">组件类型:</label>
                            <span class="property-input" style="background: #f8f9fa;">${component.type}</span>
                        </div>
                        <div class="property-row">
                            <label class="property-label">ID:</label>
                            <span class="property-input" style="background: #f8f9fa;">${component.id}</span>
                        </div>
                    </div>
                `;

                // 添加特定组件的属性
                html += this.getComponentProperties(component);

                propertiesPanel.innerHTML = html;
                this.bindPropertyEvents(component);
            }

            getComponentProperties(component) {
                let html = '';

                switch (component.type) {
                    case 'window':
                        html += `
                            <div class="property-group">
                                <h4>窗口属性</h4>
                                <div class="property-row">
                                    <label class="property-label">标题:</label>
                                    <input type="text" class="property-input" data-prop="title" value="${component.props.title || ''}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">尺寸:</label>
                                    <input type="text" class="property-input" data-prop="size" value="${component.props.size || ''}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">居中:</label>
                                    <select class="property-input" data-prop="centered">
                                        <option value="true" ${component.props.centered === 'true' ? 'selected' : ''}>是</option>
                                        <option value="false" ${component.props.centered === 'false' ? 'selected' : ''}>否</option>
                                    </select>
                                </div>
                                <div class="property-row">
                                    <label class="property-label">边距:</label>
                                    <select class="property-input" data-prop="margined">
                                        <option value="true" ${component.props.margined === 'true' ? 'selected' : ''}>是</option>
                                        <option value="false" ${component.props.margined === 'false' ? 'selected' : ''}>否</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'hbox':
                    case 'vbox':
                    case 'box':
                    case 'form':
                    case 'grid':
                    case 'tab':
                        html += `
                            <div class="property-group">
                                <h4>容器属性</h4>
                                <div class="property-row">
                                    <label class="property-label">内边距:</label>
                                    <select class="property-input" data-prop="padded">
                                        <option value="true" ${component.props.padded === 'true' ? 'selected' : ''}>是</option>
                                        <option value="false" ${component.props.padded === 'false' ? 'selected' : ''}>否</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'input':
                    case 'textarea':
                    case 'password':
                        html += `
                            <div class="property-group">
                                <h4>输入属性</h4>
                                <div class="property-row">
                                    <label class="property-label">占位符:</label>
                                    <input type="text" class="property-input" data-prop="placeholder" value="${component.props.placeholder || ''}">
                                </div>
                                ${component.type === 'textarea' ? `
                                <div class="property-row">
                                    <label class="property-label">行数:</label>
                                    <input type="number" class="property-input" data-prop="rows" value="${component.props.rows || '3'}">
                                </div>
                                ` : ''}
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    <select class="property-input" data-prop="stretchy">
                                        <option value="false" ${component.props.stretchy === 'false' ? 'selected' : ''}>不拉伸</option>
                                        <option value="true" ${component.props.stretchy === 'true' ? 'selected' : ''}>全部拉伸</option>
                                        <option value="horizontal" ${component.props.stretchy === 'horizontal' ? 'selected' : ''}>水平拉伸</option>
                                        <option value="vertical" ${component.props.stretchy === 'vertical' ? 'selected' : ''}>垂直拉伸</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'combobox':
                        html += `
                            <div class="property-group">
                                <h4>下拉框属性</h4>
                                <div class="property-row">
                                    <label class="property-label">选中项:</label>
                                    <input type="number" class="property-input" data-prop="selected" value="${component.props.selected || '0'}" min="0">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    <select class="property-input" data-prop="stretchy">
                                        <option value="false" ${component.props.stretchy === 'false' ? 'selected' : ''}>不拉伸</option>
                                        <option value="true" ${component.props.stretchy === 'true' ? 'selected' : ''}>全部拉伸</option>
                                        <option value="horizontal" ${component.props.stretchy === 'horizontal' ? 'selected' : ''}>水平拉伸</option>
                                        <option value="vertical" ${component.props.stretchy === 'vertical' ? 'selected' : ''}>垂直拉伸</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'spinbox':
                    case 'slider':
                        html += `
                            <div class="property-group">
                                <h4>数值属性</h4>
                                <div class="property-row">
                                    <label class="property-label">最小值:</label>
                                    <input type="number" class="property-input" data-prop="min" value="${component.props.min || '0'}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">最大值:</label>
                                    <input type="number" class="property-input" data-prop="max" value="${component.props.max || '100'}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">当前值:</label>
                                    <input type="number" class="property-input" data-prop="value" value="${component.props.value || '50'}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    <select class="property-input" data-prop="stretchy">
                                        <option value="false" ${component.props.stretchy === 'false' ? 'selected' : ''}>不拉伸</option>
                                        <option value="true" ${component.props.stretchy === 'true' ? 'selected' : ''}>全部拉伸</option>
                                        <option value="horizontal" ${component.props.stretchy === 'horizontal' ? 'selected' : ''}>水平拉伸</option>
                                        <option value="vertical" ${component.props.stretchy === 'vertical' ? 'selected' : ''}>垂直拉伸</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'progressbar':
                        html += `
                            <div class="property-group">
                                <h4>进度条属性</h4>
                                <div class="property-row">
                                    <label class="property-label">进度:</label>
                                    <input type="number" class="property-input" data-prop="value" value="${component.props.value || '60'}" min="0" max="100">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    <select class="property-input" data-prop="stretchy">
                                        <option value="false" ${component.props.stretchy === 'false' ? 'selected' : ''}>不拉伸</option>
                                        <option value="true" ${component.props.stretchy === 'true' ? 'selected' : ''}>全部拉伸</option>
                                        <option value="horizontal" ${component.props.stretchy === 'horizontal' ? 'selected' : ''}>水平拉伸</option>
                                        <option value="vertical" ${component.props.stretchy === 'vertical' ? 'selected' : ''}>垂直拉伸</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'separator':
                        html += `
                            <div class="property-group">
                                <h4>分隔符属性</h4>
                                <div class="property-row">
                                    <label class="property-label">方向:</label>
                                    <select class="property-input" data-prop="orientation">
                                        <option value="horizontal" ${component.props.orientation === 'horizontal' ? 'selected' : ''}>水平</option>
                                        <option value="vertical" ${component.props.orientation === 'vertical' ? 'selected' : ''}>垂直</option>
                                    </select>
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    <select class="property-input" data-prop="stretchy">
                                        <option value="false" ${component.props.stretchy === 'false' ? 'selected' : ''}>不拉伸</option>
                                        <option value="true" ${component.props.stretchy === 'true' ? 'selected' : ''}>全部拉伸</option>
                                        <option value="horizontal" ${component.props.stretchy === 'horizontal' ? 'selected' : ''}>水平拉伸</option>
                                        <option value="vertical" ${component.props.stretchy === 'vertical' ? 'selected' : ''}>垂直拉伸</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'table':
                        html += `
                            <div class="property-group">
                                <h4>表格属性</h4>
                                <div class="property-row">
                                    <label class="property-label">列标题:</label>
                                    <input type="text" class="property-input" data-prop="columns" value="${component.props.columns || '列1,列2'}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    <select class="property-input" data-prop="stretchy">
                                        <option value="false" ${component.props.stretchy === 'false' ? 'selected' : ''}>不拉伸</option>
                                        <option value="true" ${component.props.stretchy === 'true' ? 'selected' : ''}>全部拉伸</option>
                                        <option value="horizontal" ${component.props.stretchy === 'horizontal' ? 'selected' : ''}>水平拉伸</option>
                                        <option value="vertical" ${component.props.stretchy === 'vertical' ? 'selected' : ''}>垂直拉伸</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'button':
                        html += `
                            <div class="property-group">
                                <h4>按钮属性</h4>
                                <div class="property-row">
                                    <label class="property-label">文本:</label>
                                    <input type="text" class="property-input" data-prop="text" value="${component.props.text || ''}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    <select class="property-input" data-prop="stretchy">
                                        <option value="false" ${component.props.stretchy === 'false' ? 'selected' : ''}>不拉伸</option>
                                        <option value="true" ${component.props.stretchy === 'true' ? 'selected' : ''}>全部拉伸</option>
                                        <option value="horizontal" ${component.props.stretchy === 'horizontal' ? 'selected' : ''}>水平拉伸</option>
                                        <option value="vertical" ${component.props.stretchy === 'vertical' ? 'selected' : ''}>垂直拉伸</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'checkbox':
                        html += `
                            <div class="property-group">
                                <h4>复选框属性</h4>
                                <div class="property-row">
                                    <label class="property-label">文本:</label>
                                    <input type="text" class="property-input" data-prop="text" value="${component.props.text || ''}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">选中:</label>
                                    <select class="property-input" data-prop="checked">
                                        <option value="true" ${component.props.checked === 'true' ? 'selected' : ''}>是</option>
                                        <option value="false" ${component.props.checked === 'false' ? 'selected' : ''}>否</option>
                                    </select>
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    <select class="property-input" data-prop="stretchy">
                                        <option value="false" ${component.props.stretchy === 'false' ? 'selected' : ''}>不拉伸</option>
                                        <option value="true" ${component.props.stretchy === 'true' ? 'selected' : ''}>全部拉伸</option>
                                        <option value="horizontal" ${component.props.stretchy === 'horizontal' ? 'selected' : ''}>水平拉伸</option>
                                        <option value="vertical" ${component.props.stretchy === 'vertical' ? 'selected' : ''}>垂直拉伸</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'radio':
                        html += `
                            <div class="property-group">
                                <h4>单选框属性</h4>
                                <div class="property-row">
                                    <label class="property-label">文本:</label>
                                    <input type="text" class="property-input" data-prop="text" value="${component.props.text || ''}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    <select class="property-input" data-prop="stretchy">
                                        <option value="false" ${component.props.stretchy === 'false' ? 'selected' : ''}>不拉伸</option>
                                        <option value="true" ${component.props.stretchy === 'true' ? 'selected' : ''}>全部拉伸</option>
                                        <option value="horizontal" ${component.props.stretchy === 'horizontal' ? 'selected' : ''}>水平拉伸</option>
                                        <option value="vertical" ${component.props.stretchy === 'vertical' ? 'selected' : ''}>垂直拉伸</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'label':
                        html += `
                            <div class="property-group">
                                <h4>标签属性</h4>
                                <div class="property-row">
                                    <label class="property-label">文本:</label>
                                    <input type="text" class="property-input" data-prop="text" value="${component.props.text || ''}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    <select class="property-input" data-prop="stretchy">
                                        <option value="false" ${component.props.stretchy === 'false' ? 'selected' : ''}>不拉伸</option>
                                        <option value="true" ${component.props.stretchy === 'true' ? 'selected' : ''}>全部拉伸</option>
                                        <option value="horizontal" ${component.props.stretchy === 'horizontal' ? 'selected' : ''}>水平拉伸</option>
                                        <option value="vertical" ${component.props.stretchy === 'vertical' ? 'selected' : ''}>垂直拉伸</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;
                }

                return html;
            }

            bindPropertyEvents(component) {
                const propertyInputs = document.querySelectorAll('.property-input');
                propertyInputs.forEach(input => {
                    input.addEventListener('input', (e) => {
                        const prop = e.target.dataset.prop;
                        const value = e.target.value;
                        component.props[prop] = value;
                        this.refreshComponent(component);
                        this.updateCodePreview();
                    });
                });
            }

            refreshComponent(component) {
                const element = document.querySelector(`[data-component-id="${component.id}"]`);
                if (element) {
                    const newContent = this.createComponentContent(component);
                    const oldContent = element.querySelector('.component-content');
                    element.replaceChild(newContent, oldContent);
                }
            }

            deleteComponent(component) {
                // 从数据结构中删除
                this.removeComponentFromTree(component);
                
                // 从DOM中删除
                const element = document.querySelector(`[data-component-id="${component.id}"]`);
                if (element) {
                    element.remove();
                }
                
                this.updateCodePreview();
                
                // 检查是否需要显示空状态
                if (this.components.length === 0) {
                    this.showEmptyState();
                }
            }
            
            removeComponentFromTree(targetComponent) {
                // 从根组件中查找并删除
                const removeFromArray = (components) => {
                    for (let i = components.length - 1; i >= 0; i--) {
                        if (components[i].id === targetComponent.id) {
                            components.splice(i, 1);
                            return true;
                        }
                        
                        // 递归检查子组件
                        if (components[i].children && components[i].children.length > 0) {
                            if (removeFromArray(components[i].children)) {
                                return true;
                            }
                        }
                    }
                    return false;
                };
                
                removeFromArray(this.components);
            }

            clearAll() {
                if (confirm('确定要清空所有组件吗？')) {
                    this.components = [];
                    document.querySelectorAll('.component-element').forEach(el => el.remove());
                    this.updateCodePreview();
                    this.showEmptyState();
                }
            }

            hideEmptyState() {
                const emptyState = document.getElementById('emptyState');
                if (emptyState) {
                    emptyState.style.display = 'none';
                }
            }

            showEmptyState() {
                const emptyState = document.getElementById('emptyState');
                if (emptyState) {
                    emptyState.style.display = 'flex';
                }
            }

            updateCodePreview() {
                const codeContent = document.getElementById('codeContent');
                const htmlCode = document.getElementById('htmlCode');
                const html = this.generateHTML();
                
                if (codeContent) {
                    codeContent.textContent = html;
                }
                if (htmlCode) {
                    htmlCode.textContent = html;
                }
            }
            
            getComponentAtPosition(clientX, clientY) {
                const elements = document.elementsFromPoint(clientX, clientY);
                for (let element of elements) {
                    const componentEl = element.closest('.component-element');
                    if (componentEl) {
                        const componentId = componentEl.dataset.componentId;
                        return this.findComponentById(componentId);
                    }
                }
                return null;
            }
            
            findComponentById(id) {
                // 在根级别查找
                let component = this.components.find(c => c.id === id);
                if (component) return component;
                
                // 递归在子组件中查找
                for (let rootComponent of this.components) {
                    component = this.findInChildren(rootComponent, id);
                    if (component) return component;
                }
                
                return null;
            }
            
            findInChildren(parent, id) {
                for (let child of parent.children) {
                    if (child.id === id) return child;
                    
                    const found = this.findInChildren(child, id);
                    if (found) return found;
                }
                return null;
            }
            
            isContainerComponent(type) {
                return ['window', 'grid', 'hbox', 'vbox', 'box', 'form', 'tab'].includes(type);
            }
            
            highlightContainer(container) {
                this.clearContainerHighlights();
                const element = document.querySelector(`[data-component-id="${container.id}"]`);
                if (element) {
                    element.classList.add('drag-target');
                }
            }
            
            clearContainerHighlights() {
                document.querySelectorAll('.drag-target').forEach(el => {
                    el.classList.remove('drag-target');
                });
            }
            
            addComponentToContainer(type, containerComponent, x, y) {
                const component = {
                    id: `component_${++this.componentIdCounter}`,
                    type: type,
                    x: 0, // 子组件不需要绝对定位
                    y: 0,
                    props: this.getDefaultProps(type),
                    children: [],
                    parent: containerComponent.id
                };
                
                // 根据父容器类型自动设置默认拉伸属性
                if (containerComponent.type === 'hbox') {
                    // HBox中子组件默认水平拉伸
                    component.props.stretchy = 'horizontal';
                } else if (containerComponent.type === 'vbox') {
                    // VBox中子组件默认垂直拉伸
                    component.props.stretchy = 'vertical';
                } else if (containerComponent.type === 'box') {
                    // Box中子组件默认不拉伸
                    component.props.stretchy = 'false';
                } else if (containerComponent.type === 'form') {
                    // Form中子组件默认水平拉伸
                    component.props.stretchy = 'horizontal';
                }
                
                // 添加到父容器的children数组
                containerComponent.children.push(component);
                
                // 渲染组件到容器中
                this.renderComponent(component, containerComponent);
                this.updateCodePreview();
            }
            
            updateContainerPlaceholder(containerComponent) {
                const parentEl = document.querySelector(`[data-component-id="${containerComponent.id}"]`);
                if (parentEl) {
                    const containerContent = parentEl.querySelector('.window-content') || 
                                            parentEl.querySelector('.ui-box') || 
                                            parentEl.querySelector('.ui-form') || 
                                            parentEl.querySelector('.ui-grid') || 
                                            parentEl.querySelector('.ui-tab');
                    
                    if (containerContent) {
                        // 检查是否有子组件
                        const hasChildren = containerComponent.children.length > 0;
                        
                        // 移除所有占位符文本
                        const allTextNodes = Array.from(containerContent.childNodes).filter(node => 
                            node.nodeType === Node.TEXT_NODE
                        );
                        allTextNodes.forEach(node => node.remove());
                        
                        // 如果没有子组件，添加占位符
                        if (!hasChildren) {
                            const placeholder = document.createElement('div');
                            placeholder.style.color = '#999';
                            placeholder.style.fontStyle = 'italic';
                            placeholder.style.padding = '8px';
                            placeholder.textContent = `${containerComponent.type} 容器`;
                            containerContent.appendChild(placeholder);
                        }
                    }
                }
            }

            generateHTML() {
                function generateComponentHTML(component, indent = 0) {
                    const spaces = '    '.repeat(indent);

                    switch (component.type) {
                        case 'window':
                            const size = component.props.size || '400,300';
                            let windowHTML = `${spaces}<window title="${component.props.title || '窗口'}" size="${size}"`;
                            
                            if (component.props.centered === 'true') windowHTML += ' centered="true"';
                            if (component.props.margined === 'true') windowHTML += ' margined="true"';
                            
                            windowHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    windowHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                windowHTML += `${spaces}    窗口内容\n`;
                            }
                            
                            windowHTML += `${spaces}</window>`;
                            return windowHTML;

                        case 'hbox':
                            let hboxHTML = `${spaces}<hbox`;
                            if (component.props.padded === 'true') hboxHTML += ' padded="true"';
                            hboxHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    hboxHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                hboxHTML += `${spaces}    HBox 内容\n`;
                            }
                            
                            hboxHTML += `${spaces}</hbox>`;
                            return hboxHTML;

                        case 'vbox':
                            let vboxHTML = `${spaces}<vbox`;
                            if (component.props.padded === 'true') vboxHTML += ' padded="true"';
                            vboxHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    vboxHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                vboxHTML += `${spaces}    VBox 内容\n`;
                            }
                            
                            vboxHTML += `${spaces}</vbox>`;
                            return vboxHTML;

                        case 'box':
                            let boxHTML = `${spaces}<box`;
                            if (component.props.padded === 'true') boxHTML += ' padded="true"';
                            boxHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    boxHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                boxHTML += `${spaces}    Box 内容\n`;
                            }
                            
                            boxHTML += `${spaces}</box>`;
                            return boxHTML;

                        case 'form':
                            let formHTML = `${spaces}<form`;
                            if (component.props.padded === 'true') formHTML += ' padded="true"';
                            formHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    formHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                formHTML += `${spaces}    Form 内容\n`;
                            }
                            
                            formHTML += `${spaces}</form>`;
                            return formHTML;

                        case 'grid':
                            let gridHTML = `${spaces}<grid`;
                            if (component.props.padded === 'true') gridHTML += ' padded="true"';
                            gridHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    gridHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                gridHTML += `${spaces}    Grid 内容\n`;
                            }
                            
                            gridHTML += `${spaces}</grid>`;
                            return gridHTML;

                        case 'tab':
                            let tabHTML = `${spaces}<tab`;
                            if (component.props.padded === 'true') tabHTML += ' padded="true"';
                            tabHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    tabHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                tabHTML += `${spaces}    Tab 内容\n`;
                            }
                            
                            tabHTML += `${spaces}</tab>`;
                            return tabHTML;

                        case 'input':
                            let inputHTML = `${spaces}<input placeholder="${component.props.placeholder || '请输入'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                inputHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            inputHTML += ' />';
                            return inputHTML;

                        case 'textarea':
                            let textareaHTML = `${spaces}<textarea placeholder="${component.props.placeholder || '请输入多行文本'}" rows="${component.props.rows || '3'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                textareaHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            textareaHTML += `></textarea>`;
                            return textareaHTML;

                        case 'password':
                            let passwordHTML = `${spaces}<input type="password" placeholder="${component.props.placeholder || '请输入密码'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                passwordHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            passwordHTML += ' />';
                            return passwordHTML;

                        case 'combobox':
                            let comboboxHTML = `${spaces}<combobox selected="${component.props.selected || '0'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                comboboxHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            comboboxHTML += '></combobox>';
                            return comboboxHTML;

                        case 'spinbox':
                            let spinboxHTML = `${spaces}<spinbox min="${component.props.min || '0'}" max="${component.props.max || '100'}" value="${component.props.value || '0'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                spinboxHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            spinboxHTML += '></spinbox>';
                            return spinboxHTML;

                        case 'slider':
                            let sliderHTML = `${spaces}<slider min="${component.props.min || '0'}" max="${component.props.max || '100'}" value="${component.props.value || '50'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                sliderHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            sliderHTML += '></slider>';
                            return sliderHTML;

                        case 'button':
                            let buttonHTML = `${spaces}<button`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                buttonHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            buttonHTML += `>${component.props.text || '按钮'}</button>`;
                            return buttonHTML;

                        case 'checkbox':
                            let checkboxHTML = `${spaces}<checkbox text="${component.props.text || '复选框'}"`;
                            if (component.props.checked === 'true') checkboxHTML += ' checked="true"';
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                checkboxHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            checkboxHTML += '></checkbox>';
                            return checkboxHTML;

                        case 'radio':
                            let radioHTML = `${spaces}<radio text="${component.props.text || '单选框'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                radioHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            radioHTML += '></radio>';
                            return radioHTML;

                        case 'label':
                            let labelHTML = `${spaces}<label`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                labelHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            labelHTML += `>${component.props.text || '标签'}</label>`;
                            return labelHTML;

                        case 'progressbar':
                            let progressbarHTML = `${spaces}<progressbar value="${component.props.value || '60'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                progressbarHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            progressbarHTML += '></progressbar>';
                            return progressbarHTML;

                        case 'separator':
                            let separatorHTML = `${spaces}<separator`;
                            if (component.props.orientation === 'vertical') separatorHTML += ' orientation="vertical"';
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                separatorHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            separatorHTML += '></separator>';
                            return separatorHTML;

                        case 'table':
                            let tableHTML = `${spaces}<table`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                tableHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            tableHTML += '></table>';
                            return tableHTML;

                        default:
                            return `${spaces}<!-- 未知组件: ${component.type} -->`;
                    }
                }

                let html = '<!DOCTYPE html>\n<html>\n<head>\n    <meta charset="UTF-8">\n    <title>libuiBuilder 生成的界面</title>\n</head>\n<body>\n';
                
                if (this.components.length > 0) {
                    this.components.forEach(component => {
                        html += generateComponentHTML(component, 1) + '\n';
                    });
                }
                
                html += '</body>\n</html>';
                return html;
            }

            save() {
                const html = this.generateHTML();
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'libui-design.html';
                a.click();
                URL.revokeObjectURL(url);
            }

            export() {
                const html = this.generateHTML();
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 80%; max-height: 80%; overflow: auto;">
                        <h3>生成的HTML代码</h3>
                        <textarea style="width: 100%; height: 400px; font-family: monospace;">${html}</textarea>
                        <div style="margin-top: 10px;">
                            <button onclick="navigator.clipboard.writeText(document.querySelector('textarea').value).then(() => alert('已复制到剪贴板'))">复制</button>
                            <button onclick="this.closest('div[style]').remove()">关闭</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            preview() {
                const html = this.generateHTML();
                const newWindow = window.open();
                newWindow.document.write(html);
                newWindow.document.close();
            }
        }

        // 全局函数
        function toggleCodePreview() {
            const panel = document.querySelector('.code-preview');
            const floatingBtn = document.getElementById('floatingToggleBtn');
            const toggleBtn = document.getElementById('toggleCodeBtn');
            const expandBtn = document.getElementById('expandCodeBtn');
            
            if (panel.classList.contains('collapsed')) {
                // 当前是收起状态，展开
                panel.classList.remove('collapsed');
                floatingBtn.innerHTML = '&lt;/&gt;';
                toggleBtn.style.display = 'inline-block';
                expandBtn.style.display = 'none';
            } else {
                // 当前是展开状态，收起
                panel.classList.add('collapsed');
                floatingBtn.innerHTML = '1';
                toggleBtn.style.display = 'none';
                expandBtn.style.display = 'inline-block';
            }
        }

        // 初始化设计器
        document.addEventListener('DOMContentLoaded', () => {
            const designer = new SimpleLibuiDesigner();
            window.designer = designer;
            
            // 初始化代码预览状态
            const panel = document.querySelector('.code-preview');
            const floatingBtn = document.getElementById('floatingToggleBtn');
            const toggleBtn = document.getElementById('toggleCodeBtn');
            const expandBtn = document.getElementById('expandCodeBtn');
            
            // 确保初始状态是展开的
            panel.classList.remove('collapsed');
            floatingBtn.innerHTML = '&lt;/&gt;';
            toggleBtn.style.display = 'inline-block';
            expandBtn.style.display = 'none';
            
            // 绑定代码预览相关事件
            document.getElementById('copyCodeBtn').addEventListener('click', () => {
                const htmlCode = document.getElementById('htmlCode').textContent;
                navigator.clipboard.writeText(htmlCode).then(() => {
                    alert('代码已复制到剪贴板');
                });
            });
            
            document.getElementById('toggleCodeBtn').addEventListener('click', toggleCodePreview);
            document.getElementById('expandCodeBtn').addEventListener('click', toggleCodePreview);
            
            // 自动更新代码预览
            setInterval(() => {
                designer.updateCodePreview();
            }, 500);
        });
    </script>
</body>
</html>