<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>libuiBuilder 简化设计器</title>
    
    <!-- 复用现有样式 -->
    <link rel="stylesheet" href="libui-ng-complete.css">
    <link rel="stylesheet" href="designer.css">
    
    <style>
        /* 简化设计器样式 */
        .simple-designer {
            height: calc(100vh - 60px);
            display: flex;
        }
        
        /* 统一组件面板中所有组件卡片的宽度 */
        .components-panel .component-item {
            width: 100% !important;
            text-align: center !important;
            cursor: grab !important;
            padding: 8px !important;
            border: 1px solid #e9ecef !important;
            border-radius: 4px !important;
            background: white !important;
            transition: all 0.2s !important;
        }
        
        /* 确保输入控件的预览内容宽度一致 */
        .components-panel .component-preview input,
        .components-panel .component-preview select,
        .components-panel .component-preview textarea {
            max-width: 80px !important;
            width: 80px !important;
            box-sizing: border-box !important;
        }
        
        /* 特殊处理spinbox和slider的宽度 */
        .components-panel .ui-spinbox,
        .components-panel .ui-slider {
            max-width: 80px !important;
            width: 80px !important;
            box-sizing: border-box !important;
        }
        
        .components-panel .ui-spinbox input,
        .components-panel .ui-slider input {
            max-width: 44px !important;
            width: 44px !important;
        }

        .components-panel .component-preview input[type=checkbox] {
            width: 26px !important;
        }

        .components-panel .component-preview input[type=radio] {
            width: 26px !important;
        }
        
        /* 选项和标签页管理样式 */
        .options-list, .tabs-list {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            background: #f8f9fa;
            width: 70%;
            box-sizing: border-box;
        }
        
        .option-item, .tab-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }
        
        .option-item.active, .tab-item.active {
            background: #e3f2fd;
            border-radius: 4px;
            padding: 2px;
        }
        
        .option-input, .tab-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 2px;
            font-size: 12px;
            min-width: 0; /* 防止flex子项溢出 */
        }
        
        .option-remove, .tab-remove, .tab-activate {
            padding: 4px 8px;
            border: none;
            border-radius: 2px;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0; /* 防止按钮被压缩 */
        }
        
        .option-remove, .tab-remove {
            background: #dc3545;
            color: white;
        }
        
        .option-remove:hover, .tab-remove:hover {
            background: #c82333;
        }
        
        .tab-activate {
            background: #28a745;
            color: white;
            width: 45px;
        }
        
        .tab-activate:hover:not(:disabled) {
            background: #218838;
        }
        
        .tab-activate:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .option-add, .tab-add {
            width: 100%;
            padding: 6px;
            margin-top: 4px;
            border: 1px dashed #0078d4;
            background: transparent;
            color: #0078d4;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .option-add:hover, .tab-add:hover {
            background: rgba(0, 120, 212, 0.1);
        }
        
        /* HTML风格选择器样式 */
        .html-style-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 20px;
        }
        
        .html-style-selector label {
            font-size: 12px;
            color: #6c757d;
            white-space: nowrap;
        }
        
        .style-select {
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
            background: white;
            cursor: pointer;
        }
        
        .style-select:focus {
            outline: none;
            border-color: #0078d4;
        }
        
        /* 属性面板保存按钮样式 */
        #savePropertiesBtn {
            width: 100% !important;
            padding: 10px !important;
            margin-top: 10px !important;
            background: #28a745 !important;
            border: none !important;
            border-radius: 4px !important;
            color: white !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.2s !important;
        }
        
        #savePropertiesBtn:hover {
            background: #218838 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
        }
        
        #savePropertiesBtn:active {
            transform: translateY(0) !important;
            box-shadow: none !important;
        }
        
        .designer-canvas {
            flex: 1;
            background: #fafafa;
            position: relative;
            overflow: auto;
        }
        
        .designer-properties {
            width: 300px;
            background: white;
            border-left: 1px solid #dee2e6;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* 组件元素 */
        .component-element {
            position: absolute;
            cursor: move;
            border: 1px solid transparent;
            transition: border-color 0.2s;
        }
        
        .component-element:hover {
            border-color: #0078d4;
        }
        
        .component-element.selected {
            border-color: #0078d4;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }
        
        .component-element.drag-target {
            border-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.3);
        }
        
        
        
        .component-controls {
            position: absolute;
            top: -30px;
            right: 0;
            display: none;
            gap: 4px;
        }
        
        .component-controls {
            position: absolute;
            top: -30px;
            right: 0;
            display: none; /* 默认隐藏 */
            gap: 4px;
            z-index: 1001 !important; /* 确保控制按钮始终在顶层 */
        }
        
        /* 当前选中的组件显示删除按钮 */
        .component-element.selected .component-controls {
            display: flex;
        }
        
        .component-element {
            position: relative;
        }
        
        .control-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: #0078d4;
            color: white;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            position: relative;
            z-index: 1001;
        }
        
        .control-btn:hover {
            background: #005a9e;
        }
        
        .control-btn.delete {
            background: #dc3545;
        }
        
        .control-btn.delete:hover {
            background: #c82333;
        }
        
        /* 代码预览 */
        .code-preview {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            transition: transform 0.3s ease;
            border-top: 1px solid #333;
        }
        
        .code-preview.collapsed {
            height: 40px; /* 只显示标题栏高度 */
        }
        
        .code-preview.collapsed .preview-content {
            display: none; /* 隐藏内容区域 */
        }
        
        .code-preview.collapsed .toggle-code-btn {
            display: inline-block; /* 显示展开按钮 */
        }
        
        .code-preview:not(.collapsed) .toggle-code-btn {
            display: none; /* 隐藏展开按钮 */
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            cursor: pointer;
        }
        
        .preview-header h4 {
            margin: 0;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }
        
        .preview-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #0078d4;
            background: #0078d4;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-small:hover {
            background: #005a9e;
        }
        
        .preview-content {
            padding: 16px;
            height: calc(100% - 40px);
            overflow-y: auto;
        }
        
        .preview-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #d4d4d4;
        }
        
        .preview-content code {
            font-family: 'Monaco', 'Menlo', 'Consolas', 'Courier New', monospace;
        }
        
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            color: white;
            font-size: 22px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Consolas', monospace;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0,120,212,0.25), 0 2px 6px rgba(0,0,0,0.15);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            line-height: 1;
            padding: 0;
            margin: 0;
            text-align: center;
            font-weight: 700;
            letter-spacing: -0.5px;
            /* 确保图标完美居中 */
            text-indent: 0;
            /* 添加微妙的内边距确保视觉居中 */
            padding: 0 2px;
        }
        
        .floating-btn:hover {
            background: linear-gradient(135deg, #106ebe 0%, #004a8c 100%);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,120,212,0.35), 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .floating-btn:active {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 15px rgba(0,120,212,0.3), 0 2px 6px rgba(0,0,0,0.15);
        }
        
        /* 添加发光效果 */
        .floating-btn::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .floating-btn:hover::before {
            opacity: 1;
        }
        
        .property-group {
            margin-bottom: 20px;
        }
        
        .property-group h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #495057;
        }
        
        .property-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .property-label {
            width: 100px;
            font-size: 13px;
            color: #6c757d;
        }
        
        .property-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .property-input:focus {
            outline: none;
            border-color: #0078d4;
        }
        
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            font-size: 14px;
        }
        
        /* 表格列类型管理样式 */
        .column-types-list {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            background: #f8f9fa;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .column-type-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 4px;
            background: white;
            border-radius: 2px;
        }
        
        .column-name {
            font-size: 12px;
            color: #495057;
            min-width: 60px;
        }
        
        .column-type-select {
            flex: 1;
            padding: 2px 4px;
            border: 1px solid #dee2e6;
            border-radius: 2px;
            font-size: 11px;
            margin-left: 8px;
        }
        
        /* 表格数据管理样式 */
        .table-data-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #dee2e6;
            padding: 4px;
            text-align: center;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .cell-input {
            width: 100%;
            border: none;
            padding: 2px;
            font-size: 11px;
            text-align: center;
            box-sizing: border-box;
        }
        
        .cell-input:focus {
            outline: 1px solid #0078d4;
            background: #f0f8ff;
        }
        
        .row-remove {
            padding: 2px 6px;
            border: none;
            border-radius: 2px;
            background: #dc3545;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        
        .row-remove:hover {
            background: #c82333;
        }
        
        .add-row-btn {
            width: 100%;
            padding: 6px;
            margin-top: 4px;
            border: 1px dashed #0078d4;
            background: transparent;
            color: #0078d4;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .add-row-btn:hover {
            background: rgba(0, 120, 212, 0.1);
        }
    </style>
</head>
<body class="windows">
    <!-- 顶部工具栏 -->
    <header class="designer-header">
        <div class="header-left">
            <h1 class="app-title">libuiBuilder 简化设计器</h1>
            <div class="platform-selector">
                <button class="platform-btn active" data-platform="windows">Windows</button>
                <button class="platform-btn" data-platform="macos">macOS</button>
                <button class="platform-btn" data-platform="linux">Linux</button>
            </div>
            <div class="html-style-selector">
                <label for="htmlStyleSelect">HTML风格:</label>
                <select id="htmlStyleSelect" class="style-select">
                    <option value="gui">GUI标签</option>
                    <option value="html">类HTML标签</option>
                </select>
            </div>
        </div>
        <div class="header-right">
            <button class="btn btn-primary" id="saveBtn">保存</button>
            <button class="btn btn-secondary" id="exportBtn">导出 HTML</button>
            <button class="btn btn-secondary" id="previewBtn">预览</button>
            <button class="btn btn-secondary" id="clearBtn">清空</button>
        </div>
    </header>

    <!-- 主设计区域 -->
    <main class="simple-designer">
        <!-- 左侧组件面板 -->
        <aside class="components-panel">
            <div class="panel-header">
                <h3>组件库</h3>
            </div>
            <div class="panel-content">
                <!-- 容器组件 -->
                <div class="component-category">
                    <h4>容器组件</h4>
                    <div class="component-list">
                        <div class="component-item" draggable="true" data-component="window">
                            <div class="component-preview window-preview">
                                <span>窗口</span>
                            </div>
                            <span class="component-name">Window</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="grid">
                            <div class="component-preview grid-preview">
                                <span>网格</span>
                            </div>
                            <span class="component-name">Grid</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="hbox">
                            <div class="component-preview hbox-preview">
                                <span>水平盒子</span>
                            </div>
                            <span class="component-name">HBox</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="vbox">
                            <div class="component-preview vbox-preview">
                                <span>垂直盒子</span>
                            </div>
                            <span class="component-name">VBox</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="form">
                            <div class="component-preview form-preview">
                                <span>表单</span>
                            </div>
                            <span class="component-name">Form</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="tab">
                            <div class="component-preview tab-preview">
                                <span>标签页</span>
                            </div>
                            <span class="component-name">Tab</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="group">
                            <div class="component-preview group-preview">
                                <fieldset style="border: 1px solid #ccc; border-radius: 4px; padding: 4px; min-width: 60px; min-height: 40px;">
                                    <legend style="font-size: 11px; padding: 0 4px;">分组</legend>
                                </fieldset>
                            </div>
                            <span class="component-name">Group</span>
                        </div>
                    </div>
                </div>

                <!-- 输入控件 -->
                <div class="component-category">
                    <h4>输入控件</h4>
                    <div class="component-list">
                        <div class="component-item" draggable="true" data-component="input">
                            <div class="component-preview input-preview">
                                <input type="text" placeholder="输入框" readonly>
                            </div>
                            <span class="component-name">Input</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="textarea">
                            <div class="component-preview textarea-preview">
                                <textarea placeholder="多行输入" readonly></textarea>
                            </div>
                            <span class="component-name">Textarea</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="password">
                            <div class="component-preview password-preview">
                                <input type="password" placeholder="密码" readonly>
                            </div>
                            <span class="component-name">Password</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="combobox">
                            <div class="component-preview combobox-preview">
                                <select>
                                    <option>下拉框</option>
                                </select>
                            </div>
                            <span class="component-name">Combobox</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="spinbox">
                            <div class="component-preview spinbox-preview">
                                <div class="ui-spinbox">
                                    <input type="number" value="0" readonly>
                                    <button disabled>-</button>
                                    <button disabled>+</button>
                                </div>
                            </div>
                            <span class="component-name">Spinbox</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="slider">
                            <div class="component-preview slider-preview">
                                <div class="ui-slider">
                                    <input type="range" value="50" readonly>
                                    <span>50</span>
                                </div>
                            </div>
                            <span class="component-name">Slider</span>
                        </div>
                    </div>
                </div>

                <!-- 按钮控件 -->
                <div class="component-category">
                    <h4>按钮控件</h4>
                    <div class="component-list">
                        <div class="component-item" draggable="true" data-component="button">
                            <div class="component-preview button-preview">
                                <button>按钮</button>
                            </div>
                            <span class="component-name">Button</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="checkbox">
                            <div class="component-preview checkbox-preview">
                                <label class="ui-checkbox">
                                    <input type="checkbox" disabled>
                                    <span>复选框</span>
                                </label>
                            </div>
                            <span class="component-name">Checkbox</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="radio">
                            <div class="component-preview radio-preview">
                                <div class="ui-radio-buttons">
                                    <label>
                                        <input type="radio" name="preview" disabled>
                                        <span>单选框</span>
                                    </label>
                                </div>
                            </div>
                            <span class="component-name">Radio</span>
                        </div>
                    </div>
                </div>

                <!-- 显示控件 -->
                <div class="component-category">
                    <h4>显示控件</h4>
                    <div class="component-list">
                        <div class="component-item" draggable="true" data-component="label">
                            <div class="component-preview label-preview">
                                <span>标签文本</span>
                            </div>
                            <span class="component-name">Label</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="progressbar">
                            <div class="component-preview progressbar-preview">
                                <div class="ui-progress-bar">
                                    <div class="fill" style="width: 60%;"></div>
                                </div>
                            </div>
                            <span class="component-name">ProgressBar</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="separator">
                            <div class="component-preview separator-preview">
                                <hr class="ui-separator horizontal">
                            </div>
                            <span class="component-name">Separator</span>
                        </div>
                        <div class="component-item" draggable="true" data-component="table">
                            <div class="component-preview table-preview">
                                <table class="mini-table">
                                    <tr>
                                        <th>列1</th>
                                        <th>列2</th>
                                    </tr>
                                    <tr>
                                        <td>数据1</td>
                                        <td>数据2</td>
                                    </tr>
                                </table>
                            </div>
                            <span class="component-name">Table</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 设计画布 -->
        <div class="designer-canvas" id="designCanvas">
            <div class="empty-state" id="emptyState">
                拖拽组件到这里开始设计
            </div>
        </div>

        <!-- 属性面板 -->
        <div class="designer-properties" id="propertiesPanel">
            <div class="empty-state">
                选择一个组件来编辑属性
            </div>
        </div>
    </main>

    <!-- 底部代码预览 -->
    <footer class="code-preview">
        <div class="preview-header">
            <h4>HTML 代码预览</h4>
            <div class="preview-actions">
                <button class="btn btn-small" id="copyCodeBtn">复制代码</button>
                <button class="btn btn-small toggle-code-btn" id="expandCodeBtn" style="display: none;">展开</button>
                <button class="btn btn-small" id="toggleCodeBtn">收起</button>
            </div>
        </div>
        <div class="preview-content" id="codePreview">
            <pre><code id="htmlCode"><!-- 拖拽组件后将在此处生成 HTML 代码 --></code></pre>
        </div>
    </footer>

    <!-- 浮动按钮 -->
    <button class="floating-btn" onclick="toggleCodePreview()" title="显示/隐藏代码预览" id="floatingToggleBtn">
        &lt;/&gt;
    </button>

    <script>
        class SimpleLibuiDesigner {
            constructor() {
                this.components = [];
                this.selectedComponent = null;
                this.componentIdCounter = 0;
                this.draggedComponent = null;
                this.htmlGenerationStyle = 'gui'; // 'gui' 或 'html'
                this.updateCodePreviewTimeout = null; // 防抖定时器
                this.updatingProperties = false; // 防止属性更新循环
                this.init();
            }
            
            // 生成简化的拉伸选项HTML
            getStretchyOptions(currentValue) {
                const isStretched = currentValue !== 'false';
                return `
                    <select class="property-input" data-prop="stretchy">
                        <option value="false" ${!isStretched ? 'selected' : ''}>不拉伸</option>
                        <option value="true" ${isStretched ? 'selected' : ''}>拉伸</option>
                    </select>
                `;
            }

            init() {
                this.setupEventListeners();
                this.setupDragAndDrop();
                this.updateCodePreview();
            }

            setupEventListeners() {
                // 平台切换
                document.querySelectorAll('.platform-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.platform-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        document.body.className = e.target.dataset.platform;
                    });
                });

                // 工具栏按钮
                document.getElementById('saveBtn').addEventListener('click', () => this.save());
                document.getElementById('exportBtn').addEventListener('click', () => this.export());
                document.getElementById('previewBtn').addEventListener('click', () => this.preview());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearAll());
                
                // HTML生成风格选择器
                const styleSelect = document.getElementById('htmlStyleSelect');
                if (styleSelect) {
                    styleSelect.addEventListener('change', (e) => {
                        this.htmlGenerationStyle = e.target.value;
                        this.updateCodePreview();
                    });
                }
            }

            setupDragAndDrop() {
                // 组件拖拽开始
                document.querySelectorAll('.component-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        this.draggedComponent = e.target.dataset.component;
                        e.dataTransfer.effectAllowed = 'copy';
                        e.target.style.opacity = '0.5';
                    });

                    item.addEventListener('dragend', (e) => {
                        e.target.style.opacity = '1';
                        this.draggedComponent = null;
                    });
                });

                // 画布拖拽事件
                const canvas = document.getElementById('designCanvas');

                canvas.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    
                    // 检查是否悬停在容器组件上
                    const targetComponent = this.getComponentAtPosition(e.clientX, e.clientY);
                    if (targetComponent && this.isContainerComponent(targetComponent.type)) {
                        this.highlightContainer(targetComponent);
                    } else {
                        canvas.classList.add('drag-over');
                        this.clearContainerHighlights();
                    }
                });

                canvas.addEventListener('dragleave', (e) => {
                    if (e.target === canvas) {
                        canvas.classList.remove('drag-over');
                        this.clearContainerHighlights();
                    }
                });

                canvas.addEventListener('drop', (e) => {
                    e.preventDefault();
                    canvas.classList.remove('drag-over');
                    this.clearContainerHighlights();

                    if (this.draggedComponent) {
                        const rect = canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        // 检查是否拖拽到容器组件上
                        const targetComponent = this.getComponentAtPosition(e.clientX, e.clientY);
                        if (targetComponent && this.isContainerComponent(targetComponent.type)) {
                            this.addComponentToContainer(this.draggedComponent, targetComponent, x, y);
                        } else {
                            // 检查是否需要自动创建容器
                            const hasWindow = this.components.some(c => c.type === 'window');
                            
                            if (!hasWindow) {
                                // 画布上没有Window，需要创建Window和可能的HBox
                                let windowComponent = {
                                    id: `component_${++this.componentIdCounter}`,
                                    type: 'window',
                                    x: 0,
                                    y: 0,
                                    props: this.getDefaultProps('window'),
                                    children: []
                                };
                                
                                // 居中Window
                                let width = 400;
                                let height = 300;
                                if (windowComponent.props.size) {
                                    const [w, h] = windowComponent.props.size.split(',').map(s => parseInt(s.trim()));
                                    if (!isNaN(w)) width = w;
                                    if (!isNaN(h)) height = h;
                                }
                                
                                windowComponent.x = Math.max(50, (rect.width - width) / 2);
                                windowComponent.y = Math.max(50, (rect.height - height) / 2);
                                
                                this.components.push(windowComponent);
                                this.renderComponent(windowComponent);
                                this.hideEmptyState();
                                
                                let targetContainer = windowComponent;
                                
                                // 如果拖拽的是控件组件（非容器），在Window中创建HBox
                                if (this.isControlComponent(this.draggedComponent)) {
                                    const hboxComponent = {
                                        id: `component_${++this.componentIdCounter}`,
                                        type: 'hbox',
                                        x: 0,
                                        y: 0,
                                        props: { ...this.getDefaultProps('hbox'), padded: 'true' },
                                        children: [],
                                        parent: windowComponent.id
                                    };
                                    
                                    windowComponent.children.push(hboxComponent);
                                    this.renderComponent(hboxComponent, windowComponent);
                                    targetContainer = hboxComponent;
                                }
                                
                                // 将拖拽的组件添加到目标容器中
                                this.addComponentToContainer(this.draggedComponent, targetContainer, x, y);
                                
                            } else {
                                // 画布上已有Window，检查拖拽目标
                                const targetComponent = this.getComponentAtPosition(e.clientX, e.clientY);
                                
                                if (targetComponent && this.isContainerComponent(targetComponent.type)) {
                                    // 拖拽到容器上，直接添加
                                    this.addComponentToContainer(this.draggedComponent, targetComponent, x, y);
                                } else if (this.isControlComponent(this.draggedComponent)) {
                                    // 拖拽的是控件但没有拖到容器上，找到第一个Window并在其中创建HBox
                                    const windowComponent = this.components.find(c => c.type === 'window');
                                    if (windowComponent) {
                                        const hboxComponent = {
                                            id: `component_${++this.componentIdCounter}`,
                                            type: 'hbox',
                                            x: 0,
                                            y: 0,
                                            props: { ...this.getDefaultProps('hbox'), padded: 'true' },
                                            children: [],
                                            parent: windowComponent.id
                                        };
                                        
                                        windowComponent.children.push(hboxComponent);
                                        this.renderComponent(hboxComponent, windowComponent);
                                        
                                        // 将控件添加到新创建的HBox中
                                        this.addComponentToContainer(this.draggedComponent, hboxComponent, x, y);
                                    }
                                } else {
                                    // 拖拽的是容器组件，直接添加到画布
                                    this.addComponent(this.draggedComponent, x, y);
                                }
                            }
                        }
                    }
                });
            }

            addComponent(type, x, y) {
                const component = {
                    id: `component_${++this.componentIdCounter}`,
                    type: type,
                    x: x,
                    y: y,
                    props: this.getDefaultProps(type),
                    children: []
                };

                // 如果是窗口组件，自动居中
                if (type === 'window') {
                    const canvas = document.getElementById('designCanvas');
                    const canvasRect = canvas.getBoundingClientRect();
                    
                    let width = 400;
                    let height = 300;
                    if (component.props.size) {
                        const [w, h] = component.props.size.split(',').map(s => parseInt(s.trim()));
                        if (!isNaN(w)) width = w;
                        if (!isNaN(h)) height = h;
                    }
                    
                    component.x = Math.max(50, (canvasRect.width - width) / 2);
                    component.y = Math.max(50, (canvasRect.height - height) / 2);
                }

                this.components.push(component);
                this.renderComponent(component);
                this.updateCodePreview();
                this.hideEmptyState();
            }

            getDefaultProps(type) {
                const defaults = {
                    window: {
                        title: '窗口',
                        size: '800,600',
                        centered: 'true',
                        margined: 'true'
                    },
                    hbox: {
                        padded: 'false'
                    },
                    vbox: {
                        padded: 'false'
                    },
                    form: {
                        padded: 'true'
                    },
                    grid: {
                        padded: 'true'
                    },
                    tab: {
                        padded: 'true',
                        tabs: '标签页1,标签页2',
                        activeTab: '0'
                    },
                    input: {
                        placeholder: '请输入文本',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    textarea: {
                        placeholder: '请输入多行文本',
                        rows: '3',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    password: {
                        placeholder: '请输入密码',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    combobox: {
                        selected: '0',
                        options: '选项 1,选项 2,选项 3',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    spinbox: {
                        min: '0',
                        max: '100',
                        value: '0',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    slider: {
                        min: '0',
                        max: '100',
                        value: '50',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    button: {
                        text: '按钮',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    checkbox: {
                        text: '复选框',
                        checked: 'false',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    radio: {
                        text: '单选框',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    label: {
                        text: '标签文本',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    progressbar: {
                        value: '60',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    separator: {
                        orientation: 'horizontal',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    table: {
                        columns: '列1,列2',
                        data: '数据1,数据2',
                        stretchy: 'true',
                        // Grid布局属性
                        row: '0',
                        col: '0',
                        align: 'fill',
                        rowspan: '1',
                        colspan: '1'
                    },
                    group: {
                        title: '分组',
                        margined: 'true'
                    }
                };

                return defaults[type] || {};
            }

            renderComponent(component, parentComponent = null) {
                let targetElement;
                
                if (parentComponent) {
                    // 渲染到父容器中
                    const parentEl = document.querySelector(`[data-component-id="${parentComponent.id}"]`);
                    if (parentEl) {
                        // 特殊处理Tab组件：需要将子组件渲染到正确的标签页中
                        if (parentComponent.type === 'tab') {
                            // 获取子组件应该属于哪个标签页
                            const tabIndex = parseInt(component.props.tabIndex || '0');
                            const tabPage = parentEl.querySelector(`.tabpage[data-tabpage-index="${tabIndex}"]`);
                            if (tabPage) {
                                targetElement = tabPage;
                            } else {
                                // 如果找不到对应的标签页，使用第一个标签页
                                const firstTabPage = parentEl.querySelector('.tabpage');
                                if (firstTabPage) {
                                    targetElement = firstTabPage;
                                }
                            }
                        } else {
                            // 非Tab组件，使用原来的逻辑
                            targetElement = parentEl.querySelector('.window-content') || 
                                          parentEl.querySelector('.ui-box') || 
                                          parentEl.querySelector('.ui-form') || 
                                          parentEl.querySelector('.ui-grid') || 
                                          parentEl.querySelector('.ui-tab') ||
                                          parentEl.querySelector('.group-content') ||
                                          parentEl.querySelector('.component-content');
                        }
                    }
                } else {
                    // 渲染到画布中
                    targetElement = document.getElementById('designCanvas');
                }
                
                if (!targetElement) {
                    console.warn('无法找到目标元素', component, parentComponent);
                    return;
                }
                
                // 检查组件是否已经存在于DOM中，如果是则先移除
                const existingElement = document.querySelector(`[data-component-id="${component.id}"]`);
                if (existingElement) {
                    existingElement.remove();
                }
                
                const element = this.createComponentElement(component);
                
                // 设置子组件的样式
                if (parentComponent) {
                    // 子组件使用相对定位，不使用绝对定位
                    element.style.position = 'relative';
                    element.style.margin = '2px';
                    element.style.display = 'block';
                    element.style.border = '1px solid #ddd';
                    element.style.borderRadius = '4px';
                    element.style.padding = '4px';
                    element.style.background = 'white';
                    element.style.zIndex = '20';
                    element.style.minWidth = '0';
                    element.style.maxWidth = '100%';
                    element.style.boxSizing = 'border-box';
                    
                    // 根据父容器类型设置flex属性
                    if (parentComponent.type === 'hbox') {
                        element.style.display = 'inline-block';
                        element.style.verticalAlign = 'top';
                        // 处理HBox中的拉伸属性
                        if (component.props.stretchy === 'true') {
                            element.style.flex = '1';
                            element.style.minWidth = '0';
                            element.style.display = 'block';
                        }
                    } else if (parentComponent.type === 'vbox') {
                        element.style.display = 'block';
                        // 处理VBox中的拉伸属性
                        if (component.props.stretchy === 'true') {
                            element.style.flex = '1';
                            element.style.minWidth = '0';
                            element.style.minHeight = '0';
                        }
                    } else if (parentComponent.type === 'box') {
                        element.style.display = 'block';
                    } else if (parentComponent.type === 'box') {
                        element.style.display = 'inline-block';
                        element.style.verticalAlign = 'top';
                    } else if (parentComponent.type === 'form') {
                        element.style.display = 'block';
                        element.style.marginBottom = '8px';
                    } else if (parentComponent.type === 'grid') {
                        // Grid容器的子组件使用Grid布局属性
                        element.style.position = 'relative'; // Grid项也需要相对定位
                        
                        // 设置Grid布局属性
                        const row = parseInt(component.props.row || '0');
                        const col = parseInt(component.props.col || '0');
                        const rowspan = parseInt(component.props.rowspan || '1');
                        const colspan = parseInt(component.props.colspan || '1');
                        
                        // 使用 grid-area 简化设置，确保格式正确
                        element.style.gridArea = `${row + 1} / ${col + 1} / span ${rowspan} / span ${colspan}`;
                        
                        // 根据align属性设置对齐方式
                        const align = component.props.align || 'fill';
                        switch (align) {
                            case 'fill':
                                element.style.alignSelf = 'stretch';
                                element.style.justifySelf = 'stretch';
                                break;
                            case 'start':
                                element.style.alignSelf = 'start';
                                element.style.justifySelf = 'start';
                                break;
                            case 'center':
                                element.style.alignSelf = 'center';
                                element.style.justifySelf = 'center';
                                break;
                            case 'end':
                                element.style.alignSelf = 'end';
                                element.style.justifySelf = 'end';
                                break;
                            default:
                                element.style.alignSelf = 'stretch';
                                element.style.justifySelf = 'stretch';
                        }
                        
                        // 当组件跨多列时，确保占据整行
                        if (colspan > 1) {
                            element.style.display = 'block';
                            element.style.width = '100%';
                        }
                    } else if (parentComponent.type === 'tab') {
                        // Tab组件中的子组件样式
                        element.style.display = 'block';
                        element.style.marginBottom = '4px';
                    }
                    
                    // 确保控制按钮在最上层
                    const controls = element.querySelector('.component-controls');
                    if (controls) {
                        controls.style.zIndex = '1001';
                    }
                }
                
                // 确保组件元素可以接收鼠标事件（即使在容器内部）
                element.style.pointerEvents = 'auto';
                
                // 确保组件的容器元素有适当的边距以接收鼠标事件
                if (!element.style.margin || element.style.margin === '0px' || element.style.margin === '0') {
                    // 如果没有设置边距，确保组件容器元素可以接收事件
                    element.style.outline = 'none'; // 避免显示轮廓
                }
                
                targetElement.appendChild(element);
                
                // 更新容器占位符
                if (parentComponent) {
                    this.updateContainerPlaceholder(parentComponent);
                }
            }

            createComponentElement(component) {
                const div = document.createElement('div');
                div.className = 'component-element';
                div.dataset.componentId = component.id;
                div.dataset.componentType = component.type;
                
                // 只有根级别组件才使用绝对定位
                if (!component.parent) {
                    div.style.position = 'absolute';
                    div.style.left = component.x + 'px';
                    div.style.top = component.y + 'px';
                } else {
                    // 子组件使用相对定位
                    div.style.position = 'relative';
                    div.style.margin = '2px';
                    div.style.display = 'block';
                    div.style.border = '1px solid #ddd';
                    div.style.borderRadius = '4px';
                    div.style.padding = '4px';
                    div.style.background = 'white';
                    div.style.zIndex = '20';
                    div.style.minWidth = '0';
                    div.style.maxWidth = '100%';
                    div.style.boxSizing = 'border-box';
                }

                // 创建组件内容
                const content = this.createComponentContent(component);
                div.appendChild(content);

                // 创建控制按钮
                const controls = this.createComponentControls(component);
                div.appendChild(controls);
                
                // 确保控制按钮总是处于顶层
                const updateControlsZIndex = () => {
                    const controls = div.querySelector('.component-controls');
                    if (controls) {
                        controls.style.zIndex = '1001';
                    }
                };
                
                // 首次设置
                updateControlsZIndex();
                
                // 监听组件的属性变化来更新z-index
                setTimeout(updateControlsZIndex, 0);

                // 添加事件监听
                div.addEventListener('click', (e) => {
                    // 如果点击的不是控制按钮，则选中组件
                    if (!e.target.closest('.component-controls')) {
                        e.stopPropagation();
                        this.selectComponent(component);
                    }
                });
                
                // 鼠标悬停显示控制按钮，鼠标离开隐藏（除非组件被选中）
                div.addEventListener('mouseenter', (e) => {
                    // 只在组件未被选中时显示控制按钮
                    if (!div.classList.contains('selected')) {
                        const controls = div.querySelector('.component-controls');
                        if (controls) {
                            controls.style.display = 'flex';
                        }
                    }
                });
                
                div.addEventListener('mouseleave', (e) => {
                    // 检查鼠标是否移动到了子元素上，如果是，则不隐藏控制按钮
                    // 只有真正离开组件区域时才隐藏
                    setTimeout(() => {
                        if (!div.matches(':hover')) {
                            // 只在组件未被选中时隐藏控制按钮
                            if (!div.classList.contains('selected')) {
                                const controls = div.querySelector('.component-controls');
                                if (controls) {
                                    controls.style.display = 'none';
                                }
                            }
                        }
                    }, 10); // 延迟检查，避免因快速移动导致的问题
                });

                // 对于容器组件，确保内容区域也能触发父组件的mouseenter/mouseleave事件
                if (this.isContainerComponent(component.type)) {
                    // 使用setTimeout确保内容元素已添加到DOM中
                    setTimeout(() => {
                        const contentElement = div.querySelector('.component-content');
                        if (contentElement) {
                            // 监听内容区域的mouseenter事件并冒泡到父组件
                            contentElement.addEventListener('mouseenter', (e) => {
                                if (!div.classList.contains('selected')) {
                                    const controls = div.querySelector('.component-controls');
                                    if (controls) {
                                        controls.style.display = 'flex';
                                    }
                                }
                            });
                            
                            // 监听内容区域的mouseleave事件，并检查是否移出了整个组件
                            contentElement.addEventListener('mouseleave', (e) => {
                                // 使用setTimeout来检查组件是否仍处于hover状态
                                setTimeout(() => {
                                    if (!div.matches(':hover')) {
                                        if (!div.classList.contains('selected')) {
                                            const controls = div.querySelector('.component-controls');
                                            if (controls) {
                                                controls.style.display = 'none';
                                            }
                                        }
                                    }
                                }, 10);
                            });
                        }
                    }, 0);
                }

                return div;
            }

            createComponentContent(component) {
                const content = document.createElement('div');
                content.className = 'component-content';

                switch (component.type) {
                    case 'window':
                        let width = 400;
                        let height = 300;
                        if (component.props.size) {
                            const [w, h] = component.props.size.split(',').map(s => parseInt(s.trim()));
                            if (!isNaN(w)) width = w;
                            if (!isNaN(h)) height = h;
                        }

                        const padding = component.props.margined === 'true' ? '16px' : '8px';

                        content.innerHTML = `
                            <div class="ui-window" style="width: ${width}px; height: ${height}px; border: 1px solid #ccc; background: white; max-width: 100%; overflow: hidden; position: relative;">
                                <div style="padding: 8px; border-bottom: 1px solid #ccc; background: #f8f9fa;">
                                    ${component.props.title || '窗口'}
                                </div>
                                <div style="padding: ${padding}; min-height: ${height - 60}px; width: 100%; box-sizing: border-box;" class="window-content">
                                    窗口内容区域
                                </div>
                            </div>
                        `;
                        break;

                    case 'hbox':
                            let hboxPadding = component.props.padded === 'true' ? '8px' : '0px';
                            content.innerHTML = `
                                <div class="ui-box horizontal" style="min-width: 200px; min-height: 60px; border: 2px dashed #0078d4; background: rgba(0, 120, 212, 0.05); display: flex; gap: 8px; padding: ${hboxPadding}; align-items: center; width: 100%; position: relative; box-sizing: border-box;">
                                    HBox 容器
                                </div>
                            `;
                        break;

                    case 'vbox':
                        const vboxPadding = component.props.padded === 'true' ? '8px' : '0px';
                        content.innerHTML = `
                            <div class="ui-box vertical" style="min-width: 200px; min-height: 120px; border: 2px dashed #0078d4; background: rgba(0, 120, 212, 0.05); display: flex; flex-direction: column; gap: 8px; padding: ${vboxPadding}; width: 100%; position: relative; box-sizing: border-box;">
                                    VBox 容器
                                </div>
                            `;
                        break;

                    case 'form':
                        const formPadding = component.props.padded === 'true' ? '16px' : '8px';
                        content.innerHTML = `
                            <div class="ui-form" style="min-width: 300px; min-height: 200px; border: 2px dashed #0078d4; background: rgba(0, 120, 212, 0.05); padding: ${formPadding}; width: 100%; position: relative; box-sizing: border-box;">
                                Form 容器
                            </div>
                        `;
                        break;

                    case 'grid':
                        const gridPadding = component.props.padded === 'true' ? '8px' : '0px';
                        content.innerHTML = `
                            <div class="ui-grid" style="min-width: 200px; min-height: 150px; border: 2px dashed #0078d4; background: rgba(0, 120, 212, 0.05); display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); gap: 8px; padding: ${gridPadding}; width: 100%; position: relative; box-sizing: border-box;">
                            </div>
                        `;
                        break;

                    case 'tab':
                        const tabPadding = component.props.padded === 'true' ? '8px' : '0px';
                        const tabs = component.props.tabs ? component.props.tabs.split(',') : ['标签页1', '标签页2'];
                        const activeTab = parseInt(component.props.activeTab || '0');
                        
                        // 创建标签页按钮HTML
                        let tabButtonsHTML = '';
                        tabs.forEach((tab, index) => {
                            const isActive = index === activeTab;
                            const buttonStyle = isActive 
                                ? 'padding: 4px 8px; border: none; background: #f8f9fa; border-bottom: 2px solid #0078d4; margin-right: 2px; cursor: pointer;'
                                : 'padding: 4px 8px; border: none; background: #f8f9fa; margin-right: 2px; cursor: pointer;';
                            tabButtonsHTML += `<button class="tab-button" data-tab-index="${index}" style="${buttonStyle}">${tab}</button>`;
                        });
                        
                        // 创建标签页内容HTML
                        let tabPagesHTML = '';
                        tabs.forEach((tab, index) => {
                            const isActive = index === activeTab;
                            const displayStyle = isActive ? 'block' : 'none';
                            tabPagesHTML += `
                                <div class="tabpage" data-tabpage-index="${index}" title="${tab}" style="min-height: 150px; width: 100%; display: ${displayStyle}; position: relative; box-sizing: border-box;">
                                    <div class="tabpage-placeholder" style="color: #999; font-style: italic; padding: 8px; display: ${isActive ? 'block' : 'none'};">
                                        标签页内容
                                    </div>
                                </div>
                            `;
                        });
                        
                        content.innerHTML = `
                            <div class="ui-tab" style="min-width: 300px; min-height: 200px; border: 2px dashed #0078d4; background: rgba(0, 120, 212, 0.05); padding: ${tabPadding}; width: 100%; position: relative; box-sizing: border-box;">
                                <div class="tab-header" style="border-bottom: 1px solid #ccc; margin-bottom: 8px;">
                                    ${tabButtonsHTML}
                                </div>
                                <div class="tab-content">
                                    ${tabPagesHTML}
                                </div>
                            </div>
                        `;
                        break;

                    case 'input':
                        let inputStyle = 'width: 200px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;';
                        if (component.props.stretchy === 'true') {
                            inputStyle = 'flex: 1; min-width: 80px; max-width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;';
                        }
                        content.innerHTML = `
                            <input type="text" class="ui-entry" placeholder="${component.props.placeholder || '请输入文本'}" style="${inputStyle}">
                        `;
                        break;

                    case 'textarea':
                        let textareaStyle = 'width: 200px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;';
                        if (component.props.stretchy === 'true') {
                            textareaStyle = 'flex: 1; min-width: 80px; max-width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;';
                        }
                        content.innerHTML = `
                            <textarea class="ui-multiline-entry" placeholder="${component.props.placeholder || '请输入多行文本'}" rows="${component.props.rows || '3'}" style="${textareaStyle}"></textarea>
                        `;
                        break;

                    case 'password':
                        let passwordStyle = 'width: 200px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;';
                        if (component.props.stretchy === 'true') {
                            passwordStyle = 'flex: 1; min-width: 80px; max-width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;';
                        }
                        content.innerHTML = `
                            <input type="password" class="ui-entry" placeholder="${component.props.placeholder || '请输入密码'}" style="${passwordStyle}">
                        `;
                        break;

                    case 'combobox':
                        let comboboxStyle = 'width: 150px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;';
                        if (component.props.stretchy === 'true') {
                            comboboxStyle = 'flex: 1; min-width: 80px; max-width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;';
                        }
                        
                        const options = component.props.options ? component.props.options.split(',') : ['选项 1', '选项 2', '选项 3'];
                        const selected = component.props.selected || '0';
                        
                        content.innerHTML = `
                            <select class="ui-combobox" style="${comboboxStyle}">
                                ${options.map((option, index) => 
                                    `<option value="${index}" ${index == selected ? 'selected' : ''}>${option}</option>`
                                ).join('')}
                            </select>
                        `;
                        break;

                    case 'spinbox':
                        let spinboxStyle = 'width: 120px;';
                        if (component.props.stretchy === 'true') {
                            spinboxStyle = 'flex: 1; min-width: 80px; max-width: 100%;';
                        }
                        content.innerHTML = `
                            <div class="ui-spinbox" style="${spinboxStyle}">
                                <input type="number" value="${component.props.value || '0'}" min="${component.props.min || '0'}" max="${component.props.max || '100'}" readonly style="width: 100%; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                <button disabled>-</button>
                                <button disabled>+</button>
                            </div>
                        `;
                        break;

                    case 'slider':
                        let sliderStyle = 'width: 200px;';
                        if (component.props.stretchy === 'true') {
                            sliderStyle = 'flex: 1; min-width: 80px; max-width: 100%;';
                        }
                        content.innerHTML = `
                            <div class="ui-slider" style="${sliderStyle}">
                                <input type="range" value="${component.props.value || '50'}" min="${component.props.min || '0'}" max="${component.props.max || '100'}" readonly style="width: 100%;">
                                <span>${component.props.value || '50'}</span>
                            </div>
                        `;
                        break;

                    case 'button':
                        let buttonStyle = 'padding: 6px 16px; border: 1px solid #0078d4; background: #0078d4; color: white; border-radius: 4px; cursor: pointer;';
                        if (component.props.stretchy === 'true') {
                            buttonStyle = 'flex: 1; min-width: 80px; max-width: 100%; padding: 6px 16px; border: 1px solid #0078d4; background: #0078d4; color: white; border-radius: 4px; cursor: pointer; box-sizing: border-box;';
                        }
                        content.innerHTML = `
                            <button class="ui-button" style="${buttonStyle}">
                                ${component.props.text || '按钮'}
                            </button>
                        `;
                        break;

                    case 'checkbox':
                        let checkboxStyle = '';
                        if (component.props.stretchy === 'true') {
                            checkboxStyle = 'flex: 1;';
                        }
                        content.innerHTML = `
                            <label class="ui-checkbox" style="${checkboxStyle}">
                                <input type="checkbox" ${component.props.checked === 'true' ? 'checked' : ''}>
                                <span>${component.props.text || '复选框'}</span>
                            </label>
                        `;
                        break;

                    case 'radio':
                        let radioStyle = '';
                        if (component.props.stretchy === 'true') {
                            radioStyle = 'flex: 1;';
                        }
                        content.innerHTML = `
                            <div class="ui-radio-buttons" style="${radioStyle}">
                                <label>
                                    <input type="radio" name="preview" disabled>
                                    <span>${component.props.text || '单选框'}</span>
                                </label>
                            </div>
                        `;
                        break;

                    case 'label':
                        let labelStyle = 'font-size: 14px; color: #333;';
                        if (component.props.stretchy === 'true') {
                            labelStyle = 'flex: 1; font-size: 14px; color: #333;';
                        }
                        content.innerHTML = `
                            <span class="ui-label" style="${labelStyle}">
                                ${component.props.text || '标签文本'}
                            </span>
                        `;
                        break;

                    case 'progressbar':
                        let progressbarStyle = 'width: 200px;';
                        if (component.props.stretchy === 'true') {
                            progressbarStyle = 'flex: 1; min-width: 80px; max-width: 100%;';
                        }
                        content.innerHTML = `
                            <div class="ui-progress-bar" style="${progressbarStyle}">
                                <div class="fill" style="width: ${component.props.value || '60'}%; height: 20px; background: #0078d4; border-radius: 4px;"></div>
                            </div>
                        `;
                        break;

                    case 'separator':
                        if (component.props.orientation === 'vertical') {
                            content.innerHTML = `<hr class="ui-separator vertical" style="height: 50px; width: 2px;">`;
                        } else {
                            content.innerHTML = `<hr class="ui-separator horizontal" style="width: 200px; height: 1px;">`;
                        }
                        break;

                    case 'table':
                        let tableStyle = 'width: 200px; min-width: 200px;';
                        if (component.props.stretchy === 'true') {
                            tableStyle = 'width: 100%; min-width: 200px; flex: 1;';
                        }
                        
                        const columns = component.props.columns ? component.props.columns.split(',') : ['列1', '列2'];
                        const columnTypes = component.props.columnTypes ? component.props.columnTypes.split(',') : ['text', 'text'];
                        
                        // 如果没有表格数据，根据列类型创建示例数据
                        let tableData = component.props.tableData ? JSON.parse(component.props.tableData) : null;
                        if (!tableData) {
                            tableData = [
                                columns.map((col, index) => {
                                    const colType = columnTypes[index] || 'text';
                                    switch (colType) {
                                        case 'button':
                                            return '按钮:button';
                                        case 'checkbox':
                                            return 'false';
                                        case 'progress':
                                            return '50';
                                        default:
                                            return `数据${index + 1}`;
                                    }
                                }),
                                columns.map((col, index) => {
                                    const colType = columnTypes[index] || 'text';
                                    switch (colType) {
                                        case 'button':
                                            return '编辑:edit';
                                        case 'checkbox':
                                            return 'true';
                                        case 'progress':
                                            return '75';
                                        default:
                                            return `数据${index + 3}`;
                                    }
                                })
                            ];
                        }
                        
                        // 生成表头
                        let headerHTML = columns.map(col => `<th>${col}</th>`).join('');
                        
                        // 生成数据行
                        let rowsHTML = '';
                        tableData.forEach(row => {
                            rowsHTML += '<tr>';
                            // 确保每行都有足够的列
                            for (let i = 0; i < columns.length; i++) {
                                const cell = row[i] || ''; // 如果没有数据，使用空字符串
                                const colType = columnTypes[i] || 'text';
                                let cellHTML = '';
                                
                                switch (colType) {
                                    case 'text':
                                        cellHTML = `<td>${cell}</td>`;
                                        break;
                                    case 'image':
                                        cellHTML = `<td><img src="https://via.placeholder.com/16x16" alt="${cell}" style="width: 16px; height: 16px;"></td>`;
                                        break;
                                    case 'checkbox':
                                        const checked = cell === 'true' || cell === '1' ? 'checked' : '';
                                        cellHTML = `<td><input type="checkbox" ${checked} disabled></td>`;
                                        break;
                                    case 'progress':
                                        const progress = Math.min(100, Math.max(0, parseInt(cell) || 0));
                                        cellHTML = `
                                            <td>
                                                <div class="ui-progress-bar" style="width: 60px; height: 8px;">
                                                    <div class="fill" style="width: ${progress}%; background: #0078d4;"></div>
                                                </div>
                                            </td>
                                        `;
                                        break;
                                    case 'button':
                                        // 支持按钮文本格式: "文本:值" 或纯文本
                                        let buttonText = cell;
                                        let buttonValue = cell;
                                        if (cell.includes(':')) {
                                            const parts = cell.split(':');
                                            buttonText = parts[0];
                                            buttonValue = parts[1];
                                        }
                                        cellHTML = `<td><button style="padding: 2px 6px; font-size: 10px;" title="${buttonValue}">${buttonText}</button></td>`;
                                        break;
                                    case 'imageText':
                                        cellHTML = `
                                            <td style="display: flex; align-items: center; gap: 4px;">
                                                <img src="https://via.placeholder.com/16x16" alt="" style="width: 16px; height: 16px;">
                                                <span style="font-size: 10px;">${cell}</span>
                                            </td>
                                        `;
                                        break;
                                    default:
                                        cellHTML = `<td>${cell}</td>`;
                                }
                                rowsHTML += cellHTML;
                            }
                            rowsHTML += '</tr>';
                        });
                        
                        content.innerHTML = `
                            <table class="mini-table" style="${tableStyle}">
                                <tr>${headerHTML}</tr>
                                ${rowsHTML}
                            </table>
                        `;
                        break;

                    case 'group':
                        const groupPadding = component.props.margined === 'true' ? '16px' : '8px';
                        content.innerHTML = `
                            <fieldset class="ui-group" style="min-width: 200px; min-height: 120px; border: 2px solid #0078d4; border-radius: 4px; padding: ${groupPadding}; width: 100%; position: relative; box-sizing: border-box;">
                                <legend style="padding: 0 8px; font-weight: bold; color: #0078d4;">${component.props.title || '分组'}</legend>
                                <div class="group-content" style="min-height: 60px; width: 100%; box-sizing: border-box;">
                                </div>
                            </fieldset>
                        `;
                        break;

                    default:
                        content.innerHTML = `<div style="padding: 8px; border: 1px solid #ccc;">${component.type}</div>`;
                }

                return content;
            }

            createComponentControls(component) {
                const controls = document.createElement('div');
                controls.className = 'component-controls';

                // 删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'control-btn delete';
                deleteBtn.innerHTML = '×';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    this.deleteComponent(component);
                }, true); // 使用捕获阶段确保优先处理

                controls.appendChild(deleteBtn);
                return controls;
            }

            selectComponent(component) {
                // 清除之前的选择
                document.querySelectorAll('.component-element').forEach(el => {
                    el.classList.remove('selected', 'current-selected');
                });

                // 选中当前组件
                const element = document.querySelector(`[data-component-id="${component.id}"]`);
                if (element) {
                    element.classList.add('selected', 'current-selected');
                }

                this.selectedComponent = component;
                this.showProperties(component);
            }

            showProperties(component) {
                // 防止循环更新
                if (this.updatingProperties) return;
                this.updatingProperties = true;
                
                const propertiesPanel = document.getElementById('propertiesPanel');
                
                let html = `
                    <div class="property-group">
                        <h4>基本属性</h4>
                        <div class="property-row">
                            <label class="property-label">组件类型:</label>
                            <span class="property-input" style="background: #f8f9fa;">${component.type}</span>
                        </div>
                        <div class="property-row">
                            <label class="property-label">ID:</label>
                            <span class="property-input" style="background: #f8f9fa;">${component.id}</span>
                        </div>
                    </div>
                `;

                // 添加特定组件的属性
                html += this.getComponentProperties(component);
                
                // 为所有组件添加Grid布局属性（在Grid容器中时生效）
                html += this.getGridProperties(component);

                // 添加保存按钮
                html += `
                    <div class="property-group">
                        <div class="property-row">
                            <button class="btn btn-primary" id="savePropertiesBtn" style="width: 100%; margin-top: 10px;">
                                保存属性
                            </button>
                        </div>
                    </div>
                `;

                propertiesPanel.innerHTML = html;
                this.bindPropertyEvents(component);
                
                // 绑定保存按钮事件
                const saveBtn = document.getElementById('savePropertiesBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        this.saveComponentProperties(component);
                    });
                }
                
                // 重置更新标志
                setTimeout(() => {
                    this.updatingProperties = false;
                }, 10);
            }
            
            getGridProperties(component) {
                // 检查组件是否在Grid容器内
                const parentComponent = this.findParentComponent(component);
                const isGridChild = parentComponent && parentComponent.type === 'grid';
                
                if (!isGridChild) {
                    return ''; // 只有Grid子组件才显示Grid布局属性
                }
                
                // 解析现有的对齐值
                let horizontalAlign = 'fill';
                let verticalAlign = 'fill';
                
                if (component.props.align) {
                    if (component.props.align.includes(',')) {
                        // 已有分离的对齐值
                        const [h, v] = component.props.align.split(',');
                        horizontalAlign = h.trim() || 'fill';
                        verticalAlign = v.trim() || 'fill';
                    } else {
                        // 单个值，水平和垂直相同
                        horizontalAlign = component.props.align;
                        verticalAlign = component.props.align;
                    }
                }
                
                let html = `
                    <div class="property-group">
                        <h4>Grid布局属性</h4>
                        <div class="property-row">
                            <label class="property-label">行 (row):</label>
                            <input type="number" class="property-input" data-prop="row" value="${component.props.row || '0'}" min="0">
                        </div>
                        <div class="property-row">
                            <label class="property-label">列 (col):</label>
                            <input type="number" class="property-input" data-prop="col" value="${component.props.col || '0'}" min="0">
                        </div>
                        <div class="property-row">
                            <label class="property-label">行跨度 (rowspan):</label>
                            <input type="number" class="property-input" data-prop="rowspan" value="${component.props.rowspan || '1'}" min="1" max="10">
                        </div>
                        <div class="property-row">
                            <label class="property-label">列跨度 (colspan):</label>
                            <input type="number" class="property-input" data-prop="colspan" value="${component.props.colspan || '1'}" min="1" max="10">
                        </div>
                        <div class="property-row">
                            <label class="property-label">水平对齐:</label>
                            <select class="property-input" data-prop="alignHorizontal">
                                <option value="fill" ${horizontalAlign === 'fill' ? 'selected' : ''}>fill (填充)</option>
                                <option value="start" ${horizontalAlign === 'start' ? 'selected' : ''}>start (起始)</option>
                                <option value="center" ${horizontalAlign === 'center' ? 'selected' : ''}>center (居中)</option>
                                <option value="end" ${horizontalAlign === 'end' ? 'selected' : ''}>end (结束)</option>
                            </select>
                        </div>
                        <div class="property-row">
                            <label class="property-label">垂直对齐:</label>
                            <select class="property-input" data-prop="alignVertical">
                                <option value="fill" ${verticalAlign === 'fill' ? 'selected' : ''}>fill (填充)</option>
                                <option value="start" ${verticalAlign === 'start' ? 'selected' : ''}>start (起始)</option>
                                <option value="center" ${verticalAlign === 'center' ? 'selected' : ''}>center (居中)</option>
                                <option value="end" ${verticalAlign === 'end' ? 'selected' : ''}>end (结束)</option>
                            </select>
                        </div>
                    </div>
                `;
                
                return html;
            }
            
            findParentComponent(component) {
                // 递归查找父组件
                for (const rootComponent of this.components) {
                    const parent = this.findParentInTree(rootComponent, component);
                    if (parent) return parent;
                }
                return null;
            }
            
            findParentInTree(parent, target) {
                if (!parent.children) return null;
                
                for (const child of parent.children) {
                    if (child.id === target.id) {
                        return parent;
                    }
                    
                    const found = this.findParentInTree(child, target);
                    if (found) return found;
                }
                
                return null;
            }

            getComponentProperties(component) {
                let html = '';

                switch (component.type) {
                    case 'window':
                        html += `
                            <div class="property-group">
                                <h4>窗口属性</h4>
                                <div class="property-row">
                                    <label class="property-label">标题:</label>
                                    <input type="text" class="property-input" data-prop="title" value="${component.props.title || ''}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">尺寸:</label>
                                    <input type="text" class="property-input" data-prop="size" value="${component.props.size || ''}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">居中:</label>
                                    <select class="property-input" data-prop="centered">
                                        <option value="true" ${component.props.centered === 'true' ? 'selected' : ''}>是</option>
                                        <option value="false" ${component.props.centered === 'false' ? 'selected' : ''}>否</option>
                                    </select>
                                </div>
                                <div class="property-row">
                                    <label class="property-label">边距:</label>
                                    <select class="property-input" data-prop="margined">
                                        <option value="true" ${component.props.margined === 'true' ? 'selected' : ''}>是</option>
                                        <option value="false" ${component.props.margined === 'false' ? 'selected' : ''}>否</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'hbox':
                    case 'vbox':
                    case 'box':
                    case 'form':
                    case 'grid':
                        html += `
                            <div class="property-group">
                                <h4>容器属性</h4>
                                <div class="property-row">
                                    <label class="property-label">内边距:</label>
                                    <select class="property-input" data-prop="padded">
                                        <option value="true" ${component.props.padded === 'true' ? 'selected' : ''}>是</option>
                                        <option value="false" ${component.props.padded === 'false' ? 'selected' : ''}>否</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;
                    case 'tab':
                        const tabs = component.props.tabs ? component.props.tabs.split(',') : ['标签页1', '标签页2'];
                        const activeTab = parseInt(component.props.activeTab || '0');
                        html += `
                            <div class="property-group">
                                <h4>标签页属性</h4>
                                <div class="property-row">
                                    <label class="property-label">内边距:</label>
                                    <select class="property-input" data-prop="padded">
                                        <option value="true" ${component.props.padded === 'true' ? 'selected' : ''}>是</option>
                                        <option value="false" ${component.props.padded === 'false' ? 'selected' : ''}>否</option>
                                    </select>
                                </div>
                                <div class="property-row">
                                    <label class="property-label">当前标签:</label>
                                    <select class="property-input" data-prop="activeTab">
                                        ${tabs.map((tab, index) => 
                                            `<option value="${index}" ${activeTab === index ? 'selected' : ''}>${tab}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="property-row">
                                    <label class="property-label">标签列表:</label>
                                    <div class="tabs-list">
                                        ${tabs.map((tab, index) => `
                                            <div class="tab-item ${activeTab === index ? 'active' : ''}">
                                                <input type="text" class="tab-input" value="${tab}" data-index="${index}">
                                                <button class="tab-remove" data-index="${index}">×</button>
                                                <button class="tab-activate" data-index="${index}" ${activeTab === index ? 'disabled' : ''}>激活</button>
                                            </div>
                                        `).join('')}
                                        <button class="tab-add">+ 添加标签页</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;

                    case 'group':
                        html += `
                            <div class="property-group">
                                <h4>分组属性</h4>
                                <div class="property-row">
                                    <label class="property-label">标题:</label>
                                    <input type="text" class="property-input" data-prop="title" value="${component.props.title || '分组'}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">边距:</label>
                                    <select class="property-input" data-prop="margined">
                                        <option value="true" ${component.props.margined === 'true' ? 'selected' : ''}>是</option>
                                        <option value="false" ${component.props.margined === 'false' ? 'selected' : ''}>否</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;

                    case 'input':
                    case 'textarea':
                    case 'password':
                        html += `
                            <div class="property-group">
                                <h4>输入属性</h4>
                                <div class="property-row">
                                    <label class="property-label">占位符:</label>
                                    <input type="text" class="property-input" data-prop="placeholder" value="${component.props.placeholder || ''}">
                                </div>
                                ${component.type === 'textarea' ? `
                                <div class="property-row">
                                    <label class="property-label">行数:</label>
                                    <input type="number" class="property-input" data-prop="rows" value="${component.props.rows || '3'}">
                                </div>
                                ` : ''}
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    ${this.getStretchyOptions(component.props.stretchy)}
                                </div>
                            </div>
                        `;
                        break;

                    case 'combobox':
                        const options = component.props.options ? component.props.options.split(',') : ['选项 1', '选项 2', '选项 3'];
                        html += `
                            <div class="property-group">
                                <h4>下拉框属性</h4>
                                <div class="property-row">
                                    <label class="property-label">选中项:</label>
                                    <select class="property-input" data-prop="selected">
                                        ${options.map((option, index) => 
                                            `<option value="${index}" ${component.props.selected == index ? 'selected' : ''}>${option}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="property-row">
                                    <label class="property-label">选项列表:</label>
                                    <div class="options-list">
                                        ${options.map((option, index) => `
                                            <div class="option-item">
                                                <input type="text" class="option-input" value="${option}" data-index="${index}">
                                                <button class="option-remove" data-index="${index}">×</button>
                                            </div>
                                        `).join('')}
                                        <button class="option-add">+ 添加选项</button>
                                    </div>
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    ${this.getStretchyOptions(component.props.stretchy)}
                                </div>
                            </div>
                        `;
                        break;

                    case 'spinbox':
                    case 'slider':
                        html += `
                            <div class="property-group">
                                <h4>数值属性</h4>
                                <div class="property-row">
                                    <label class="property-label">最小值:</label>
                                    <input type="number" class="property-input" data-prop="min" value="${component.props.min || '0'}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">最大值:</label>
                                    <input type="number" class="property-input" data-prop="max" value="${component.props.max || '100'}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">当前值:</label>
                                    <input type="number" class="property-input" data-prop="value" value="${component.props.value || '50'}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    ${this.getStretchyOptions(component.props.stretchy)}
                                </div>
                            </div>
                        `;
                        break;

                    case 'progressbar':
                        html += `
                            <div class="property-group">
                                <h4>进度条属性</h4>
                                <div class="property-row">
                                    <label class="property-label">进度:</label>
                                    <input type="number" class="property-input" data-prop="value" value="${component.props.value || '60'}" min="0" max="100">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    ${this.getStretchyOptions(component.props.stretchy)}
                                </div>
                            </div>
                        `;
                        break;

                    case 'separator':
                        html += `
                            <div class="property-group">
                                <h4>分隔符属性</h4>
                                <div class="property-row">
                                    <label class="property-label">方向:</label>
                                    <select class="property-input" data-prop="orientation">
                                        <option value="horizontal" ${component.props.orientation === 'horizontal' ? 'selected' : ''}>水平</option>
                                        <option value="vertical" ${component.props.orientation === 'vertical' ? 'selected' : ''}>垂直</option>
                                    </select>
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    ${this.getStretchyOptions(component.props.stretchy)}
                                </div>
                            </div>
                        `;
                        break;

                    case 'table':
                        const columns = component.props.columns ? component.props.columns.split(',') : ['列1', '列2'];
                        const columnTypes = component.props.columnTypes ? component.props.columnTypes.split(',') : ['text', 'text'];
                        const tableData = component.props.tableData ? JSON.parse(component.props.tableData) : [
                            ['数据1', '数据2'],
                            ['数据3', '数据4']
                        ];
                        
                        html += `
                            <div class="property-group">
                                <h4>表格属性</h4>
                                <div class="property-row">
                                    <label class="property-label">列标题:</label>
                                    <input type="text" class="property-input" data-prop="columns" value="${component.props.columns || '列1,列2'}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">列类型:</label>
                                    <div class="column-types-list">
                                        ${columns.map((col, index) => `
                                            <div class="column-type-item">
                                                <span class="column-name">${col}</span>
                                                <select class="column-type-select" data-index="${index}">
                                                    <option value="text" ${columnTypes[index] === 'text' ? 'selected' : ''}>文本</option>
                                                    <option value="image" ${columnTypes[index] === 'image' ? 'selected' : ''}>图片</option>
                                                    <option value="checkbox" ${columnTypes[index] === 'checkbox' ? 'selected' : ''}>复选框</option>
                                                    <option value="progress" ${columnTypes[index] === 'progress' ? 'selected' : ''}>进度条</option>
                                                    <option value="button" ${columnTypes[index] === 'button' ? 'selected' : ''}>按钮</option>
                                                    <option value="imageText" ${columnTypes[index] === 'imageText' ? 'selected' : ''}>图片+文本</option>
                                                </select>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    ${this.getStretchyOptions(component.props.stretchy)}
                                </div>
                            </div>
                            <div class="property-group">
                                <h4>表格数据</h4>
                                <div style="font-size: 11px; color: #6c757d; margin-bottom: 8px;">
                                    提示：按钮列可使用 "文本:值" 格式，如 "删除:delete" 或 "编辑:edit"
                                </div>
                                <div class="table-data-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                ${columns.map(col => `<th>${col}</th>`).join('')}
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${tableData.map((row, rowIndex) => `
                                                <tr data-row="${rowIndex}">
                                                    ${row.map((cell, cellIndex) => `
                                                        <td>
                                                            <input type="text" class="cell-input" data-row="${rowIndex}" data-col="${cellIndex}" value="${cell}">
                                                        </td>
                                                    `).join('')}
                                                    <td>
                                                        <button class="row-remove" data-row="${rowIndex}">删除</button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                    <button class="add-row-btn">+ 添加行</button>
                                </div>
                            </div>
                        `;
                        break;

                    case 'button':
                        html += `
                            <div class="property-group">
                                <h4>按钮属性</h4>
                                <div class="property-row">
                                    <label class="property-label">文本:</label>
                                    <input type="text" class="property-input" data-prop="text" value="${component.props.text || ''}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    ${this.getStretchyOptions(component.props.stretchy)}
                                </div>
                            </div>
                        `;
                        break;

                    case 'checkbox':
                        html += `
                            <div class="property-group">
                                <h4>复选框属性</h4>
                                <div class="property-row">
                                    <label class="property-label">文本:</label>
                                    <input type="text" class="property-input" data-prop="text" value="${component.props.text || ''}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">选中:</label>
                                    <select class="property-input" data-prop="checked">
                                        <option value="true" ${component.props.checked === 'true' ? 'selected' : ''}>是</option>
                                        <option value="false" ${component.props.checked === 'false' ? 'selected' : ''}>否</option>
                                    </select>
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    ${this.getStretchyOptions(component.props.stretchy)}
                                </div>
                            </div>
                        `;
                        break;

                    case 'radio':
                        html += `
                            <div class="property-group">
                                <h4>单选框属性</h4>
                                <div class="property-row">
                                    <label class="property-label">文本:</label>
                                    <input type="text" class="property-input" data-prop="text" value="${component.props.text || ''}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    ${this.getStretchyOptions(component.props.stretchy)}
                                </div>
                            </div>
                        `;
                        break;

                    case 'label':
                        html += `
                            <div class="property-group">
                                <h4>标签属性</h4>
                                <div class="property-row">
                                    <label class="property-label">文本:</label>
                                    <input type="text" class="property-input" data-prop="text" value="${component.props.text || ''}">
                                </div>
                                <div class="property-row">
                                    <label class="property-label">拉伸:</label>
                                    ${this.getStretchyOptions(component.props.stretchy)}
                                </div>
                            </div>
                        `;
                        break;
                }

                return html;
            }

            bindPropertyEvents(component) {
                const propertyInputs = document.querySelectorAll('.property-input');
                propertyInputs.forEach(input => {
                    input.addEventListener('input', (e) => {
                        // 如果正在更新属性，跳过以防止循环
                        if (this.updatingProperties) return;
                        
                        const prop = e.target.dataset.prop;
                        const value = e.target.value;
                        component.props[prop] = value;
                        
                        // 特殊处理Tab组件的activeTab属性
                        if (component.type === 'tab' && prop === 'activeTab') {
                            // 立即切换标签页
                            this.switchTabByIndex(component, parseInt(value));
                            // 更新代码预览
                            this.updateCodePreview();
                            return;
                        }
                        
                        // 特殊处理Table组件的columns属性
                        if (component.type === 'table' && prop === 'columns') {
                            // 获取新旧列数
                            const oldColumns = component.props.columns ? component.props.columns.split(',') : [];
                            const newColumns = value.split(',');
                            
                            // 更新列类型数组
                            const oldTypes = component.props.columnTypes ? component.props.columnTypes.split(',') : [];
                            const newTypes = [...oldTypes];
                            
                            // 如果新增了列，添加默认类型
                            if (newColumns.length > oldTypes.length) {
                                for (let i = oldTypes.length; i < newColumns.length; i++) {
                                    newTypes.push('text'); // 新列默认为文本类型
                                }
                            }
                            // 如果减少了列，截断类型数组
                            else if (newColumns.length < oldTypes.length) {
                                newTypes.length = newColumns.length;
                            }
                            component.props.columnTypes = newTypes.join(',');
                            
                            // 更新表格数据
                            const tableData = component.props.tableData ? JSON.parse(component.props.tableData) : [];
                            tableData.forEach(row => {
                                // 如果新增了列，添加空数据
                                if (newColumns.length > row.length) {
                                    for (let i = row.length; i < newColumns.length; i++) {
                                        row.push('');
                                    }
                                }
                                // 如果减少了列，截断数据
                                else if (newColumns.length < row.length) {
                                    row.length = newColumns.length;
                                }
                            });
                            component.props.tableData = JSON.stringify(tableData);
                            
                            // 刷新属性面板以显示新的列类型和数据
                            this.showProperties(component);
                            // 更新组件预览
                            this.refreshComponent(component);
                            this.updateCodePreview();
                            return;
                        }
                        
                        // 检查是否是Grid布局属性
                        const isGridProp = ['row', 'col', 'rowspan', 'colspan', 'align', 'alignHorizontal', 'alignVertical'].includes(prop);
                        
                        if (isGridProp) {
                            // 特殊处理水平对齐和垂直对齐
                            if (prop === 'alignHorizontal' || prop === 'alignVertical') {
                                // 获取当前的对齐值
                                const currentAlign = component.props.align || 'fill,fill';
                                let [hAlign, vAlign] = currentAlign.split(',');
                                
                                // 更新对应的对齐值
                                if (prop === 'alignHorizontal') {
                                    hAlign = value;
                                } else if (prop === 'alignVertical') {
                                    vAlign = value;
                                }
                                
                                // 如果水平和垂直对齐相同，使用单个值
                                if (hAlign === vAlign) {
                                    component.props.align = hAlign;
                                } else {
                                    // 如果不同，使用逗号分隔的格式
                                    component.props.align = `${hAlign},${vAlign}`;
                                }
                            }
                            
                            // 如果是Grid布局属性，需要重新应用Grid样式
                            const element = document.querySelector(`[data-component-id="${component.id}"]`);
                            const parentComponent = this.findParentComponent(component);
                            if (element && parentComponent && parentComponent.type === 'grid') {
                                this.applyGridStyles(element, component, parentComponent);
                            }
                            // 更新代码预览
                            this.updateCodePreview();
                        }
                        // 其他属性仍然只在保存时更新
                    });
                });
                
                // Combobox 选项管理
                if (component.type === 'combobox') {
                    this.setupComboboxEvents(component);
                }
                
                // Tab 标签页管理
                if (component.type === 'tab') {
                    this.setupTabEvents(component);
                }
                
                // Table 数据管理
                if (component.type === 'table') {
                    this.setupTableEvents(component);
                }
            }
            
            // 根据索引切换标签页
            switchTabByIndex(tabComponent, tabIndex) {
                const tabElement = document.querySelector(`[data-component-id="${tabComponent.id}"]`);
                if (!tabElement) return;
                
                const tabButtons = tabElement.querySelectorAll('.tab-button');
                const tabPages = tabElement.querySelectorAll('.tabpage');
                
                // 切换标签页按钮样式
                tabButtons.forEach(btn => {
                    const btnIndex = parseInt(btn.dataset.tabIndex);
                    if (btnIndex === tabIndex) {
                        btn.style.borderBottom = '2px solid #0078d4';
                    } else {
                        btn.style.borderBottom = 'none';
                    }
                });
                
                // 切换标签页内容显示
                tabPages.forEach(page => {
                    const pageIndex = parseInt(page.dataset.tabpageIndex);
                    if (pageIndex === tabIndex) {
                        page.style.display = 'block';
                        
                        // 检查该标签页是否有组件，如果没有则显示占位符
                        const hasComponents = this.getChildrenForTabPage(tabComponent, pageIndex).length > 0;
                        const placeholder = page.querySelector('.tabpage-placeholder');
                        if (placeholder) {
                            placeholder.style.display = hasComponents ? 'none' : 'block';
                        }
                    } else {
                        page.style.display = 'none';
                    }
                });
            }
            
            saveComponentProperties(component) {
                // 收集所有属性值
                const propertyInputs = document.querySelectorAll('.property-input');
                propertyInputs.forEach(input => {
                    const prop = input.dataset.prop;
                    const value = input.value;
                    component.props[prop] = value;
                });
                
                // 刷新组件显示（包括Grid布局属性）
                this.refreshComponent(component);
                this.updateCodePreview();
                
                // 显示保存成功提示
                this.showSaveNotification();
            }
            
            showSaveNotification() {
                // 创建保存成功提示
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 4px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                    z-index: 9999;
                    font-size: 14px;
                    animation: slideInRight 0.3s ease;
                `;
                notification.textContent = '属性已保存';
                
                // 添加动画样式
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(notification);
                
                // 3秒后自动移除提示
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            }
            
            setupComboboxEvents(component) {
                // 选项输入事件
                const optionInputs = document.querySelectorAll('.option-input');
                optionInputs.forEach(input => {
                    input.addEventListener('input', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const options = component.props.options ? component.props.options.split(',') : ['选项 1', '选项 2', '选项 3'];
                        options[index] = e.target.value;
                        component.props.options = options.join(',');
                        this.refreshComponent(component);
                        this.updateCodePreview();
                        this.showProperties(component); // 刷新属性面板
                    });
                });
                
                // 删除选项事件
                const removeBtns = document.querySelectorAll('.option-remove');
                removeBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        let options = component.props.options ? component.props.options.split(',') : ['选项 1', '选项 2', '选项 3'];
                        if (options.length > 1) {
                            options.splice(index, 1);
                            component.props.options = options.join(',');
                            // 调整选中索引
                            const currentSelected = parseInt(component.props.selected || '0');
                            if (currentSelected >= options.length) {
                                component.props.selected = (options.length - 1).toString();
                            }
                            this.refreshComponent(component);
                            this.updateCodePreview();
                            this.showProperties(component);
                        }
                    });
                });
                
                // 添加选项事件
                const addBtn = document.querySelector('.option-add');
                if (addBtn) {
                    addBtn.addEventListener('click', () => {
                        const options = component.props.options ? component.props.options.split(',') : ['选项 1', '选项 2', '选项 3'];
                        options.push(`选项 ${options.length + 1}`);
                        component.props.options = options.join(',');
                        this.refreshComponent(component);
                        this.updateCodePreview();
                        this.showProperties(component);
                    });
                }
            }
            
            setupTabEvents(component) {
                // 标签输入事件
                const tabInputs = document.querySelectorAll('.tab-input');
                tabInputs.forEach(input => {
                    input.addEventListener('input', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const tabs = component.props.tabs ? component.props.tabs.split(',') : ['标签页1', '标签页2'];
                        tabs[index] = e.target.value;
                        component.props.tabs = tabs.join(',');
                        this.refreshComponent(component);
                        this.updateCodePreview();
                        // 避免递归调用showProperties，只更新标签页标题
                        const tabButtons = document.querySelectorAll(`[data-component-id="${component.id}"] .tab-button`);
                        tabButtons.forEach((btn, btnIndex) => {
                            if (btnIndex === index) {
                                btn.textContent = tabs[index];
                            }
                        });
                    });
                });
                
                // 删除标签页事件
                const removeBtns = document.querySelectorAll('.tab-remove');
                removeBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        let tabs = component.props.tabs ? component.props.tabs.split(',') : ['标签页1', '标签页2'];
                        if (tabs.length > 1) {
                            // 先删除属于被删除标签页的所有子组件
                            if (component.children && component.children.length > 0) {
                                component.children = component.children.filter(child => {
                                    const childTabIndex = parseInt(child.props.tabIndex || '0');
                                    if (childTabIndex === index) {
                                        // 从DOM中删除这个子组件
                                        const childElement = document.querySelector(`[data-component-id="${child.id}"]`);
                                        if (childElement) {
                                            childElement.remove();
                                        }
                                        return false; // 从children数组中移除
                                    }
                                    return true; // 保留其他子组件
                                });
                            }
                            
                            // 删除标签页
                            tabs.splice(index, 1);
                            component.props.tabs = tabs.join(',');
                            
                            // 重新分配剩余子组件的tabIndex
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    const childTabIndex = parseInt(child.props.tabIndex || '0');
                                    if (childTabIndex > index) {
                                        // 如果子组件的tabIndex大于被删除的标签页索引，则减1
                                        child.props.tabIndex = (childTabIndex - 1).toString();
                                    }
                                });
                            }
                            
                            // 调整当前激活标签
                            const currentActive = parseInt(component.props.activeTab || '0');
                            if (currentActive >= tabs.length) {
                                component.props.activeTab = (tabs.length - 1).toString();
                            } else if (currentActive === index) {
                                // 如果删除的是当前激活的标签页，保持激活状态（因为已经重新分配了索引）
                                // 不需要改变activeTab，因为索引已经自动调整
                            }
                            
                            this.refreshComponent(component);
                            this.updateCodePreview();
                            // 延迟刷新属性面板，避免递归
                            setTimeout(() => {
                                if (this.selectedComponent && this.selectedComponent.id === component.id) {
                                    this.showProperties(component);
                                }
                            }, 10);
                        }
                    });
                });
                
                // 激活标签页事件
                const activateBtns = document.querySelectorAll('.tab-activate');
                activateBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        component.props.activeTab = index.toString();
                        this.refreshComponent(component);
                        this.updateCodePreview();
                        // 只更新激活按钮状态，避免递归调用showProperties
                        document.querySelectorAll('.tab-activate').forEach((activateBtn, btnIndex) => {
                            activateBtn.disabled = btnIndex === index;
                        });
                    });
                });
                
                // 添加标签页事件
                const addBtn = document.querySelector('.tab-add');
                if (addBtn) {
                    addBtn.addEventListener('click', () => {
                        const tabs = component.props.tabs ? component.props.tabs.split(',') : ['标签页1', '标签页2'];
                        const newTabIndex = tabs.length;
                        tabs.push(`标签页${newTabIndex + 1}`);
                        component.props.tabs = tabs.join(',');
                        
                        // 自动切换到新添加的标签页
                        component.props.activeTab = newTabIndex.toString();
                        
                        // 重要：不要修改现有子组件的tabIndex，保持它们在原来的标签页中
                        // 新添加的标签页默认是空的，只有后续拖拽的组件才会被添加到新标签页
                        
                        this.refreshComponent(component);
                        this.updateCodePreview();
                        // 延迟刷新属性面板，避免递归
                        setTimeout(() => {
                            if (this.selectedComponent && this.selectedComponent.id === component.id) {
                                this.showProperties(component);
                            }
                        }, 10);
                    });
                }
                
                // 设置标签页切换事件
                this.setupTabSwitching(component);
            }
            
            setupTabSwitching(component) {
                const tabElement = document.querySelector(`[data-component-id="${component.id}"]`);
                if (!tabElement) return;
                
                const tabButtons = tabElement.querySelectorAll('.tab-button');
                const tabPages = tabElement.querySelectorAll('.tabpage');
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tabIndex = parseInt(e.target.dataset.tabIndex);
                        
                        // 更新组件的activeTab属性
                        component.props.activeTab = tabIndex.toString();
                        
                        // 切换标签页按钮样式
                        tabButtons.forEach(btn => {
                            const btnIndex = parseInt(btn.dataset.tabIndex);
                            if (btnIndex === tabIndex) {
                                btn.style.borderBottom = '2px solid #0078d4';
                            } else {
                                btn.style.borderBottom = 'none';
                            }
                        });
                        
                        // 切换标签页内容显示
                        tabPages.forEach(page => {
                            const pageIndex = parseInt(page.dataset.tabpageIndex);
                            if (pageIndex === tabIndex) {
                                page.style.display = 'block';
                                
                                // 检查该标签页是否有组件，如果没有则显示占位符
                                const hasComponents = this.getChildrenForTabPage(component, pageIndex).length > 0;
                                const placeholder = page.querySelector('.tabpage-placeholder');
                                if (placeholder) {
                                    placeholder.style.display = hasComponents ? 'none' : 'block';
                                }
                            } else {
                                page.style.display = 'none';
                            }
                        });
                        
                        // 更新代码预览
                        this.updateCodePreview();
                        
                        // 如果属性面板正在显示这个组件，只更新activeTab选择器，避免递归
                        if (this.selectedComponent && this.selectedComponent.id === component.id) {
                            const activeTabSelect = document.querySelector('[data-prop="activeTab"]');
                            if (activeTabSelect) {
                                activeTabSelect.value = tabIndex.toString();
                            }
                        }
                    });
                });
            }

            refreshComponent(component) {
                const element = document.querySelector(`[data-component-id="${component.id}"]`);
                if (element) {
                    // 保存当前的子组件
                    const currentChildren = [...component.children];
                    
                    // 重新创建内容
                    const newContent = this.createComponentContent(component);
                    
                    // 替换内容
                    const oldContent = element.querySelector('.component-content');
                    element.replaceChild(newContent, oldContent);
                    
                    // 重新渲染子组件
                    if (currentChildren.length > 0) {
                        currentChildren.forEach(child => {
                            const originalParent = child.parent;
                            child.parent = component.id;
                            this.renderComponent(child, component);
                            if (originalParent && originalParent !== component.id) {
                                child.parent = originalParent;
                            }
                        });
                    }
                    
                    // 如果是Tab组件，更新占位符显示状态
                    if (component.type === 'tab') {
                        const tabs = component.props.tabs ? component.props.tabs.split(',') : ['标签页1', '标签页2'];
                        const activeTab = parseInt(component.props.activeTab || '0');
                        
                        tabs.forEach((tab, tabIndex) => {
                            const tabPage = newContent.parentElement.querySelector(`.tabpage[data-tabpage-index="${tabIndex}"]`);
                            if (tabPage) {
                                const hasComponents = this.getChildrenForTabPage(component, tabIndex).length > 0;
                                const placeholder = tabPage.querySelector('.tabpage-placeholder');
                                if (placeholder) {
                                    placeholder.style.display = (hasComponents || tabIndex !== activeTab) ? 'none' : 'block';
                                }
                            }
                        });
                    }
                    
                    // 重新应用Grid布局属性（如果组件在Grid容器中）
                    const parentComponent = this.findParentComponent(component);
                    if (parentComponent && parentComponent.type === 'grid') {
                        // 重新应用Grid样式
                        this.applyGridStyles(element, component, parentComponent);
                    }
                }
            }
            
            // 表格事件管理
            setupTableEvents(component) {
                // 列类型选择事件
                const columnTypeSelects = document.querySelectorAll('.column-type-select');
                columnTypeSelects.forEach(select => {
                    select.addEventListener('change', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const columnTypes = component.props.columnTypes ? component.props.columnTypes.split(',') : ['text', 'text'];
                        columnTypes[index] = e.target.value;
                        component.props.columnTypes = columnTypes.join(',');
                        this.refreshComponent(component);
                        this.updateCodePreview();
                    });
                });
                
                // 单元格数据编辑事件
                const cellInputs = document.querySelectorAll('.cell-input');
                cellInputs.forEach(input => {
                    input.addEventListener('input', (e) => {
                        const rowIndex = parseInt(e.target.dataset.row);
                        const colIndex = parseInt(e.target.dataset.col);
                        const tableData = component.props.tableData ? JSON.parse(component.props.tableData) : [];
                        
                        if (!tableData[rowIndex]) {
                            tableData[rowIndex] = [];
                        }
                        tableData[rowIndex][colIndex] = e.target.value;
                        component.props.tableData = JSON.stringify(tableData);
                        this.refreshComponent(component);
                        this.updateCodePreview();
                    });
                });
                
                // 删除行事件
                const rowRemoveBtns = document.querySelectorAll('.row-remove');
                rowRemoveBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const rowIndex = parseInt(e.target.dataset.row);
                        const tableData = component.props.tableData ? JSON.parse(component.props.tableData) : [];
                        
                        if (tableData.length > 1) {
                            tableData.splice(rowIndex, 1);
                            component.props.tableData = JSON.stringify(tableData);
                            this.showProperties(component); // 刷新属性面板
                            this.refreshComponent(component);
                            this.updateCodePreview();
                        }
                    });
                });
                
                // 添加行事件
                const addRowBtn = document.querySelector('.add-row-btn');
                if (addRowBtn) {
                    addRowBtn.addEventListener('click', () => {
                        const columns = component.props.columns ? component.props.columns.split(',') : ['列1', '列2'];
                        const columnTypes = component.props.columnTypes ? component.props.columnTypes.split(',') : ['text', 'text'];
                        const tableData = component.props.tableData ? JSON.parse(component.props.tableData) : [];
                        
                        // 创建新行，为不同类型的列提供合适的默认值
                        const newRow = columns.map((col, index) => {
                            const colType = columnTypes[index] || 'text';
                            switch (colType) {
                                case 'button':
                                    return '按钮:button'; // 按钮列默认使用 "文本:值" 格式
                                case 'checkbox':
                                    return 'false'; // 复选框默认未选中
                                case 'progress':
                                    return '0'; // 进度条默认为0
                                default:
                                    return ''; // 其他类型默认为空
                            }
                        });
                        tableData.push(newRow);
                        component.props.tableData = JSON.stringify(tableData);
                        
                        this.showProperties(component); // 刷新属性面板
                        this.refreshComponent(component);
                        this.updateCodePreview();
                    });
                }
            }
            
            // 应用Grid样式到组件元素
            applyGridStyles(element, component, parentComponent) {
                if (parentComponent.type !== 'grid') return;
                
                // 设置Grid布局属性
                const row = parseInt(component.props.row || '0');
                const col = parseInt(component.props.col || '0');
                const rowspan = parseInt(component.props.rowspan || '1');
                const colspan = parseInt(component.props.colspan || '1');
                
                // 使用 grid-area 简化设置，确保格式正确
                element.style.gridArea = `${row + 1} / ${col + 1} / span ${rowspan} / span ${colspan}`;
                
                // 根据align属性设置对齐方式
                const align = component.props.align || 'fill,fill';
                let horizontalAlign = 'fill';
                let verticalAlign = 'fill';
                
                // 解析对齐值
                if (align.includes(',')) {
                    // 分离水平和垂直对齐
                    const [h, v] = align.split(',');
                    horizontalAlign = h.trim() || 'fill';
                    verticalAlign = v.trim() || 'fill';
                } else {
                    // 单个值，水平和垂直相同
                    horizontalAlign = align;
                    verticalAlign = align;
                }
                
                // 设置水平对齐
                switch (horizontalAlign) {
                    case 'fill':
                        element.style.justifySelf = 'stretch';
                        break;
                    case 'start':
                        element.style.justifySelf = 'start';
                        break;
                    case 'center':
                        element.style.justifySelf = 'center';
                        break;
                    case 'end':
                        element.style.justifySelf = 'end';
                        break;
                    default:
                        element.style.justifySelf = 'stretch';
                }
                
                // 设置垂直对齐
                switch (verticalAlign) {
                    case 'fill':
                        element.style.alignSelf = 'stretch';
                        break;
                    case 'start':
                        element.style.alignSelf = 'start';
                        break;
                    case 'center':
                        element.style.alignSelf = 'center';
                        break;
                    case 'end':
                        element.style.alignSelf = 'end';
                        break;
                    default:
                        element.style.alignSelf = 'stretch';
                }
                
                // 当组件跨多列时，确保占据整行
                if (colspan > 1) {
                    element.style.display = 'block';
                    element.style.width = '100%';
                }
            }

            deleteComponent(component) {
                // 获取组件的父容器
                const parentComponent = this.findParentComponent(component);
                
                // 从数据结构中删除
                this.removeComponentFromTree(component);
                
                // 从DOM中删除
                const element = document.querySelector(`[data-component-id="${component.id}"]`);
                if (element) {
                    element.remove();
                }
                
                // 如果是Tab容器中的组件，检查是否需要显示占位符
                if (parentComponent && parentComponent.type === 'tab') {
                    const tabIndex = parseInt(component.props.tabIndex || '0');
                    const tabElement = document.querySelector(`[data-component-id="${parentComponent.id}"]`);
                    if (tabElement) {
                        const tabPage = tabElement.querySelector(`.tabpage[data-tabpage-index="${tabIndex}"]`);
                        if (tabPage) {
                            // 检查该标签页是否还有其他组件
                            const hasComponents = this.getChildrenForTabPage(parentComponent, tabIndex).length > 0;
                            if (!hasComponents) {
                                // 如果没有其他组件，显示占位符
                                const placeholder = tabPage.querySelector('.tabpage-placeholder');
                                if (placeholder) {
                                    // 检查该标签页是否是当前激活的标签页
                                    const activeTab = parseInt(parentComponent.props.activeTab || '0');
                                    placeholder.style.display = tabIndex === activeTab ? 'block' : 'none';
                                }
                            }
                        }
                    }
                }
                
                this.updateCodePreview();
                
                // 检查是否需要显示空状态
                if (this.components.length === 0) {
                    this.showEmptyState();
                }
            }
            
            removeComponentFromTree(targetComponent) {
                // 从根组件中查找并删除
                const removeFromArray = (components) => {
                    for (let i = components.length - 1; i >= 0; i--) {
                        if (components[i].id === targetComponent.id) {
                            components.splice(i, 1);
                            return true;
                        }
                        
                        // 递归检查子组件
                        if (components[i].children && components[i].children.length > 0) {
                            if (removeFromArray(components[i].children)) {
                                return true;
                            }
                        }
                    }
                    return false;
                };
                
                removeFromArray(this.components);
            }

            clearAll() {
                if (confirm('确定要清空所有组件吗？')) {
                    this.components = [];
                    document.querySelectorAll('.component-element').forEach(el => el.remove());
                    this.updateCodePreview();
                    this.showEmptyState();
                }
            }

            hideEmptyState() {
                const emptyState = document.getElementById('emptyState');
                if (emptyState) {
                    emptyState.style.display = 'none';
                }
            }

            showEmptyState() {
                const emptyState = document.getElementById('emptyState');
                if (emptyState) {
                    emptyState.style.display = 'flex';
                }
            }

            updateCodePreview() {
                // 清除之前的定时器
                if (this.updateCodePreviewTimeout) {
                    clearTimeout(this.updateCodePreviewTimeout);
                }
                
                // 设置新的定时器，实现防抖
                this.updateCodePreviewTimeout = setTimeout(() => {
                    const codeContent = document.getElementById('codeContent');
                    const htmlCode = document.getElementById('htmlCode');
                    const html = this.generateHTML();
                    
                    if (codeContent) {
                        codeContent.textContent = html;
                    }
                    if (htmlCode) {
                        htmlCode.textContent = html;
                    }
                }, 100); // 100ms 防抖延迟
            }
            
            getComponentAtPosition(clientX, clientY) {
                const elements = document.elementsFromPoint(clientX, clientY);
                for (let element of elements) {
                    const componentEl = element.closest('.component-element');
                    if (componentEl) {
                        const componentId = componentEl.dataset.componentId;
                        return this.findComponentById(componentId);
                    }
                }
                return null;
            }
            
            findComponentById(id) {
                // 在根级别查找
                let component = this.components.find(c => c.id === id);
                if (component) return component;
                
                // 递归在子组件中查找
                for (let rootComponent of this.components) {
                    component = this.findInChildren(rootComponent, id);
                    if (component) return component;
                }
                
                return null;
            }
            
            findInChildren(parent, id) {
                for (let child of parent.children) {
                    if (child.id === id) return child;
                    
                    const found = this.findInChildren(child, id);
                    if (found) return found;
                }
                return null;
            }
            
            isContainerComponent(type) {
                return ['window', 'grid', 'hbox', 'vbox', 'box', 'form', 'tab', 'group'].includes(type);
            }
            
            isControlComponent(type) {
                // 输入控件
                const inputControls = ['input', 'textarea', 'password', 'combobox', 'spinbox', 'slider'];
                // 按钮控件
                const buttonControls = ['button', 'checkbox', 'radio'];
                // 显示控件
                const displayControls = ['label', 'progressbar', 'separator', 'table'];
                
                return inputControls.includes(type) || buttonControls.includes(type) || displayControls.includes(type);
            }
            
            highlightContainer(container) {
                this.clearContainerHighlights();
                const element = document.querySelector(`[data-component-id="${container.id}"]`);
                if (element) {
                    element.classList.add('drag-target');
                }
            }
            
            clearContainerHighlights() {
                document.querySelectorAll('.drag-target').forEach(el => {
                    el.classList.remove('drag-target');
                });
            }
            
            addComponentToContainer(type, containerComponent, x, y) {
                const component = {
                    id: `component_${++this.componentIdCounter}`,
                    type: type,
                    x: 0, // 子组件不需要绝对定位
                    y: 0,
                    props: this.getDefaultProps(type),
                    children: [],
                    parent: containerComponent.id
                };
                
                // 根据父容器类型自动设置默认拉伸属性
                if (containerComponent.type === 'hbox') {
                    // HBox中子组件默认拉伸
                    component.props.stretchy = 'true';
                } else if (containerComponent.type === 'vbox') {
                    // VBox中子组件默认拉伸
                    component.props.stretchy = 'true';
                } else if (containerComponent.type === 'box') {
                    // Box中子组件默认不拉伸
                    component.props.stretchy = 'false';
                } else if (containerComponent.type === 'form') {
                    // Form中子组件默认拉伸
                    component.props.stretchy = 'true';
                } else if (containerComponent.type === 'grid') {
                    // Grid容器中自动计算下一个可用位置
                    const nextPos = this.calculateNextGridPosition(containerComponent);
                    component.props.row = nextPos.row.toString();
                    component.props.col = nextPos.col.toString();
                    component.props.stretchy = 'true';
                } else if (containerComponent.type === 'tab') {
                    // Tab容器中，将组件添加到当前激活的标签页
                    const activeTab = parseInt(containerComponent.props.activeTab || '0');
                    component.props.tabIndex = activeTab.toString();
                    component.props.stretchy = 'true';
                }
                
                // 添加到父容器的children数组
                containerComponent.children.push(component);
                
                // 如果是Tab容器，隐藏对应标签页的占位符
                if (containerComponent.type === 'tab') {
                    const tabIndex = parseInt(component.props.tabIndex || '0');
                    const tabElement = document.querySelector(`[data-component-id="${containerComponent.id}"]`);
                    if (tabElement) {
                        const tabPage = tabElement.querySelector(`.tabpage[data-tabpage-index="${tabIndex}"]`);
                        if (tabPage) {
                            const placeholder = tabPage.querySelector('.tabpage-placeholder');
                            if (placeholder) {
                                placeholder.style.display = 'none';
                            }
                        }
                    }
                }
                
                // 渲染组件到容器中
                this.renderComponent(component, containerComponent);
                this.updateCodePreview();
            }
            
            // 计算Grid容器中下一个可用位置
            calculateNextGridPosition(containerComponent) {
                if (containerComponent.type !== 'grid') {
                    return { row: 0, col: 0 };
                }
                
                // 获取当前Grid容器中已有的组件
                const children = containerComponent.children || [];
                
                if (children.length === 0) {
                    return { row: 0, col: 0 }; // 第一个组件放在(0,0)
                }
                
                // 简单策略：找到最小的空闲位置
                // 创建一个二维数组来标记占用位置
                const gridSize = 10; // 假设最大10x10网格
                const occupied = Array(gridSize).fill().map(() => Array(gridSize).fill(false));
                
                // 标记已占用的位置
                for (const child of children) {
                    const row = parseInt(child.props.row || '0');
                    const col = parseInt(child.props.col || '0');
                    const rowspan = parseInt(child.props.rowspan || '1');
                    const colspan = parseInt(child.props.colspan || '1');
                    
                    // 标记组件占用的所有单元格
                    for (let r = row; r < row + rowspan && r < gridSize; r++) {
                        for (let c = col; c < col + colspan && c < gridSize; c++) {
                            occupied[r][c] = true;
                        }
                    }
                }
                
                // 找到第一个空闲位置
                for (let row = 0; row < gridSize; row++) {
                    for (let col = 0; col < gridSize; col++) {
                        if (!occupied[row][col]) {
                            return { row, col };
                        }
                    }
                }
                
                // 如果没有找到空闲位置，返回默认位置（简单策略：放在下一行）
                return { row: Math.floor(children.length / 2), col: children.length % 2 };
            }
            
            updateContainerPlaceholder(containerComponent) {
                const parentEl = document.querySelector(`[data-component-id="${containerComponent.id}"]`);
                if (parentEl) {
                    let containerContent;
                    if (containerComponent.type === 'grid') {
                        // Grid容器需要特殊处理，查找实际的grid容器
                        containerContent = parentEl.querySelector('.ui-grid');
                    } else {
                        containerContent = parentEl.querySelector('.window-content') || 
                                        parentEl.querySelector('.ui-box') || 
                                        parentEl.querySelector('.ui-form') || 
                                        parentEl.querySelector('.ui-tab');
                    }
                    
                    if (containerContent) {
                        // 检查是否有子组件
                        const hasChildren = containerComponent.children.length > 0;
                        
                        // 移除所有占位符文本
                        const allTextNodes = Array.from(containerContent.childNodes).filter(node => 
                            node.nodeType === Node.TEXT_NODE
                        );
                        allTextNodes.forEach(node => node.remove());
                        
                        // 移除所有占位符元素
                        if (containerComponent.type === 'grid') {
                            const placeholderElements = containerContent.querySelectorAll('.grid-cell-placeholder');
                            placeholderElements.forEach(el => el.remove());
                        }
                        
                        // 如果没有子组件，添加占位符
                        if (!hasChildren) {
                            const placeholder = document.createElement('div');
                            placeholder.style.color = '#999';
                            placeholder.style.fontStyle = 'italic';
                            placeholder.style.padding = '8px';
                            placeholder.textContent = `${containerComponent.type} 容器`;
                            containerContent.appendChild(placeholder);
                        }
                    }
                }
            }

            generateHTML() {
                const self = this; // 保存this引用
                
                function generateComponentHTML(component, indent = 0) {
                    const spaces = '    '.repeat(indent);

                    // 根据生成风格选择标签
                    function getTag(tagGui, tagHtml) {
                        return self.htmlGenerationStyle === 'html' ? tagHtml : tagGui;
                    }
                    
                    // 为组件添加Grid布局属性
                    function addGridAttributes(html, componentProps) {
                        let result = html;
                        
                        // 总是添加Grid布局属性，即使它们是默认值
                        if (componentProps.row !== undefined) {
                            result += ` row="${componentProps.row}"`;
                        }
                        if (componentProps.col !== undefined) {
                            result += ` col="${componentProps.col}"`;
                        }
                        if (componentProps.rowspan !== undefined) {
                            result += ` rowspan="${componentProps.rowspan}"`;
                        }
                        if (componentProps.colspan !== undefined) {
                            result += ` colspan="${componentProps.colspan}"`;
                        }
                        if (componentProps.align !== undefined) {
                            // 如果水平和垂直对齐相同，使用单个值
                            // 如果不同，使用逗号分隔的格式
                            result += ` align="${componentProps.align}"`;
                        }
                        
                        return result;
                    }

                    switch (component.type) {
                        case 'window':
                            const size = component.props.size || '400,300';
                            const tag = getTag('window', 'div');
                            let windowHTML = `${spaces}<${tag} title="${component.props.title || '窗口'}" size="${size}"`;
                            
                            if (component.props.centered === 'true') windowHTML += ' centered="true"';
                            if (component.props.margined === 'true') windowHTML += ' margined="true"';
                            
                            // 添加Grid布局属性
                            windowHTML = addGridAttributes(windowHTML, component.props);
                            
                            windowHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    windowHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                windowHTML += `${spaces}    窗口内容\n`;
                            }
                            
                            windowHTML += `${spaces}</${tag}>`;
                            return windowHTML;

                        case 'hbox':
                            const hboxTag = getTag('hbox', 'div');
                            let hboxHTML = `${spaces}<${hboxTag}`;
                            if (component.props.padded === 'true') hboxHTML += ' padded="true"';
                            
                            // 添加Grid布局属性
                            hboxHTML = addGridAttributes(hboxHTML, component.props);
                            
                            hboxHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    hboxHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                hboxHTML += `${spaces}    HBox 内容\n`;
                            }
                            
                            hboxHTML += `${spaces}</${hboxTag}>`;
                            return hboxHTML;

                        case 'vbox':
                            const vboxTag = getTag('vbox', 'div');
                            let vboxHTML = `${spaces}<${vboxTag}`;
                            if (component.props.padded === 'true') vboxHTML += ' padded="true"';
                            
                            // 添加Grid布局属性
                            vboxHTML = addGridAttributes(vboxHTML, component.props);
                            
                            vboxHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    vboxHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                vboxHTML += `${spaces}    VBox 内容\n`;
                            }
                            
                            vboxHTML += `${spaces}</${vboxTag}>`;
                            return vboxHTML;

                        case 'box':
                            const boxTag = getTag('box', 'div');
                            let boxHTML = `${spaces}<${boxTag}`;
                            if (component.props.padded === 'true') boxHTML += ' padded="true"';
                            
                            // 添加Grid布局属性
                            boxHTML = addGridAttributes(boxHTML, component.props);
                            
                            boxHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    boxHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                boxHTML += `${spaces}    Box 内容\n`;
                            }
                            
                            boxHTML += `${spaces}</${boxTag}>`;
                            return boxHTML;

                        case 'form':
                            const formTag = getTag('form', 'form');
                            let formHTML = `${spaces}<${formTag}`;
                            if (component.props.padded === 'true') formHTML += ' padded="true"';
                            
                            // 添加Grid布局属性
                            formHTML = addGridAttributes(formHTML, component.props);
                            
                            formHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    formHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                formHTML += `${spaces}    Form 内容\n`;
                            }
                            
                            formHTML += `${spaces}</${formTag}>`;
                            return formHTML;

                        case 'grid':
                            const gridTag = getTag('grid', 'div');
                            let gridHTML = `${spaces}<${gridTag}`;
                            if (component.props.padded === 'true') gridHTML += ' padded="true"';
                            
                            // 添加Grid布局属性
                            gridHTML = addGridAttributes(gridHTML, component.props);
                            
                            gridHTML += '>\n';
                            
                            // 递归生成子组件
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    gridHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                gridHTML += `${spaces}    Grid 内容\n`;
                            }
                            
                            gridHTML += `${spaces}</${gridTag}>`;
                            return gridHTML;

                        case 'tab':
                            const tabTag = getTag('tab', 'div');
                            let tabHTML = `${spaces}<${tabTag}`;
                            if (component.props.padded === 'true') tabHTML += ' padded="true"';
                            
                            // 添加Grid布局属性
                            tabHTML = addGridAttributes(tabHTML, component.props);
                            
                            tabHTML += '>\n';
                            
                            // 生成标签页
                            const tabs = component.props.tabs ? component.props.tabs.split(',') : ['标签页1', '标签页2'];
                            const activeTab = parseInt(component.props.activeTab || '0');
                            
                            tabs.forEach((tab, tabIndex) => {
                                tabHTML += `${spaces}    <tabpage title="${tab}">\n`;
                                
                                // 查找属于这个标签页的子组件
                                const tabChildren = self.getChildrenForTabPage(component, tabIndex);
                                if (tabChildren.length > 0) {
                                    tabChildren.forEach(child => {
                                        tabHTML += generateComponentHTML(child, indent + 2) + '\n';
                                    });
                                } else {
                                    // 如果没有子组件，生成占位符label
                                    const labelTag = getTag('label', 'label');
                                    tabHTML += `${spaces}        <${labelTag}>标签页内容</${labelTag}>\n`;
                                }
                                
                                tabHTML += `${spaces}    </tabpage>\n`;
                            });
                            
                            tabHTML += `${spaces}</${tabTag}>`;
                            return tabHTML;

                        case 'group':
                            const groupTag = getTag('group', 'fieldset');
                            let groupHTML = `${spaces}<${groupTag}`;
                            
                            // 添加标题和边距属性
                            if (component.props.title) groupHTML += ` title="${component.props.title}"`;
                            if (component.props.margined === 'true') groupHTML += ' margined="true"';
                            
                            // 添加Grid布局属性
                            groupHTML = addGridAttributes(groupHTML, component.props);
                            
                            groupHTML += '>\n';
                            
                            // 递归生成子组件（不添加图例，因为标题已通过title属性指定）
                            if (component.children && component.children.length > 0) {
                                component.children.forEach(child => {
                                    groupHTML += generateComponentHTML(child, indent + 1) + '\n';
                                });
                            } else {
                                groupHTML += `${spaces}    分组内容\n`;
                            }
                            
                            groupHTML += `${spaces}</${groupTag}>`;
                            return groupHTML;

                        case 'input':
                            const inputTag = getTag('input', 'input');
                            let inputHTML = `${spaces}<${inputTag} placeholder="${component.props.placeholder || '请输入'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                inputHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            
                            // 添加Grid布局属性
                            inputHTML = addGridAttributes(inputHTML, component.props);
                            
                            inputHTML += ' />';
                            return inputHTML;

                        case 'textarea':
                            const textareaTag = getTag('textarea', 'textarea');
                            let textareaHTML = `${spaces}<${textareaTag} placeholder="${component.props.placeholder || '请输入多行文本'}" rows="${component.props.rows || '3'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                textareaHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            
                            // 添加Grid布局属性
                            textareaHTML = addGridAttributes(textareaHTML, component.props);
                            
                            textareaHTML += `></textarea>`;
                            return textareaHTML;

                        case 'password':
                            const passwordTag = getTag('password', 'input');
                            let passwordHTML = `${spaces}<${passwordTag} type="password" placeholder="${component.props.placeholder || '请输入密码'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                passwordHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            
                            // 添加Grid布局属性
                            passwordHTML = addGridAttributes(passwordHTML, component.props);
                            
                            passwordHTML += ' />';
                            return passwordHTML;

                        case 'combobox':
                            const comboboxTag = getTag('combobox', 'select');
                            let comboboxHTML = `${spaces}<${comboboxTag} selected="${component.props.selected || '0'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                comboboxHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            
                            // 添加Grid布局属性
                            comboboxHTML = addGridAttributes(comboboxHTML, component.props);
                            
                            comboboxHTML += '>\n';
                            
                            const options = component.props.options ? component.props.options.split(',') : ['选项 1', '选项 2', '选项 3'];
                            options.forEach(option => {
                                comboboxHTML += `${spaces}    <option>${option}</option>\n`;
                            });
                            
                            comboboxHTML += `${spaces}</${comboboxTag}>`;
                            return comboboxHTML;

                        case 'spinbox':
                            const spinboxTag = getTag('spinbox', 'input');
                            let spinboxHTML = `${spaces}<${spinboxTag} type="number" min="${component.props.min || '0'}" max="${component.props.max || '100'}" value="${component.props.value || '0'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                spinboxHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            
                            // 添加Grid布局属性
                            spinboxHTML = addGridAttributes(spinboxHTML, component.props);
                            
                            spinboxHTML += ' />';
                            return spinboxHTML;

                        case 'slider':
                            const sliderTag = getTag('slider', 'input');
                            let sliderHTML = `${spaces}<${sliderTag} type="range" min="${component.props.min || '0'}" max="${component.props.max || '100'}" value="${component.props.value || '50'}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                sliderHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            
                            // 添加Grid布局属性
                            sliderHTML = addGridAttributes(sliderHTML, component.props);
                            
                            sliderHTML += ' />';
                            return sliderHTML;

                        case 'button':
                            const buttonTag = getTag('button', 'button');
                            let buttonHTML = `${spaces}<${buttonTag}`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                buttonHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            
                            // 添加Grid布局属性
                            buttonHTML = addGridAttributes(buttonHTML, component.props);
                            
                            buttonHTML += `>${component.props.text || '按钮'}</button>`;
                            return buttonHTML;

                        case 'checkbox':
                            const checkboxTag = getTag('checkbox', 'input');
                            let checkboxHTML = `${spaces}<${checkboxTag} type="checkbox"`;
                            if (component.props.text) checkboxHTML += ` value="${component.props.text}"`;
                            if (component.props.checked === 'true') checkboxHTML += ' checked="checked"';
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                checkboxHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            
                            // 添加Grid布局属性
                            checkboxHTML = addGridAttributes(checkboxHTML, component.props);
                            
                            checkboxHTML += ' />';
                            return checkboxHTML;

                        case 'radio':
                            const radioTag = getTag('radio', 'input');
                            let radioHTML = `${spaces}<${radioTag} type="radio"`;
                            if (component.props.text) radioHTML += ` value="${component.props.text}"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                radioHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            
                            // 添加Grid布局属性
                            radioHTML = addGridAttributes(radioHTML, component.props);
                            
                            radioHTML += ' />';
                            return radioHTML;

                        case 'label':
                            const labelTag = getTag('label', 'label');
                            let labelHTML = `${spaces}<${labelTag}`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                labelHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            
                            // 添加Grid布局属性
                            labelHTML = addGridAttributes(labelHTML, component.props);
                            
                            labelHTML += `>${component.props.text || '标签'}</${labelTag}>`;
                            return labelHTML;

                        case 'progressbar':
                            const progressbarTag = getTag('progressbar', 'progress');
                            let progressbarHTML = `${spaces}<${progressbarTag} value="${component.props.value || '60'}" max="100"`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                progressbarHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            
                            // 添加Grid布局属性
                            progressbarHTML = addGridAttributes(progressbarHTML, component.props);
                            
                            progressbarHTML += '></progress>';
                            return progressbarHTML;

                        case 'separator':
                            const separatorTag = getTag('separator', 'hr');
                            let separatorHTML = `${spaces}<${separatorTag}`;
                            if (component.props.orientation === 'vertical') separatorHTML += ' orientation="vertical"';
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                separatorHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            
                            // 添加Grid布局属性
                            separatorHTML = addGridAttributes(separatorHTML, component.props);
                            
                            separatorHTML += ' />';
                            return separatorHTML;

                        case 'table':
                            const tableTag = getTag('table', 'table');
                            const columns = component.props.columns ? component.props.columns.split(',') : ['列1', '列2'];
                            const columnTypes = component.props.columnTypes ? component.props.columnTypes.split(',') : ['text', 'text'];
                            const tableData = component.props.tableData ? JSON.parse(component.props.tableData) : [
                                ['数据1', '数据2'],
                                ['数据3', '数据4']
                            ];
                            
                            let tableHTML = `${spaces}<${tableTag}`;
                            if (component.props.stretchy && component.props.stretchy !== 'false') {
                                tableHTML += ` stretchy="${component.props.stretchy}"`;
                            }
                            if (component.props.columns) {
                                tableHTML += ` columns="${component.props.columns}"`;
                            }
                            if (component.props.columnTypes) {
                                tableHTML += ` columnTypes="${component.props.columnTypes}"`;
                            }
                            
                            // 添加Grid布局属性
                            tableHTML = addGridAttributes(tableHTML, component.props);
                            
                            tableHTML += '>\n';
                            
                            // 生成表头
                            tableHTML += `${spaces}    <thead>\n`;
                            tableHTML += `${spaces}        <tr>\n`;
                            columns.forEach(col => {
                                tableHTML += `${spaces}            <th>${col}</th>\n`;
                            });
                            tableHTML += `${spaces}        </tr>\n`;
                            tableHTML += `${spaces}    </thead>\n`;
                            
                            // 生成表体
                            tableHTML += `${spaces}    <tbody>\n`;
                            tableData.forEach(row => {
                                tableHTML += `${spaces}        <tr>\n`;
                                row.forEach((cell, index) => {
                                    const colType = columnTypes[index] || 'text';
                                    switch (colType) {
                                        case 'text':
                                            tableHTML += `${spaces}            <td>${cell}</td>\n`;
                                            break;
                                        case 'image':
                                            tableHTML += `${spaces}            <td><img src="${cell}" alt="image"></td>\n`;
                                            break;
                                        case 'checkbox':
                                            const checked = cell === 'true' || cell === '1' ? ' checked' : '';
                                            tableHTML += `${spaces}            <td><input type="checkbox"${checked}></td>\n`;
                                            break;
                                        case 'progress':
                                            tableHTML += `${spaces}            <td><progress value="${cell}" max="100"></td>\n`;
                                            break;
                                        case 'button':
                                            // 支持按钮文本格式: "文本:值" 或纯文本
                                            let buttonText = cell;
                                            let buttonValue = cell;
                                            if (cell.includes(':')) {
                                                const parts = cell.split(':');
                                                buttonText = parts[0];
                                                buttonValue = parts[1];
                                            }
                                            tableHTML += `${spaces}            <td><button value="${buttonValue}">${buttonText}</button></td>\n`;
                                            break;
                                        case 'imageText':
                                            tableHTML += `${spaces}            <td><img src="${cell}" alt=""> ${cell}</td>\n`;
                                            break;
                                        default:
                                            tableHTML += `${spaces}            <td>${cell}</td>\n`;
                                    }
                                });
                                tableHTML += `${spaces}        </tr>\n`;
                            });
                            tableHTML += `${spaces}    </tbody>\n`;
                            
                            tableHTML += `${spaces}</${tableTag}>`;
                            return tableHTML;

                        default:
                            return `${spaces}<!-- 未知组件: ${component.type} -->`;
                    }
                }

                let html;
                if (this.htmlGenerationStyle === 'html') {
                    html = '<!DOCTYPE html>\n<html>\n<head>\n    <meta charset="UTF-8">\n    <title>libuiBuilder 生成的界面</title>\n</head>\n<body>\n';
                } else {
                    html = '<!DOCTYPE html>\n<ui version="1.0">\n';
                }
                
                if (this.components.length > 0) {
                    this.components.forEach(component => {
                        html += generateComponentHTML(component, 1) + '\n';
                    });
                }
                
                if (this.htmlGenerationStyle === 'html') {
                    html += '</body>\n</html>';
                } else {
                    html += '</ui>';
                }
                return html;
            }

            save() {
                const html = this.generateHTML();
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'libui-design.html';
                a.click();
                URL.revokeObjectURL(url);
            }

            export() {
                const html = this.generateHTML();
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 80%; max-height: 80%; overflow: auto;">
                        <h3>生成的HTML代码</h3>
                        <textarea style="width: 100%; height: 400px; font-family: monospace;">${html}</textarea>
                        <div style="margin-top: 10px;">
                            <button onclick="navigator.clipboard.writeText(document.querySelector('textarea').value).then(() => alert('已复制到剪贴板'))">复制</button>
                            <button onclick="this.closest('div[style]').remove()">关闭</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            preview() {
                const html = this.generateHTML();
                const newWindow = window.open();
                newWindow.document.write(html);
                newWindow.document.close();
            }
            
            // 获取属于指定标签页的子组件
            getChildrenForTabPage(tabComponent, tabIndex) {
                if (!tabComponent.children || tabComponent.children.length === 0) {
                    return [];
                }
                
                return tabComponent.children.filter(child => {
                    // 检查子组件是否有tabIndex属性
                    const childTabIndex = parseInt(child.props.tabIndex || '0');
                    return childTabIndex === tabIndex;
                });
            }
        }

        // 全局函数
        function toggleCodePreview() {
            const panel = document.querySelector('.code-preview');
            const floatingBtn = document.getElementById('floatingToggleBtn');
            const toggleBtn = document.getElementById('toggleCodeBtn');
            const expandBtn = document.getElementById('expandCodeBtn');
            
            if (panel.classList.contains('collapsed')) {
                // 当前是收起状态，展开
                panel.classList.remove('collapsed');
                panel.style.display = 'block'; // 显示整个footer
                floatingBtn.style.display = 'none'; // 隐藏浮动按钮
                floatingBtn.innerHTML = '&lt;/&gt;'; // 保持图标不变
                toggleBtn.style.display = 'inline-block';
                expandBtn.style.display = 'none';
            } else {
                // 当前是展开状态，收起
                panel.classList.add('collapsed');
                panel.style.display = 'none'; // 隐藏整个footer
                floatingBtn.style.display = 'flex'; // 显示浮动按钮
                floatingBtn.innerHTML = '&lt;/&gt;'; // 保持图标不变
                toggleBtn.style.display = 'none';
                expandBtn.style.display = 'inline-block';
            }
        }

        // 初始化设计器
        document.addEventListener('DOMContentLoaded', () => {
            const designer = new SimpleLibuiDesigner();
            window.designer = designer;
            
            // 初始化代码预览状态
            const panel = document.querySelector('.code-preview');
            const floatingBtn = document.getElementById('floatingToggleBtn');
            const toggleBtn = document.getElementById('toggleCodeBtn');
            const expandBtn = document.getElementById('expandCodeBtn');
            const styleSelect = document.getElementById('htmlStyleSelect');
            
            // 确保初始状态是展开的
            panel.classList.remove('collapsed');
            panel.style.display = 'block'; // 显示整个footer
            floatingBtn.style.display = 'none'; // 隐藏浮动按钮
            floatingBtn.innerHTML = '&lt;/&gt;'; // 保持图标不变
            toggleBtn.style.display = 'inline-block';
            expandBtn.style.display = 'none';
            
            // 设置HTML生成风格选择器的默认值
            if (styleSelect) {
                styleSelect.value = designer.htmlGenerationStyle;
            }
            
            // 绑定代码预览相关事件
            document.getElementById('copyCodeBtn').addEventListener('click', () => {
                const htmlCode = document.getElementById('htmlCode').textContent;
                navigator.clipboard.writeText(htmlCode).then(() => {
                    alert('代码已复制到剪贴板');
                });
            });
            
            document.getElementById('toggleCodeBtn').addEventListener('click', toggleCodePreview);
            document.getElementById('expandCodeBtn').addEventListener('click', toggleCodePreview);
            
            // 自动更新代码预览 - 使用更长的间隔减少性能影响
            setInterval(() => {
                // 只有在用户没有主动操作时才自动更新
                if (!designer.updatingProperties) {
                    designer.updateCodePreview();
                }
            }, 1000); // 增加到1秒间隔
        });
        
        // 辅助方法：为Grid容器中的组件计算下一个可用位置
        function calculateNextGridPosition(containerComponent) {
            if (containerComponent.type !== 'grid') {
                return { row: 0, col: 0 };
            }
            
            // 获取当前Grid容器中已有的组件
            const children = containerComponent.children || [];
            
            if (children.length === 0) {
                return { row: 0, col: 0 }; // 第一个组件放在(0,0)
            }
            
            // 简单策略：找到最小的空闲位置
            // 创建一个二维数组来标记占用位置
            const gridSize = 10; // 假设最大10x10网格
            const occupied = Array(gridSize).fill().map(() => Array(gridSize).fill(false));
            
            // 标记已占用的位置
            for (const child of children) {
                const row = parseInt(child.props.row || '0');
                const col = parseInt(child.props.col || '0');
                const rowspan = parseInt(child.props.rowspan || '1');
                const colspan = parseInt(child.props.colspan || '1');
                
                // 标记组件占用的所有单元格
                for (let r = row; r < row + rowspan && r < gridSize; r++) {
                    for (let c = col; c < col + colspan && c < gridSize; c++) {
                        occupied[r][c] = true;
                    }
                }
            }
            
            // 找到第一个空闲位置
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    if (!occupied[row][col]) {
                        return { row, col };
                    }
                }
            }
            
            // 如果没有找到空闲位置，返回默认位置
            return { row: 0, col: children.length };
        }
    </script>
</body>
</html>