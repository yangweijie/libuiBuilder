<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试设计器修复</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #333;
            margin-top: 0;
        }
        .test-button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background: #005a9e;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>设计器修复测试</h1>
    
    <div class="test-container">
        <h2 class="test-title">测试1: 打开设计器</h2>
        <button class="test-button" onclick="openDesigner()">打开设计器</button>
        <div id="result1" class="test-result"></div>
    </div>
    
    <div class="test-container">
        <h2 class="test-title">测试2: 创建测试组件</h2>
        <button class="test-button" onclick="createTestComponents()">创建Window + HBox + Input</button>
        <div id="result2" class="test-result"></div>
    </div>
    
    <div class="test-container">
        <h2 class="test-title">测试3: 修改Window属性</h2>
        <button class="test-button" onclick="changeWindowMargin()">切换边距属性</button>
        <button class="test-button" onclick="changeWindowSize()">修改尺寸</button>
        <div id="result3" class="test-result"></div>
    </div>
    
    <div class="test-container">
        <h2 class="test-title">测试4: 切换操作系统</h2>
        <button class="test-button" onclick="switchToWindows()">切换到Windows</button>
        <button class="test-button" onclick="switchToMacOS()">切换到macOS</button>
        <button class="test-button" onclick="switchToLinux()">切换到Linux</button>
        <div id="result4" class="test-result"></div>
    </div>
    
    <div class="test-container">
        <h2 class="test-title">测试日志</h2>
        <div id="testLog" class="log"></div>
    </div>
    
    <script>
        let designer = null;
        let testWindow = null;
        let testHBox = null;
        let testInput = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            element.style.display = 'block';
        }
        
        function openDesigner() {
            log('打开设计器...');
            try {
                // 加载设计器脚本
                const script = document.createElement('script');
                script.src = 'tools/designer.js';
                script.onload = function() {
                    log('设计器脚本加载成功');
                    // 等待DOM加载完成
                    setTimeout(() => {
                        designer = window.designer || new LibuiBuilderDesigner();
                        showResult('result1', '✅ 设计器加载成功', true);
                        log('设计器实例已创建');
                    }, 100);
                };
                script.onerror = function() {
                    showResult('result1', '❌ 无法加载设计器脚本', false);
                    log('错误: 无法加载tools/designer.js');
                };
                document.head.appendChild(script);
            } catch (error) {
                showResult('result1', '❌ 错误: ' + error.message, false);
                log('错误: ' + error.message);
            }
        }
        
        function createTestComponents() {
            if (!designer) {
                showResult('result2', '❌ 请先打开设计器', false);
                return;
            }
            
            log('创建测试组件...');
            
            try {
                // 创建Window
                testWindow = {
                    id: 'test_window_1',
                    type: 'window',
                    x: 100,
                    y: 100,
                    props: {
                        title: '测试窗口',
                        size: '400,300',
                        centered: 'true',
                        margined: 'true'
                    },
                    children: [],
                    parent: null
                };
                
                // 创建HBox
                testHBox = {
                    id: 'test_hbox_1',
                    type: 'hbox',
                    x: 0,
                    y: 0,
                    props: {
                        padded: 'true'
                    },
                    children: [],
                    parent: testWindow.id
                };
                
                // 创建Input
                testInput = {
                    id: 'test_input_1',
                    type: 'input',
                    x: 0,
                    y: 0,
                    props: {
                        placeholder: '测试输入框',
                        stretchy: 'horizontal'
                    },
                    children: [],
                    parent: testHBox.id
                };
                
                // 添加到设计器
                designer.components = [testWindow];
                testWindow.children = [testHBox];
                testHBox.children = [testInput];
                
                // 渲染组件
                designer.renderComponent(testWindow);
                
                log(`创建了: Window(${testWindow.id}) -> HBox(${testHBox.id}) -> Input(${testInput.id})`);
                
                // 检查组件是否可见
                setTimeout(() => {
                    const inputElement = document.querySelector(`[data-component-id="${testInput.id}"]`);
                    if (inputElement && inputElement.offsetHeight > 0) {
                        showResult('result2', '✅ 测试组件创建成功且可见', true);
                        log('Input组件高度: ' + inputElement.offsetHeight + 'px');
                    } else {
                        showResult('result2', '⚠️ 组件创建但可能不可见', false);
                        log('警告: Input组件可能高度为0');
                    }
                }, 500);
                
            } catch (error) {
                showResult('result2', '❌ 错误: ' + error.message, false);
                log('错误: ' + error.message);
            }
        }
        
        function changeWindowMargin() {
            if (!testWindow) {
                showResult('result3', '❌ 请先创建测试组件', false);
                return;
            }
            
            log('修改Window边距属性...');
            
            try {
                // 切换边距属性
                const newMargin = testWindow.props.margined === 'true' ? 'false' : 'true';
                testWindow.props.margined = newMargin;
                
                // 刷新组件
                designer.refreshComponent(testWindow);
                
                log(`边距从 ${testWindow.props.margined === 'true' ? 'false' : 'true'} 改为 ${newMargin}`);
                
                // 检查子组件是否仍然可见
                setTimeout(() => {
                    const inputElement = document.querySelector(`[data-component-id="${testInput.id}"]`);
                    if (inputElement && inputElement.offsetHeight > 0) {
                        showResult('result3', `✅ 边距修改为${newMargin}，子组件仍然可见`, true);
                        log('修改边距后Input组件高度: ' + inputElement.offsetHeight + 'px');
                    } else {
                        showResult('result3', `❌ 边距修改后子组件消失`, false);
                        log('错误: 修改边距后Input组件高度为0');
                    }
                }, 500);
                
            } catch (error) {
                showResult('result3', '❌ 错误: ' + error.message, false);
                log('错误: ' + error.message);
            }
        }
        
        function changeWindowSize() {
            if (!testWindow) {
                showResult('result3', '❌ 请先创建测试组件', false);
                return;
            }
            
            log('修改Window尺寸...');
            
            try {
                // 修改尺寸
                testWindow.props.size = '500,400';
                
                // 刷新组件
                designer.refreshComponent(testWindow);
                
                log(`尺寸修改为: ${testWindow.props.size}`);
                
                // 检查子组件是否仍然可见
                setTimeout(() => {
                    const inputElement = document.querySelector(`[data-component-id="${testInput.id}"]`);
                    if (inputElement && inputElement.offsetHeight > 0) {
                        showResult('result3', '✅ 尺寸修改，子组件仍然可见', true);
                    } else {
                        showResult('result3', '❌ 尺寸修改后子组件消失', false);
                    }
                }, 500);
                
            } catch (error) {
                showResult('result3', '❌ 错误: ' + error.message, false);
                log('错误: ' + error.message);
            }
        }
        
        function switchToWindows() {
            switchPlatform('windows');
        }
        
        function switchToMacOS() {
            switchPlatform('macos');
        }
        
        function switchToLinux() {
            switchPlatform('linux');
        }
        
        function switchPlatform(platform) {
            if (!designer) {
                showResult('result4', '❌ 请先打开设计器', false);
                return;
            }
            
            log(`切换到${platform}平台...`);
            
            try {
                // 更新平台
                designer.platform = platform;
                document.body.className = platform;
                
                // 更新组件样式
                designer.updateComponentStyles();
                
                log(`平台已切换到: ${platform}`);
                
                // 检查子组件是否仍然可见
                setTimeout(() => {
                    const inputElement = document.querySelector(`[data-component-id="${testInput.id}"]`);
                    if (inputElement && inputElement.offsetHeight > 0) {
                        showResult('result4', `✅ 切换到${platform}，子组件仍然可见`, true);
                        log(`切换到${platform}后Input组件高度: ` + inputElement.offsetHeight + 'px');
                    } else {
                        showResult('result4', `❌ 切换到${platform}后子组件消失`, false);
                        log(`错误: 切换到${platform}后Input组件高度为0`);
                    }
                }, 500);
                
            } catch (error) {
                showResult('result4', '❌ 错误: ' + error.message, false);
                log('错误: ' + error.message);
            }
        }
        
        log('测试页面已加载');
    </script>
</body>
</html>